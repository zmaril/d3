<!DOCTYPE html>
<html><head><title>zmaril/d3 Â» d3.v2.js

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="index.html"></a><h1>d3.v2.js</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">)</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">try</span> <span class="p">{</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">d3_style_prototype</span> <span class="o">=</span> <span class="nx">CSSStyleDeclaration</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span>
      <span class="nx">d3_style_setProperty</span> <span class="o">=</span> <span class="nx">d3_style_prototype</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">;</span>
  <span class="nx">d3_style_prototype</span><span class="p">.</span><span class="nx">setProperty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_style_setProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">priority</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span> <span class="o">=</span> <span class="p">{</span><span class="nx">version</span><span class="o">:</span> <span class="s2">&quot;2.9.2&quot;</span><span class="p">};</span> <span class="c1">// semver</span>
<span class="kd">function</span> <span class="nx">d3_class</span><span class="p">(</span><span class="nx">ctor</span><span class="p">,</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">properties</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">value</span><span class="o">:</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
        <span class="nx">enumerable</span><span class="o">:</span> <span class="kc">false</span>
      <span class="p">});</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ctor</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">properties</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">d3_array</span> <span class="o">=</span> <span class="nx">d3_arraySlice</span><span class="p">;</span> <span class="c1">// conversion for NodeLists</span>

<span class="kd">function</span> <span class="nx">d3_arrayCopy</span><span class="p">(</span><span class="nx">pseudoarray</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">pseudoarray</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">array</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">array</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pseudoarray</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_arraySlice</span><span class="p">(</span><span class="nx">pseudoarray</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">pseudoarray</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">try</span> <span class="p">{</span>
  <span class="nx">d3_array</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">nodeType</span><span class="p">;</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_array</span> <span class="o">=</span> <span class="nx">d3_arrayCopy</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_arraySubclass</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">__proto__</span><span class="o">?</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Until ECMAScript supports array subclassing, prototype injection works well.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">array</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">;</span>
<span class="p">}</span><span class="o">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>And if your browser doesn't support <strong>proto</strong>, we'll use direct extension.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">prototype</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">property</span> <span class="k">in</span> <span class="nx">prototype</span><span class="p">)</span> <span class="nx">array</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prototype</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">object</span><span class="p">)</span> <span class="nx">map</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">object</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">map</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_Map</span><span class="p">()</span> <span class="p">{}</span>

<span class="nx">d3_class</span><span class="p">(</span><span class="nx">d3_Map</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">has</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_map_prefix</span> <span class="o">+</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">d3_map_prefix</span> <span class="o">+</span> <span class="nx">key</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">[</span><span class="nx">d3_map_prefix</span> <span class="o">+</span> <span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">remove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">d3_map_prefix</span> <span class="o">+</span> <span class="nx">key</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span> <span class="o">&amp;&amp;</span> <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">];</span>
  <span class="p">},</span>
  <span class="nx">keys</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">values</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">entries</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">value</span><span class="p">});</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">entries</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">forEach</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="k">this</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="nx">d3_map_prefixCode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">key</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="k">this</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">d3_map_prefix</span> <span class="o">=</span> <span class="s2">&quot;\0&quot;</span><span class="p">,</span> <span class="c1">// prevent collision with built-ins</span>
    <span class="nx">d3_map_prefixCode</span> <span class="o">=</span> <span class="nx">d3_map_prefix</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="kd">function</span> <span class="nx">d3_identity</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_this</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_true</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">v</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">v</span><span class="p">;</span> <span class="p">};</span>
<span class="p">}</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">functor</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Copies a variable number of methods from source to target.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">method</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">target</span><span class="p">[</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">d3_rebind</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">source</span><span class="p">[</span><span class="nx">method</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Method is assumed to be a standard D3 getter-setter:
If passed with no arguments, gets the value.
If passed with arguments, sets the value and returns the target.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_rebind</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">method</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">target</span> <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">a</span> <span class="o">&gt;=</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="kc">NaN</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">descending</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">b</span> <span class="o">&lt;</span> <span class="nx">a</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">b</span> <span class="o">&gt;</span> <span class="nx">a</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">b</span> <span class="o">&gt;=</span> <span class="nx">a</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="kc">NaN</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">mean</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d3_number</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="nx">m</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">m</span><span class="p">)</span> <span class="o">/</span> <span class="o">++</span><span class="nx">j</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d3_number</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">)))</span> <span class="nx">m</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">m</span><span class="p">)</span> <span class="o">/</span> <span class="o">++</span><span class="nx">j</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">j</span> <span class="o">?</span> <span class="nx">m</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">median</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">array</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
  <span class="nx">array</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">d3_number</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">quantile</span><span class="p">(</span><span class="nx">array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">),</span> <span class="p">.</span><span class="mi">5</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">min</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">b</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">max</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">b</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">&gt;</span> <span class="nx">a</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">extent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">b</span><span class="p">,</span>
      <span class="nx">c</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">a</span><span class="p">))</span> <span class="nx">a</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">((</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">)</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">c</span><span class="p">];</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">random</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">normal</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mean</span><span class="p">,</span> <span class="nx">deviation</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">deviation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">mean</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">r</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">r</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">r</span> <span class="o">||</span> <span class="nx">r</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">mean</span> <span class="o">+</span> <span class="nx">deviation</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="o">/</span> <span class="nx">r</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_number</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="nx">s</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">)))</span> <span class="nx">s</span> <span class="o">+=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">s</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>R-7 per <a href="http://en.wikipedia.org/wiki/Quantile">http://en.wikipedia.org/wiki/Quantile</a></p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">quantile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">H</span> <span class="o">=</span> <span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">H</span><span class="p">),</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">H</span> <span class="o">-</span> <span class="nx">h</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">e</span> <span class="o">?</span> <span class="nx">v</span> <span class="o">+</span> <span class="nx">e</span> <span class="o">*</span> <span class="p">(</span><span class="nx">values</span><span class="p">[</span><span class="nx">h</span><span class="p">]</span> <span class="o">-</span> <span class="nx">v</span><span class="p">)</span> <span class="o">:</span> <span class="nx">v</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">transpose</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">matrix</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">zip</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">d3</span><span class="p">,</span> <span class="nx">matrix</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">zip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="k">return</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="nx">d3_zipLength</span><span class="p">),</span> <span class="nx">zips</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">m</span><span class="p">);</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">zip</span> <span class="o">=</span> <span class="nx">zips</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="nx">zip</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">zips</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_zipLength</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">bisector</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">left</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">lo</span><span class="p">,</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">hi</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">lo</span> <span class="o">&lt;</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mid</span> <span class="o">=</span> <span class="nx">lo</span> <span class="o">+</span> <span class="nx">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">mid</span><span class="p">],</span> <span class="nx">mid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">)</span> <span class="nx">lo</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">hi</span> <span class="o">=</span> <span class="nx">mid</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">lo</span><span class="p">;</span>
    <span class="p">},</span>
    <span class="nx">right</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">lo</span><span class="p">,</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">lo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="nx">hi</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">lo</span> <span class="o">&lt;</span> <span class="nx">hi</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">mid</span> <span class="o">=</span> <span class="nx">lo</span> <span class="o">+</span> <span class="nx">hi</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">mid</span><span class="p">],</span> <span class="nx">mid</span><span class="p">))</span> <span class="nx">hi</span> <span class="o">=</span> <span class="nx">mid</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">lo</span> <span class="o">=</span> <span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">lo</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_bisector</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">bisector</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">;</span> <span class="p">});</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">bisectLeft</span> <span class="o">=</span> <span class="nx">d3_bisector</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">bisect</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">bisectRight</span> <span class="o">=</span> <span class="nx">d3_bisector</span><span class="p">.</span><span class="nx">right</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">first</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">b</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">last</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">b</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">nest</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">nest</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">keys</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">sortKeys</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">sortValues</span><span class="p">,</span>
      <span class="nx">rollup</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">map</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&gt;=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">rollup</span>
        <span class="o">?</span> <span class="nx">rollup</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">nest</span><span class="p">,</span> <span class="nx">array</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">sortValues</span>
        <span class="o">?</span> <span class="nx">array</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sortValues</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">array</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">key</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">depth</span><span class="o">++</span><span class="p">],</span>
        <span class="nx">keyValue</span><span class="p">,</span>
        <span class="nx">object</span><span class="p">,</span>
        <span class="nx">valuesByKey</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">,</span>
        <span class="nx">values</span><span class="p">,</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">values</span> <span class="o">=</span> <span class="nx">valuesByKey</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">key</span><span class="p">(</span><span class="nx">object</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">])))</span> <span class="p">{</span>
        <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">object</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">valuesByKey</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">,</span> <span class="p">[</span><span class="nx">object</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">valuesByKey</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">o</span><span class="p">[</span><span class="nx">keyValue</span><span class="p">]</span> <span class="o">=</span> <span class="nx">map</span><span class="p">(</span><span class="nx">valuesByKey</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">),</span> <span class="nx">depth</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">entries</span><span class="p">(</span><span class="nx">map</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&gt;=</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">map</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">sortKey</span> <span class="o">=</span> <span class="nx">sortKeys</span><span class="p">[</span><span class="nx">depth</span><span class="o">++</span><span class="p">],</span>
        <span class="nx">key</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">values</span><span class="o">:</span> <span class="nx">entries</span><span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">depth</span><span class="p">)});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sortKey</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">sortKey</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">nest</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">map</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">nest</span><span class="p">.</span><span class="nx">entries</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">entries</span><span class="p">(</span><span class="nx">map</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">nest</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">nest</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Specifies the order for the most-recently specified key.
Note: only applies to entries. Map keys are unordered!</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">nest</span><span class="p">.</span><span class="nx">sortKeys</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sortKeys</span><span class="p">[</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">order</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">nest</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Specifies the order for leaf values.
Applies to both maps and entries array.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">nest</span><span class="p">.</span><span class="nx">sortValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">order</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sortValues</span> <span class="o">=</span> <span class="nx">order</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">nest</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">nest</span><span class="p">.</span><span class="nx">rollup</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">rollup</span> <span class="o">=</span> <span class="nx">f</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">nest</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">nest</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span><span class="p">)</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">keys</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span><span class="p">)</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">map</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">entries</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">map</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">entries</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">map</span><span class="p">)</span> <span class="nx">entries</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">map</span><span class="p">[</span><span class="nx">key</span><span class="p">]});</span>
  <span class="k">return</span> <span class="nx">entries</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">permute</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">indexes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">permutes</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">indexes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">permutes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">indexes</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
  <span class="k">return</span> <span class="nx">permutes</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">merge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arrays</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">([],</span> <span class="nx">arrays</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">split</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">array</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">arrays</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">value</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">d3_splitter</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">values</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">arrays</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span>
      <span class="nx">values</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">arrays</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_splitter</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span> <span class="o">==</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_collapse</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(^\s+)|(\s+$)/g</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/g</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">,</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stop</span> <span class="o">=</span> <span class="nx">start</span><span class="p">;</span>
      <span class="nx">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">((</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="nx">step</span> <span class="o">===</span> <span class="kc">Infinity</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;infinite range&quot;</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="p">[],</span>
       <span class="nx">k</span> <span class="o">=</span> <span class="nx">d3_range_integerScale</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">step</span><span class="p">)),</span>
       <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
       <span class="nx">j</span><span class="p">;</span>
  <span class="nx">start</span> <span class="o">*=</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">stop</span> <span class="o">*=</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">step</span> <span class="o">*=</span> <span class="nx">k</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">while</span> <span class="p">((</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">stop</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span> <span class="o">/</span> <span class="nx">k</span><span class="p">);</span>
  <span class="k">else</span> <span class="k">while</span> <span class="p">((</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">stop</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span> <span class="o">/</span> <span class="nx">k</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_range_integerScale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">k</span> <span class="o">%</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">k</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">k</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">requote</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">d3_requote_re</span><span class="p">,</span> <span class="s2">&quot;\\$&amp;&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_requote_re</span> <span class="o">=</span> <span class="sr">/[\\\^\$\*\+\?\|\[\]\(\)\.\{\}]/g</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">round</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">n</span>
      <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">n</span><span class="p">)))</span> <span class="o">/</span> <span class="nx">n</span>
      <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">req</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">callback</span> <span class="o">=</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">mime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">mime</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">overrideMimeType</span><span class="p">(</span><span class="nx">mime</span><span class="p">);</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">mime</span><span class="p">)</span> <span class="nx">req</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Accept&quot;</span><span class="p">,</span> <span class="nx">mime</span><span class="p">);</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">status</span><span class="p">;</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">s</span> <span class="o">&gt;=</span> <span class="mi">200</span> <span class="o">&amp;&amp;</span> <span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">300</span> <span class="o">||</span> <span class="nx">s</span> <span class="o">===</span> <span class="mi">304</span> <span class="o">?</span> <span class="nx">req</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>
  <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">ready</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">req</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">mime</span><span class="p">;</span>
    <span class="nx">mime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">xhr</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">ready</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">json</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">text</span> <span class="o">?</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s2">&quot;text/html&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Treat empty string as valid HTML.</span>
      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createRange</span><span class="p">();</span>
      <span class="nx">range</span><span class="p">.</span><span class="nx">selectNode</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">);</span>
      <span class="nx">text</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">createContextualFragment</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">xml</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">ready</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">req</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">responseXML</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span> <span class="o">=</span> <span class="nx">mime</span><span class="p">;</span>
    <span class="nx">mime</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">xhr</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">mime</span><span class="p">,</span> <span class="nx">ready</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">d3_nsPrefix</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">svg</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/2000/svg&quot;</span><span class="p">,</span>
  <span class="nx">xhtml</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">,</span>
  <span class="nx">xlink</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/1999/xlink&quot;</span><span class="p">,</span>
  <span class="nx">xml</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/XML/1998/namespace&quot;</span><span class="p">,</span>
  <span class="nx">xmlns</span><span class="o">:</span> <span class="s2">&quot;http://www.w3.org/2000/xmlns/&quot;</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">prefix</span><span class="o">:</span> <span class="nx">d3_nsPrefix</span><span class="p">,</span>
  <span class="nx">qualify</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">),</span>
        <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">d3_nsPrefix</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">prefix</span><span class="p">)</span>
        <span class="o">?</span> <span class="p">{</span><span class="nx">space</span><span class="o">:</span> <span class="nx">d3_nsPrefix</span><span class="p">[</span><span class="nx">prefix</span><span class="p">],</span> <span class="nx">local</span><span class="o">:</span> <span class="nx">name</span><span class="p">}</span>
        <span class="o">:</span> <span class="nx">name</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">dispatch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dispatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_dispatch</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">dispatch</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">d3_dispatch_event</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">dispatch</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_dispatch</span><span class="p">()</span> <span class="p">{}</span>

<span class="nx">d3_dispatch</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
      <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Extract optional namespace, e.g., "click.foo"</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span>
      <span class="o">?</span> <span class="k">this</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">on</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
      <span class="o">:</span> <span class="k">this</span><span class="p">[</span><span class="nx">type</span><span class="p">].</span><span class="nx">on</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_dispatch_event</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">listeners</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">listenerByName</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">event</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">,</span> <span class="c1">// defensive reference</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">l</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">on</span><span class="p">)</span> <span class="nx">l</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">dispatch</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">event</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">listenerByName</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span>
        <span class="nx">i</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>return the current listener, if any</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="nx">l</span><span class="p">.</span><span class="nx">on</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>remove the old listener, if any (with copy-on-write)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">l</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">listeners</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">l</span><span class="p">)).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
      <span class="nx">listenerByName</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>add the new listener, if any</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">listener</span><span class="p">)</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">listenerByName</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span><span class="nx">on</span><span class="o">:</span> <span class="nx">listener</span><span class="p">}));</span>

    <span class="k">return</span> <span class="nx">dispatch</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">event</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>TODO align</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">specifier</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="nx">d3_format_re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">specifier</span><span class="p">),</span>
      <span class="nx">fill</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
      <span class="nx">sign</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="nx">zfill</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
      <span class="nx">width</span> <span class="o">=</span> <span class="o">+</span><span class="nx">match</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
      <span class="nx">comma</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
      <span class="nx">precision</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
      <span class="nx">type</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="nx">integer</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">precision</span><span class="p">)</span> <span class="nx">precision</span> <span class="o">=</span> <span class="o">+</span><span class="nx">precision</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">zfill</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fill</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="p">;</span> <span class="c1">// TODO align = &quot;=&quot;;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">comma</span><span class="p">)</span> <span class="nx">width</span> <span class="o">-=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s2">&quot;n&quot;</span><span class="o">:</span> <span class="nx">comma</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;g&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&quot;%&quot;</span><span class="o">:</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span><span class="p">;</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;f&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&quot;p&quot;</span><span class="o">:</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">suffix</span> <span class="o">=</span> <span class="s2">&quot;%&quot;</span><span class="p">;</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&quot;d&quot;</span><span class="o">:</span> <span class="nx">integer</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span> <span class="nx">precision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="s2">&quot;s&quot;</span><span class="o">:</span> <span class="nx">scale</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>If no precision is specified for r, fallback to general notation.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;r&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">precision</span><span class="p">)</span> <span class="nx">type</span> <span class="o">=</span> <span class="s2">&quot;g&quot;</span><span class="p">;</span>

  <span class="nx">type</span> <span class="o">=</span> <span class="nx">d3_format_types</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d3_format_typeDefault</span><span class="p">;</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Return the empty string for floats formatted as ints.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">integer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">value</span> <span class="o">%</span> <span class="mi">1</span><span class="p">))</span> <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Convert negative to positive, and record the sign prefix.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">negative</span> <span class="o">=</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="o">-</span><span class="nx">value</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;\u2212&quot;</span> <span class="o">:</span> <span class="nx">sign</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Apply the scale, computing it from the value's exponent for si format.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">scale</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">prefix</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">formatPrefix</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">precision</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">suffix</span> <span class="o">=</span> <span class="nx">prefix</span><span class="p">.</span><span class="nx">symbol</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">value</span> <span class="o">*=</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Convert to the desired precision.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">value</span> <span class="o">=</span> <span class="nx">type</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">precision</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>If the fill character is 0, the sign and group is applied after the fill.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">zfill</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">negative</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">comma</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">d3_format_group</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">negative</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Otherwise (e.g., space-filling), the sign and group is applied before.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">comma</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">d3_format_group</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">negative</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="nx">width</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">width</span> <span class="o">-</span> <span class="nx">length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="nx">fill</span><span class="p">)</span> <span class="o">+</span> <span class="nx">value</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">value</span> <span class="o">+</span> <span class="nx">suffix</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>[[fill]align][sign][#][0][width][,][.precision][type]</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_format_re</span> <span class="o">=</span> <span class="sr">/(?:([^{])?([&lt;&gt;=^]))?([+\- ])?(#)?(0)?([0-9]+)?(,)?(\.[0-9]+)?([a-zA-Z%])?/</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">d3_format_types</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">g</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toPrecision</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">e</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toExponential</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">f</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">r</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">d3_format_precision</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)).</span><span class="nx">toFixed</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">p</span><span class="p">)));</span> <span class="p">}</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">d3_format_precision</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">p</span> <span class="o">-</span> <span class="p">(</span><span class="nx">x</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p</span><span class="p">))</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">)</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_format_typeDefault</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Apply comma grouping for thousands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_format_group</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">),</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">t</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">var</span> <span class="nx">d3_formatPrefixes</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="s2">&quot;z&quot;</span><span class="p">,</span><span class="s2">&quot;a&quot;</span><span class="p">,</span><span class="s2">&quot;f&quot;</span><span class="p">,</span><span class="s2">&quot;p&quot;</span><span class="p">,</span><span class="s2">&quot;n&quot;</span><span class="p">,</span><span class="s2">&quot;Î¼&quot;</span><span class="p">,</span><span class="s2">&quot;m&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;k&quot;</span><span class="p">,</span><span class="s2">&quot;M&quot;</span><span class="p">,</span><span class="s2">&quot;G&quot;</span><span class="p">,</span><span class="s2">&quot;T&quot;</span><span class="p">,</span><span class="s2">&quot;P&quot;</span><span class="p">,</span><span class="s2">&quot;E&quot;</span><span class="p">,</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span><span class="s2">&quot;Y&quot;</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_formatPrefix</span><span class="p">);</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">formatPrefix</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">precision</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">value</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">precision</span><span class="p">)</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">d3_format_precision</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">precision</span><span class="p">));</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">12</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">);</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">d3_formatPrefixes</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">3</span><span class="p">];</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_formatPrefix</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">scale</span><span class="o">:</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span> <span class="o">/</span> <span class="nx">k</span><span class="p">;</span> <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">symbol</span><span class="o">:</span> <span class="nx">d</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * TERMS OF USE - EASING EQUATIONS</span>
<span class="cm"> *</span>
<span class="cm"> * Open source under the BSD License.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2001 Robert Penner</span>
<span class="cm"> * All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions are met:</span>
<span class="cm"> *</span>
<span class="cm"> * - Redistributions of source code must retain the above copyright notice, this</span>
<span class="cm"> *   list of conditions and the following disclaimer.</span>
<span class="cm"> *</span>
<span class="cm"> * - Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="cm"> *   this list of conditions and the following disclaimer in the documentation</span>
<span class="cm"> *   and/or other materials provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * - Neither the name of the author nor the names of contributors may be used to</span>
<span class="cm"> *   endorse or promote products derived from this software without specific</span>
<span class="cm"> *   prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;</span>
<span class="cm"> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</span>
<span class="cm"> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</span>
<span class="cm"> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</span>
<span class="cm"> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="cm"> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</span>
<span class="cm"> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</span>
<span class="cm"> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm"> * POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">d3_ease_quad</span> <span class="o">=</span> <span class="nx">d3_ease_poly</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
    <span class="nx">d3_ease_cubic</span> <span class="o">=</span> <span class="nx">d3_ease_poly</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="nx">d3_ease_default</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_identity</span><span class="p">;</span> <span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_ease</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">linear</span><span class="o">:</span> <span class="nx">d3_ease_default</span><span class="p">,</span>
  <span class="nx">poly</span><span class="o">:</span> <span class="nx">d3_ease_poly</span><span class="p">,</span>
  <span class="nx">quad</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_quad</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">cubic</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_cubic</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">sin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_sin</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">exp</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_exp</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">circle</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_circle</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">elastic</span><span class="o">:</span> <span class="nx">d3_ease_elastic</span><span class="p">,</span>
  <span class="nx">back</span><span class="o">:</span> <span class="nx">d3_ease_back</span><span class="p">,</span>
  <span class="nx">bounce</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_bounce</span><span class="p">;</span> <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">d3_ease_mode</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="s2">&quot;in&quot;</span><span class="o">:</span> <span class="nx">d3_ease_identity</span><span class="p">,</span>
  <span class="s2">&quot;out&quot;</span><span class="o">:</span> <span class="nx">d3_ease_reverse</span><span class="p">,</span>
  <span class="s2">&quot;in-out&quot;</span><span class="o">:</span> <span class="nx">d3_ease_reflect</span><span class="p">,</span>
  <span class="s2">&quot;out-in&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_ease_reflect</span><span class="p">(</span><span class="nx">d3_ease_reverse</span><span class="p">(</span><span class="nx">f</span><span class="p">));</span> <span class="p">}</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">ease</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">),</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">:</span> <span class="nx">name</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">name</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;in&quot;</span><span class="p">;</span>
  <span class="nx">t</span> <span class="o">=</span> <span class="nx">d3_ease</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d3_ease_default</span><span class="p">;</span>
  <span class="nx">m</span> <span class="o">=</span> <span class="nx">d3_ease_mode</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d3_ease_identity</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">d3_ease_clamp</span><span class="p">(</span><span class="nx">m</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="mi">1</span><span class="p">))));</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_ease_clamp</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">t</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_reverse</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">f</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_reflect</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">5</span> <span class="o">?</span> <span class="nx">f</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">t</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">f</span><span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">t</span><span class="p">)));</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_identity</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_poly</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_sin</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_exp</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_circle</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_elastic</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">s</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">p</span> <span class="o">=</span> <span class="mf">0.45</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">else</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nx">a</span><span class="p">);</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">a</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="o">-</span><span class="nx">t</span><span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">((</span><span class="nx">t</span> <span class="o">-</span> <span class="nx">s</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="nx">p</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_back</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">s</span><span class="p">)</span> <span class="nx">s</span> <span class="o">=</span> <span class="mf">1.70158</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="p">((</span><span class="nx">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">-</span> <span class="nx">s</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_ease_bounce</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="mf">2.75</span> <span class="o">?</span> <span class="mf">7.5625</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">t</span>
      <span class="o">:</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">/</span> <span class="mf">2.75</span> <span class="o">?</span> <span class="mf">7.5625</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">-=</span> <span class="mf">1.5</span> <span class="o">/</span> <span class="mf">2.75</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="p">.</span><span class="mi">75</span>
      <span class="o">:</span> <span class="nx">t</span> <span class="o">&lt;</span> <span class="mf">2.5</span> <span class="o">/</span> <span class="mf">2.75</span> <span class="o">?</span> <span class="mf">7.5625</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">-=</span> <span class="mf">2.25</span> <span class="o">/</span> <span class="mf">2.75</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="p">.</span><span class="mi">9375</span>
      <span class="o">:</span> <span class="mf">7.5625</span> <span class="o">*</span> <span class="p">(</span><span class="nx">t</span> <span class="o">-=</span> <span class="mf">2.625</span> <span class="o">/</span> <span class="mf">2.75</span><span class="p">)</span> <span class="o">*</span> <span class="nx">t</span> <span class="o">+</span> <span class="p">.</span><span class="mi">984375</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_eventCancel</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_eventSource</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">,</span> <span class="nx">s</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">s</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">sourceEvent</span><span class="p">)</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">e</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Like d3.dispatch, but for custom events abstracting native UI events. These
events have a target component (such as a brush), a target element (such as
the svg:g element containing the brush) and the standard arguments <code>d</code> (the
target element's data) and <code>i</code> (the selection index of the target element).</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_eventDispatch</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dispatch</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_dispatch</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">dispatch</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">d3_dispatch_event</span><span class="p">(</span><span class="nx">dispatch</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Creates a dispatch context for the specified <code>thiz</code> (typically, the target
DOM element that received the source event) and <code>argumentz</code> (typically, the
data <code>d</code> and index <code>i</code> of the target element). The returned function can be
used to dispatch an event to any registered listeners; the function takes a
single argument as input, being the event to dispatch. The event must have
a "type" attribute which corresponds to a type registered in the
constructor. This context will automatically populate the "sourceEvent" and
"target" attributes of the event, as well as setting the <code>d3.event</code> global
for the duration of the notification.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">dispatch</span><span class="p">.</span><span class="nx">of</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">thiz</span><span class="p">,</span> <span class="nx">argumentz</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">e0</span> <span class="o">=</span>
        <span class="nx">e1</span><span class="p">.</span><span class="nx">sourceEvent</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
        <span class="nx">e1</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
        <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">e1</span><span class="p">;</span>
        <span class="nx">dispatch</span><span class="p">[</span><span class="nx">e1</span><span class="p">.</span><span class="nx">type</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="nx">thiz</span><span class="p">,</span> <span class="nx">argumentz</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">e0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">dispatch</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolators</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">f</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">f</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolators</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)));</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">-=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">t</span><span class="p">;</span> <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateRound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">-=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">t</span><span class="p">);</span> <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">m</span><span class="p">,</span> <span class="c1">// current match</span>
      <span class="nx">i</span><span class="p">,</span> <span class="c1">// current index</span>
      <span class="nx">j</span><span class="p">,</span> <span class="c1">// current index (for coallescing)</span>
      <span class="nx">s0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// start index of current string prefix</span>
      <span class="nx">s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// end index of current string prefix</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="p">[],</span> <span class="c1">// string constants and placeholders</span>
      <span class="nx">q</span> <span class="o">=</span> <span class="p">[],</span> <span class="c1">// number interpolators</span>
      <span class="nx">n</span><span class="p">,</span> <span class="c1">// q.length</span>
      <span class="nx">o</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Reset our regular expression!</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">d3_interpolate_number</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Find all numbers in b.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">d3_interpolate_number</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span> <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">s0</span><span class="p">,</span> <span class="nx">s1</span> <span class="o">=</span> <span class="nx">m</span><span class="p">.</span><span class="nx">index</span><span class="p">));</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]});</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="nx">s0</span> <span class="o">=</span> <span class="nx">d3_interpolate_number</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">s0</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">s0</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Find all numbers in a.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">d3_interpolate_number</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nx">q</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">==</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// The numbers match, so coallesce.</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// This match is followed by another number.</span>
          <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
          <span class="nx">s</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">q</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">i</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// This match is followed by a string, so coallesce twice.</span>
          <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
          <span class="nx">s</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">q</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// This match is followed by another number.</span>
          <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// This match is followed by a string, so coallesce twice.</span>
          <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
          <span class="nx">s</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">q</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">i</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">q</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="nx">n</span><span class="o">--</span><span class="p">;</span>
      <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Remove any numbers in b not found in a.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// This match is followed by another number.</span>
      <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// This match is followed by a string, so coallesce twice.</span>
      <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="nx">s</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">n</span><span class="o">--</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Special optimization for only a single match.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">q</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span> <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">b</span><span class="p">;</span> <span class="p">};</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Otherwise, interpolate each of the numbers and rejoin the string.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">s</span><span class="p">[(</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">q</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateTransform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="p">[],</span> <span class="c1">// string constants and placeholders</span>
      <span class="nx">q</span> <span class="o">=</span> <span class="p">[],</span> <span class="c1">// number interpolators</span>
      <span class="nx">n</span><span class="p">,</span>
      <span class="nx">A</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span>
      <span class="nx">B</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transform</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
      <span class="nx">ta</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">translate</span><span class="p">,</span>
      <span class="nx">tb</span> <span class="o">=</span> <span class="nx">B</span><span class="p">.</span><span class="nx">translate</span><span class="p">,</span>
      <span class="nx">ra</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">rotate</span><span class="p">,</span>
      <span class="nx">rb</span> <span class="o">=</span> <span class="nx">B</span><span class="p">.</span><span class="nx">rotate</span><span class="p">,</span>
      <span class="nx">wa</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">skew</span><span class="p">,</span>
      <span class="nx">wb</span> <span class="o">=</span> <span class="nx">B</span><span class="p">.</span><span class="nx">skew</span><span class="p">,</span>
      <span class="nx">ka</span> <span class="o">=</span> <span class="nx">A</span><span class="p">.</span><span class="nx">scale</span><span class="p">,</span>
      <span class="nx">kb</span> <span class="o">=</span> <span class="nx">B</span><span class="p">.</span><span class="nx">scale</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nx">ta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">tb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;translate(&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">ta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">tb</span><span class="p">[</span><span class="mi">0</span><span class="p">])},</span> <span class="p">{</span><span class="nx">i</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">ta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">tb</span><span class="p">[</span><span class="mi">1</span><span class="p">])});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">tb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nx">tb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">tb</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">ra</span> <span class="o">!=</span> <span class="nx">rb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;rotate(&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">ra</span><span class="p">,</span> <span class="nx">rb</span><span class="p">)});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">rb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;rotate(&quot;</span> <span class="o">+</span> <span class="nx">rb</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">wa</span> <span class="o">!=</span> <span class="nx">wb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;skewX(&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">wa</span><span class="p">,</span> <span class="nx">wb</span><span class="p">)});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">wb</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;skewX(&quot;</span> <span class="o">+</span> <span class="nx">wb</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">ka</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">kb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="nx">ka</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">kb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">n</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;scale(&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">i</span><span class="o">:</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">ka</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">kb</span><span class="p">[</span><span class="mi">0</span><span class="p">])},</span> <span class="p">{</span><span class="nx">i</span><span class="o">:</span> <span class="nx">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">ka</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">kb</span><span class="p">[</span><span class="mi">1</span><span class="p">])});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">kb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span> <span class="nx">kb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;scale(&quot;</span> <span class="o">+</span> <span class="nx">kb</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">n</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">o</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">s</span><span class="p">[(</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">q</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateRgb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rgb</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rgb</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">ar</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">ag</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span>
      <span class="nx">ab</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span>
      <span class="nx">br</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">ar</span><span class="p">,</span>
      <span class="nx">bg</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">g</span> <span class="o">-</span> <span class="nx">ag</span><span class="p">,</span>
      <span class="nx">bb</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">ab</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;#&quot;</span>
        <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ar</span> <span class="o">+</span> <span class="nx">br</span> <span class="o">*</span> <span class="nx">t</span><span class="p">))</span>
        <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ag</span> <span class="o">+</span> <span class="nx">bg</span> <span class="o">*</span> <span class="nx">t</span><span class="p">))</span>
        <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ab</span> <span class="o">+</span> <span class="nx">bb</span> <span class="o">*</span> <span class="nx">t</span><span class="p">));</span>
  <span class="p">};</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>interpolates HSL space, but outputs RGB string (for compatibility)</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateHsl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">a</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">hsl</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">hsl</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">h0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span>
      <span class="nx">s0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span>
      <span class="nx">l0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">l</span><span class="p">,</span>
      <span class="nx">h1</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">h</span> <span class="o">-</span> <span class="nx">h0</span><span class="p">,</span>
      <span class="nx">s1</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">s</span> <span class="o">-</span> <span class="nx">s0</span><span class="p">,</span>
      <span class="nx">l1</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">l</span> <span class="o">-</span> <span class="nx">l0</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_hsl_rgb</span><span class="p">(</span><span class="nx">h0</span> <span class="o">+</span> <span class="nx">h1</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">s0</span> <span class="o">+</span> <span class="nx">s1</span> <span class="o">*</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">l0</span> <span class="o">+</span> <span class="nx">l1</span> <span class="o">*</span> <span class="nx">t</span><span class="p">).</span><span class="nx">toString</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateArray</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">na</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">nb</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">n0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">),</span>
      <span class="nx">i</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n0</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">x</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">na</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nb</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n0</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">c</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">](</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">k</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_interpolateByName</span><span class="p">(</span><span class="nx">k</span><span class="p">)(</span><span class="nx">a</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span><span class="p">]);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">a</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="nx">k</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="k">in</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">c</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span><span class="p">[</span><span class="nx">k</span><span class="p">](</span><span class="nx">t</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_interpolate_number</span> <span class="o">=</span> <span class="sr">/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_interpolateByName</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">==</span> <span class="s2">&quot;transform&quot;</span>
      <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateTransform</span>
      <span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">interpolators</span> <span class="o">=</span> <span class="p">[</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateObject</span><span class="p">,</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">b</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateArray</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="p">},</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">a</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateString</span><span class="p">(</span><span class="nx">a</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">b</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">);</span> <span class="p">},</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span> <span class="o">?</span> <span class="nx">d3_rgb_names</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">||</span> <span class="sr">/^(#|rgb\(|hsl\()/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="o">:</span> <span class="nx">b</span> <span class="k">instanceof</span> <span class="nx">d3_Rgb</span> <span class="o">||</span> <span class="nx">b</span> <span class="k">instanceof</span> <span class="nx">d3_Hsl</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateRgb</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="p">},</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">b</span> <span class="o">=</span> <span class="o">+</span><span class="nx">b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span> <span class="p">}</span>
<span class="p">];</span>
<span class="kd">function</span> <span class="nx">d3_uninterpolateNumber</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">a</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nx">b</span><span class="p">;</span> <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_uninterpolateClamp</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span> <span class="o">-</span> <span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="nx">a</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nx">b</span><span class="p">));</span> <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">rgb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">r</span> <span class="k">instanceof</span> <span class="nx">d3_Rgb</span> <span class="o">?</span> <span class="nx">d3_rgb</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">d3_rgb_parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">r</span><span class="p">,</span> <span class="nx">d3_rgb</span><span class="p">,</span> <span class="nx">d3_hsl_rgb</span><span class="p">))</span>
      <span class="o">:</span> <span class="nx">d3_rgb</span><span class="p">(</span><span class="o">~~</span><span class="nx">r</span><span class="p">,</span> <span class="o">~~</span><span class="nx">g</span><span class="p">,</span> <span class="o">~~</span><span class="nx">b</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_rgb</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_Rgb</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_Rgb</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">g</span> <span class="o">=</span> <span class="nx">g</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3_Rgb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">brighter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">k</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">g</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">g</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d3_rgb</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">&amp;&amp;</span> <span class="nx">g</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">)</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">d3_rgb</span><span class="p">(</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">r</span> <span class="o">/</span> <span class="nx">k</span><span class="p">)),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">g</span> <span class="o">/</span> <span class="nx">k</span><span class="p">)),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">b</span> <span class="o">/</span> <span class="nx">k</span><span class="p">)));</span>
<span class="p">};</span>

<span class="nx">d3_Rgb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">darker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">k</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">d3_rgb</span><span class="p">(</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">k</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">k</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">),</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">k</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">d3_Rgb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_rgb_hsl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_Rgb</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">r</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">g</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_rgb_hex</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">v</span> <span class="o">&lt;</span> <span class="mh">0x10</span>
      <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">v</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
      <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="nx">v</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_rgb_parse</span><span class="p">(</span><span class="nx">format</span><span class="p">,</span> <span class="nx">rgb</span><span class="p">,</span> <span class="nx">hsl</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// red channel; int in [0, 255]</span>
      <span class="nx">g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// green channel; int in [0, 255]</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// blue channel; int in [0, 255]</span>
      <span class="nx">m1</span><span class="p">,</span> <span class="c1">// CSS color specification match</span>
      <span class="nx">m2</span><span class="p">,</span> <span class="c1">// CSS color specification type (e.g., rgb)</span>
      <span class="nx">name</span><span class="p">;</span>

  <span class="cm">/* Handle hsl, rgb. */</span>
  <span class="nx">m1</span> <span class="o">=</span> <span class="sr">/([a-z]+)\((.*)\)/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">format</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">m1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">m2</span> <span class="o">=</span> <span class="nx">m1</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">m1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;hsl&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">hsl</span><span class="p">(</span>
          <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="c1">// degrees</span>
          <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="c1">// percentage</span>
          <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1">// percentage</span>
        <span class="p">);</span>
      <span class="p">}</span>
      <span class="k">case</span> <span class="s2">&quot;rgb&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">rgb</span><span class="p">(</span>
          <span class="nx">d3_rgb_parseNumber</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">d3_rgb_parseNumber</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
          <span class="nx">d3_rgb_parseNumber</span><span class="p">(</span><span class="nx">m2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="cm">/* Named colors. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">d3_rgb_names</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">format</span><span class="p">))</span> <span class="k">return</span> <span class="nx">rgb</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">g</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>

  <span class="cm">/* Hexadecimal colors: #rgb and #rrggbb. */</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">format</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">format</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;#&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="nx">r</span> <span class="o">+=</span> <span class="nx">r</span><span class="p">;</span>
      <span class="nx">g</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="nx">g</span> <span class="o">+=</span> <span class="nx">g</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="nx">b</span> <span class="o">+=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">r</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
      <span class="nx">g</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">format</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="nx">g</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rgb</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_rgb_hsl</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">r</span> <span class="o">/=</span> <span class="mi">255</span><span class="p">,</span> <span class="nx">g</span> <span class="o">/=</span> <span class="mi">255</span><span class="p">,</span> <span class="nx">b</span> <span class="o">/=</span> <span class="mi">255</span><span class="p">),</span>
      <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">g</span><span class="p">,</span> <span class="nx">b</span><span class="p">),</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">,</span>
      <span class="nx">h</span><span class="p">,</span>
      <span class="nx">s</span><span class="p">,</span>
      <span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">max</span> <span class="o">+</span> <span class="nx">min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">5</span> <span class="o">?</span> <span class="nx">d</span> <span class="o">/</span> <span class="p">(</span><span class="nx">max</span> <span class="o">+</span> <span class="nx">min</span><span class="p">)</span> <span class="o">:</span> <span class="nx">d</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="nx">max</span> <span class="o">-</span> <span class="nx">min</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">==</span> <span class="nx">max</span><span class="p">)</span> <span class="nx">h</span> <span class="o">=</span> <span class="p">(</span><span class="nx">g</span> <span class="o">-</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">+</span> <span class="p">(</span><span class="nx">g</span> <span class="o">&lt;</span> <span class="nx">b</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">g</span> <span class="o">==</span> <span class="nx">max</span><span class="p">)</span> <span class="nx">h</span> <span class="o">=</span> <span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">r</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span> <span class="nx">h</span> <span class="o">=</span> <span class="p">(</span><span class="nx">r</span> <span class="o">-</span> <span class="nx">g</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
    <span class="nx">h</span> <span class="o">*=</span> <span class="mi">60</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_rgb_parseNumber</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// either integer or percentage</span>
  <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;%&quot;</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">f</span> <span class="o">*</span> <span class="mf">2.55</span><span class="p">)</span> <span class="o">:</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_rgb_names</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">aliceblue</span><span class="o">:</span> <span class="s2">&quot;#f0f8ff&quot;</span><span class="p">,</span>
  <span class="nx">antiquewhite</span><span class="o">:</span> <span class="s2">&quot;#faebd7&quot;</span><span class="p">,</span>
  <span class="nx">aqua</span><span class="o">:</span> <span class="s2">&quot;#00ffff&quot;</span><span class="p">,</span>
  <span class="nx">aquamarine</span><span class="o">:</span> <span class="s2">&quot;#7fffd4&quot;</span><span class="p">,</span>
  <span class="nx">azure</span><span class="o">:</span> <span class="s2">&quot;#f0ffff&quot;</span><span class="p">,</span>
  <span class="nx">beige</span><span class="o">:</span> <span class="s2">&quot;#f5f5dc&quot;</span><span class="p">,</span>
  <span class="nx">bisque</span><span class="o">:</span> <span class="s2">&quot;#ffe4c4&quot;</span><span class="p">,</span>
  <span class="nx">black</span><span class="o">:</span> <span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
  <span class="nx">blanchedalmond</span><span class="o">:</span> <span class="s2">&quot;#ffebcd&quot;</span><span class="p">,</span>
  <span class="nx">blue</span><span class="o">:</span> <span class="s2">&quot;#0000ff&quot;</span><span class="p">,</span>
  <span class="nx">blueviolet</span><span class="o">:</span> <span class="s2">&quot;#8a2be2&quot;</span><span class="p">,</span>
  <span class="nx">brown</span><span class="o">:</span> <span class="s2">&quot;#a52a2a&quot;</span><span class="p">,</span>
  <span class="nx">burlywood</span><span class="o">:</span> <span class="s2">&quot;#deb887&quot;</span><span class="p">,</span>
  <span class="nx">cadetblue</span><span class="o">:</span> <span class="s2">&quot;#5f9ea0&quot;</span><span class="p">,</span>
  <span class="nx">chartreuse</span><span class="o">:</span> <span class="s2">&quot;#7fff00&quot;</span><span class="p">,</span>
  <span class="nx">chocolate</span><span class="o">:</span> <span class="s2">&quot;#d2691e&quot;</span><span class="p">,</span>
  <span class="nx">coral</span><span class="o">:</span> <span class="s2">&quot;#ff7f50&quot;</span><span class="p">,</span>
  <span class="nx">cornflowerblue</span><span class="o">:</span> <span class="s2">&quot;#6495ed&quot;</span><span class="p">,</span>
  <span class="nx">cornsilk</span><span class="o">:</span> <span class="s2">&quot;#fff8dc&quot;</span><span class="p">,</span>
  <span class="nx">crimson</span><span class="o">:</span> <span class="s2">&quot;#dc143c&quot;</span><span class="p">,</span>
  <span class="nx">cyan</span><span class="o">:</span> <span class="s2">&quot;#00ffff&quot;</span><span class="p">,</span>
  <span class="nx">darkblue</span><span class="o">:</span> <span class="s2">&quot;#00008b&quot;</span><span class="p">,</span>
  <span class="nx">darkcyan</span><span class="o">:</span> <span class="s2">&quot;#008b8b&quot;</span><span class="p">,</span>
  <span class="nx">darkgoldenrod</span><span class="o">:</span> <span class="s2">&quot;#b8860b&quot;</span><span class="p">,</span>
  <span class="nx">darkgray</span><span class="o">:</span> <span class="s2">&quot;#a9a9a9&quot;</span><span class="p">,</span>
  <span class="nx">darkgreen</span><span class="o">:</span> <span class="s2">&quot;#006400&quot;</span><span class="p">,</span>
  <span class="nx">darkgrey</span><span class="o">:</span> <span class="s2">&quot;#a9a9a9&quot;</span><span class="p">,</span>
  <span class="nx">darkkhaki</span><span class="o">:</span> <span class="s2">&quot;#bdb76b&quot;</span><span class="p">,</span>
  <span class="nx">darkmagenta</span><span class="o">:</span> <span class="s2">&quot;#8b008b&quot;</span><span class="p">,</span>
  <span class="nx">darkolivegreen</span><span class="o">:</span> <span class="s2">&quot;#556b2f&quot;</span><span class="p">,</span>
  <span class="nx">darkorange</span><span class="o">:</span> <span class="s2">&quot;#ff8c00&quot;</span><span class="p">,</span>
  <span class="nx">darkorchid</span><span class="o">:</span> <span class="s2">&quot;#9932cc&quot;</span><span class="p">,</span>
  <span class="nx">darkred</span><span class="o">:</span> <span class="s2">&quot;#8b0000&quot;</span><span class="p">,</span>
  <span class="nx">darksalmon</span><span class="o">:</span> <span class="s2">&quot;#e9967a&quot;</span><span class="p">,</span>
  <span class="nx">darkseagreen</span><span class="o">:</span> <span class="s2">&quot;#8fbc8f&quot;</span><span class="p">,</span>
  <span class="nx">darkslateblue</span><span class="o">:</span> <span class="s2">&quot;#483d8b&quot;</span><span class="p">,</span>
  <span class="nx">darkslategray</span><span class="o">:</span> <span class="s2">&quot;#2f4f4f&quot;</span><span class="p">,</span>
  <span class="nx">darkslategrey</span><span class="o">:</span> <span class="s2">&quot;#2f4f4f&quot;</span><span class="p">,</span>
  <span class="nx">darkturquoise</span><span class="o">:</span> <span class="s2">&quot;#00ced1&quot;</span><span class="p">,</span>
  <span class="nx">darkviolet</span><span class="o">:</span> <span class="s2">&quot;#9400d3&quot;</span><span class="p">,</span>
  <span class="nx">deeppink</span><span class="o">:</span> <span class="s2">&quot;#ff1493&quot;</span><span class="p">,</span>
  <span class="nx">deepskyblue</span><span class="o">:</span> <span class="s2">&quot;#00bfff&quot;</span><span class="p">,</span>
  <span class="nx">dimgray</span><span class="o">:</span> <span class="s2">&quot;#696969&quot;</span><span class="p">,</span>
  <span class="nx">dimgrey</span><span class="o">:</span> <span class="s2">&quot;#696969&quot;</span><span class="p">,</span>
  <span class="nx">dodgerblue</span><span class="o">:</span> <span class="s2">&quot;#1e90ff&quot;</span><span class="p">,</span>
  <span class="nx">firebrick</span><span class="o">:</span> <span class="s2">&quot;#b22222&quot;</span><span class="p">,</span>
  <span class="nx">floralwhite</span><span class="o">:</span> <span class="s2">&quot;#fffaf0&quot;</span><span class="p">,</span>
  <span class="nx">forestgreen</span><span class="o">:</span> <span class="s2">&quot;#228b22&quot;</span><span class="p">,</span>
  <span class="nx">fuchsia</span><span class="o">:</span> <span class="s2">&quot;#ff00ff&quot;</span><span class="p">,</span>
  <span class="nx">gainsboro</span><span class="o">:</span> <span class="s2">&quot;#dcdcdc&quot;</span><span class="p">,</span>
  <span class="nx">ghostwhite</span><span class="o">:</span> <span class="s2">&quot;#f8f8ff&quot;</span><span class="p">,</span>
  <span class="nx">gold</span><span class="o">:</span> <span class="s2">&quot;#ffd700&quot;</span><span class="p">,</span>
  <span class="nx">goldenrod</span><span class="o">:</span> <span class="s2">&quot;#daa520&quot;</span><span class="p">,</span>
  <span class="nx">gray</span><span class="o">:</span> <span class="s2">&quot;#808080&quot;</span><span class="p">,</span>
  <span class="nx">green</span><span class="o">:</span> <span class="s2">&quot;#008000&quot;</span><span class="p">,</span>
  <span class="nx">greenyellow</span><span class="o">:</span> <span class="s2">&quot;#adff2f&quot;</span><span class="p">,</span>
  <span class="nx">grey</span><span class="o">:</span> <span class="s2">&quot;#808080&quot;</span><span class="p">,</span>
  <span class="nx">honeydew</span><span class="o">:</span> <span class="s2">&quot;#f0fff0&quot;</span><span class="p">,</span>
  <span class="nx">hotpink</span><span class="o">:</span> <span class="s2">&quot;#ff69b4&quot;</span><span class="p">,</span>
  <span class="nx">indianred</span><span class="o">:</span> <span class="s2">&quot;#cd5c5c&quot;</span><span class="p">,</span>
  <span class="nx">indigo</span><span class="o">:</span> <span class="s2">&quot;#4b0082&quot;</span><span class="p">,</span>
  <span class="nx">ivory</span><span class="o">:</span> <span class="s2">&quot;#fffff0&quot;</span><span class="p">,</span>
  <span class="nx">khaki</span><span class="o">:</span> <span class="s2">&quot;#f0e68c&quot;</span><span class="p">,</span>
  <span class="nx">lavender</span><span class="o">:</span> <span class="s2">&quot;#e6e6fa&quot;</span><span class="p">,</span>
  <span class="nx">lavenderblush</span><span class="o">:</span> <span class="s2">&quot;#fff0f5&quot;</span><span class="p">,</span>
  <span class="nx">lawngreen</span><span class="o">:</span> <span class="s2">&quot;#7cfc00&quot;</span><span class="p">,</span>
  <span class="nx">lemonchiffon</span><span class="o">:</span> <span class="s2">&quot;#fffacd&quot;</span><span class="p">,</span>
  <span class="nx">lightblue</span><span class="o">:</span> <span class="s2">&quot;#add8e6&quot;</span><span class="p">,</span>
  <span class="nx">lightcoral</span><span class="o">:</span> <span class="s2">&quot;#f08080&quot;</span><span class="p">,</span>
  <span class="nx">lightcyan</span><span class="o">:</span> <span class="s2">&quot;#e0ffff&quot;</span><span class="p">,</span>
  <span class="nx">lightgoldenrodyellow</span><span class="o">:</span> <span class="s2">&quot;#fafad2&quot;</span><span class="p">,</span>
  <span class="nx">lightgray</span><span class="o">:</span> <span class="s2">&quot;#d3d3d3&quot;</span><span class="p">,</span>
  <span class="nx">lightgreen</span><span class="o">:</span> <span class="s2">&quot;#90ee90&quot;</span><span class="p">,</span>
  <span class="nx">lightgrey</span><span class="o">:</span> <span class="s2">&quot;#d3d3d3&quot;</span><span class="p">,</span>
  <span class="nx">lightpink</span><span class="o">:</span> <span class="s2">&quot;#ffb6c1&quot;</span><span class="p">,</span>
  <span class="nx">lightsalmon</span><span class="o">:</span> <span class="s2">&quot;#ffa07a&quot;</span><span class="p">,</span>
  <span class="nx">lightseagreen</span><span class="o">:</span> <span class="s2">&quot;#20b2aa&quot;</span><span class="p">,</span>
  <span class="nx">lightskyblue</span><span class="o">:</span> <span class="s2">&quot;#87cefa&quot;</span><span class="p">,</span>
  <span class="nx">lightslategray</span><span class="o">:</span> <span class="s2">&quot;#778899&quot;</span><span class="p">,</span>
  <span class="nx">lightslategrey</span><span class="o">:</span> <span class="s2">&quot;#778899&quot;</span><span class="p">,</span>
  <span class="nx">lightsteelblue</span><span class="o">:</span> <span class="s2">&quot;#b0c4de&quot;</span><span class="p">,</span>
  <span class="nx">lightyellow</span><span class="o">:</span> <span class="s2">&quot;#ffffe0&quot;</span><span class="p">,</span>
  <span class="nx">lime</span><span class="o">:</span> <span class="s2">&quot;#00ff00&quot;</span><span class="p">,</span>
  <span class="nx">limegreen</span><span class="o">:</span> <span class="s2">&quot;#32cd32&quot;</span><span class="p">,</span>
  <span class="nx">linen</span><span class="o">:</span> <span class="s2">&quot;#faf0e6&quot;</span><span class="p">,</span>
  <span class="nx">magenta</span><span class="o">:</span> <span class="s2">&quot;#ff00ff&quot;</span><span class="p">,</span>
  <span class="nx">maroon</span><span class="o">:</span> <span class="s2">&quot;#800000&quot;</span><span class="p">,</span>
  <span class="nx">mediumaquamarine</span><span class="o">:</span> <span class="s2">&quot;#66cdaa&quot;</span><span class="p">,</span>
  <span class="nx">mediumblue</span><span class="o">:</span> <span class="s2">&quot;#0000cd&quot;</span><span class="p">,</span>
  <span class="nx">mediumorchid</span><span class="o">:</span> <span class="s2">&quot;#ba55d3&quot;</span><span class="p">,</span>
  <span class="nx">mediumpurple</span><span class="o">:</span> <span class="s2">&quot;#9370db&quot;</span><span class="p">,</span>
  <span class="nx">mediumseagreen</span><span class="o">:</span> <span class="s2">&quot;#3cb371&quot;</span><span class="p">,</span>
  <span class="nx">mediumslateblue</span><span class="o">:</span> <span class="s2">&quot;#7b68ee&quot;</span><span class="p">,</span>
  <span class="nx">mediumspringgreen</span><span class="o">:</span> <span class="s2">&quot;#00fa9a&quot;</span><span class="p">,</span>
  <span class="nx">mediumturquoise</span><span class="o">:</span> <span class="s2">&quot;#48d1cc&quot;</span><span class="p">,</span>
  <span class="nx">mediumvioletred</span><span class="o">:</span> <span class="s2">&quot;#c71585&quot;</span><span class="p">,</span>
  <span class="nx">midnightblue</span><span class="o">:</span> <span class="s2">&quot;#191970&quot;</span><span class="p">,</span>
  <span class="nx">mintcream</span><span class="o">:</span> <span class="s2">&quot;#f5fffa&quot;</span><span class="p">,</span>
  <span class="nx">mistyrose</span><span class="o">:</span> <span class="s2">&quot;#ffe4e1&quot;</span><span class="p">,</span>
  <span class="nx">moccasin</span><span class="o">:</span> <span class="s2">&quot;#ffe4b5&quot;</span><span class="p">,</span>
  <span class="nx">navajowhite</span><span class="o">:</span> <span class="s2">&quot;#ffdead&quot;</span><span class="p">,</span>
  <span class="nx">navy</span><span class="o">:</span> <span class="s2">&quot;#000080&quot;</span><span class="p">,</span>
  <span class="nx">oldlace</span><span class="o">:</span> <span class="s2">&quot;#fdf5e6&quot;</span><span class="p">,</span>
  <span class="nx">olive</span><span class="o">:</span> <span class="s2">&quot;#808000&quot;</span><span class="p">,</span>
  <span class="nx">olivedrab</span><span class="o">:</span> <span class="s2">&quot;#6b8e23&quot;</span><span class="p">,</span>
  <span class="nx">orange</span><span class="o">:</span> <span class="s2">&quot;#ffa500&quot;</span><span class="p">,</span>
  <span class="nx">orangered</span><span class="o">:</span> <span class="s2">&quot;#ff4500&quot;</span><span class="p">,</span>
  <span class="nx">orchid</span><span class="o">:</span> <span class="s2">&quot;#da70d6&quot;</span><span class="p">,</span>
  <span class="nx">palegoldenrod</span><span class="o">:</span> <span class="s2">&quot;#eee8aa&quot;</span><span class="p">,</span>
  <span class="nx">palegreen</span><span class="o">:</span> <span class="s2">&quot;#98fb98&quot;</span><span class="p">,</span>
  <span class="nx">paleturquoise</span><span class="o">:</span> <span class="s2">&quot;#afeeee&quot;</span><span class="p">,</span>
  <span class="nx">palevioletred</span><span class="o">:</span> <span class="s2">&quot;#db7093&quot;</span><span class="p">,</span>
  <span class="nx">papayawhip</span><span class="o">:</span> <span class="s2">&quot;#ffefd5&quot;</span><span class="p">,</span>
  <span class="nx">peachpuff</span><span class="o">:</span> <span class="s2">&quot;#ffdab9&quot;</span><span class="p">,</span>
  <span class="nx">peru</span><span class="o">:</span> <span class="s2">&quot;#cd853f&quot;</span><span class="p">,</span>
  <span class="nx">pink</span><span class="o">:</span> <span class="s2">&quot;#ffc0cb&quot;</span><span class="p">,</span>
  <span class="nx">plum</span><span class="o">:</span> <span class="s2">&quot;#dda0dd&quot;</span><span class="p">,</span>
  <span class="nx">powderblue</span><span class="o">:</span> <span class="s2">&quot;#b0e0e6&quot;</span><span class="p">,</span>
  <span class="nx">purple</span><span class="o">:</span> <span class="s2">&quot;#800080&quot;</span><span class="p">,</span>
  <span class="nx">red</span><span class="o">:</span> <span class="s2">&quot;#ff0000&quot;</span><span class="p">,</span>
  <span class="nx">rosybrown</span><span class="o">:</span> <span class="s2">&quot;#bc8f8f&quot;</span><span class="p">,</span>
  <span class="nx">royalblue</span><span class="o">:</span> <span class="s2">&quot;#4169e1&quot;</span><span class="p">,</span>
  <span class="nx">saddlebrown</span><span class="o">:</span> <span class="s2">&quot;#8b4513&quot;</span><span class="p">,</span>
  <span class="nx">salmon</span><span class="o">:</span> <span class="s2">&quot;#fa8072&quot;</span><span class="p">,</span>
  <span class="nx">sandybrown</span><span class="o">:</span> <span class="s2">&quot;#f4a460&quot;</span><span class="p">,</span>
  <span class="nx">seagreen</span><span class="o">:</span> <span class="s2">&quot;#2e8b57&quot;</span><span class="p">,</span>
  <span class="nx">seashell</span><span class="o">:</span> <span class="s2">&quot;#fff5ee&quot;</span><span class="p">,</span>
  <span class="nx">sienna</span><span class="o">:</span> <span class="s2">&quot;#a0522d&quot;</span><span class="p">,</span>
  <span class="nx">silver</span><span class="o">:</span> <span class="s2">&quot;#c0c0c0&quot;</span><span class="p">,</span>
  <span class="nx">skyblue</span><span class="o">:</span> <span class="s2">&quot;#87ceeb&quot;</span><span class="p">,</span>
  <span class="nx">slateblue</span><span class="o">:</span> <span class="s2">&quot;#6a5acd&quot;</span><span class="p">,</span>
  <span class="nx">slategray</span><span class="o">:</span> <span class="s2">&quot;#708090&quot;</span><span class="p">,</span>
  <span class="nx">slategrey</span><span class="o">:</span> <span class="s2">&quot;#708090&quot;</span><span class="p">,</span>
  <span class="nx">snow</span><span class="o">:</span> <span class="s2">&quot;#fffafa&quot;</span><span class="p">,</span>
  <span class="nx">springgreen</span><span class="o">:</span> <span class="s2">&quot;#00ff7f&quot;</span><span class="p">,</span>
  <span class="nx">steelblue</span><span class="o">:</span> <span class="s2">&quot;#4682b4&quot;</span><span class="p">,</span>
  <span class="nx">tan</span><span class="o">:</span> <span class="s2">&quot;#d2b48c&quot;</span><span class="p">,</span>
  <span class="nx">teal</span><span class="o">:</span> <span class="s2">&quot;#008080&quot;</span><span class="p">,</span>
  <span class="nx">thistle</span><span class="o">:</span> <span class="s2">&quot;#d8bfd8&quot;</span><span class="p">,</span>
  <span class="nx">tomato</span><span class="o">:</span> <span class="s2">&quot;#ff6347&quot;</span><span class="p">,</span>
  <span class="nx">turquoise</span><span class="o">:</span> <span class="s2">&quot;#40e0d0&quot;</span><span class="p">,</span>
  <span class="nx">violet</span><span class="o">:</span> <span class="s2">&quot;#ee82ee&quot;</span><span class="p">,</span>
  <span class="nx">wheat</span><span class="o">:</span> <span class="s2">&quot;#f5deb3&quot;</span><span class="p">,</span>
  <span class="nx">white</span><span class="o">:</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span>
  <span class="nx">whitesmoke</span><span class="o">:</span> <span class="s2">&quot;#f5f5f5&quot;</span><span class="p">,</span>
  <span class="nx">yellow</span><span class="o">:</span> <span class="s2">&quot;#ffff00&quot;</span><span class="p">,</span>
  <span class="nx">yellowgreen</span><span class="o">:</span> <span class="s2">&quot;#9acd32&quot;</span>
<span class="p">});</span>

<span class="nx">d3_rgb_names</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_rgb_names</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">d3_rgb_parse</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">d3_rgb</span><span class="p">,</span> <span class="nx">d3_hsl_rgb</span><span class="p">));</span>
<span class="p">});</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">hsl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">h</span> <span class="k">instanceof</span> <span class="nx">d3_Hsl</span> <span class="o">?</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nx">l</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">d3_rgb_parse</span><span class="p">(</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">d3_rgb_hsl</span><span class="p">,</span> <span class="nx">d3_hsl</span><span class="p">))</span>
      <span class="o">:</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="o">+</span><span class="nx">h</span><span class="p">,</span> <span class="o">+</span><span class="nx">s</span><span class="p">,</span> <span class="o">+</span><span class="nx">l</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_Hsl</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_Hsl</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">l</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3_Hsl</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">brighter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">k</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span> <span class="o">/</span> <span class="nx">k</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_Hsl</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">darker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">k</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">d3_hsl</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="nx">k</span> <span class="o">*</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_Hsl</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">rgb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_hsl_rgb</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">h</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">s</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">l</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_Hsl</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">rgb</span><span class="p">().</span><span class="nx">toString</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_hsl_rgb</span><span class="p">(</span><span class="nx">h</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">m1</span><span class="p">,</span>
      <span class="nx">m2</span><span class="p">;</span>

  <span class="cm">/* Some simple corrections for h, s and l. */</span>
  <span class="nx">h</span> <span class="o">=</span> <span class="nx">h</span> <span class="o">%</span> <span class="mi">360</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">h</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>
  <span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">s</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">s</span><span class="p">;</span>
  <span class="nx">l</span> <span class="o">=</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">l</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="nx">l</span><span class="p">;</span>

  <span class="cm">/* From FvD 13.37, CSS Color Module Level 3 */</span>
  <span class="nx">m2</span> <span class="o">=</span> <span class="nx">l</span> <span class="o">&lt;=</span> <span class="p">.</span><span class="mi">5</span> <span class="o">?</span> <span class="nx">l</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">s</span><span class="p">)</span> <span class="o">:</span> <span class="nx">l</span> <span class="o">+</span> <span class="nx">s</span> <span class="o">-</span> <span class="nx">l</span> <span class="o">*</span> <span class="nx">s</span><span class="p">;</span>
  <span class="nx">m1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">l</span> <span class="o">-</span> <span class="nx">m2</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">v</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="nx">h</span> <span class="o">-=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">h</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m1</span> <span class="o">+</span> <span class="p">(</span><span class="nx">m2</span> <span class="o">-</span> <span class="nx">m1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">h</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">h</span> <span class="o">&lt;</span> <span class="mi">240</span><span class="p">)</span> <span class="k">return</span> <span class="nx">m1</span> <span class="o">+</span> <span class="p">(</span><span class="nx">m2</span> <span class="o">-</span> <span class="nx">m1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">240</span> <span class="o">-</span> <span class="nx">h</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">m1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">vv</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">v</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_rgb</span><span class="p">(</span><span class="nx">vv</span><span class="p">(</span><span class="nx">h</span> <span class="o">+</span> <span class="mi">120</span><span class="p">),</span> <span class="nx">vv</span><span class="p">(</span><span class="nx">h</span><span class="p">),</span> <span class="nx">vv</span><span class="p">(</span><span class="nx">h</span> <span class="o">-</span> <span class="mi">120</span><span class="p">));</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_selection</span><span class="p">(</span><span class="nx">groups</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_arraySubclass</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="nx">d3_selectionPrototype</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">d3_selectAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">n</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span> <span class="p">},</span>
    <span class="nx">d3_selectRoot</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">,</span>
    <span class="nx">d3_selectMatcher</span> <span class="o">=</span> <span class="nx">d3_selectRoot</span><span class="p">.</span><span class="nx">matchesSelector</span> <span class="o">||</span> <span class="nx">d3_selectRoot</span><span class="p">.</span><span class="nx">webkitMatchesSelector</span> <span class="o">||</span> <span class="nx">d3_selectRoot</span><span class="p">.</span><span class="nx">mozMatchesSelector</span> <span class="o">||</span> <span class="nx">d3_selectRoot</span><span class="p">.</span><span class="nx">msMatchesSelector</span> <span class="o">||</span> <span class="nx">d3_selectRoot</span><span class="p">.</span><span class="nx">oMatchesSelector</span><span class="p">,</span>
    <span class="nx">d3_selectMatches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_selectMatcher</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span> <span class="p">};</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Prefer Sizzle, if available.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">Sizzle</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Sizzle</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="p">};</span>
  <span class="nx">d3_selectAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">uniqueSort</span><span class="p">(</span><span class="nx">Sizzle</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">n</span><span class="p">));</span> <span class="p">};</span>
  <span class="nx">d3_selectMatches</span> <span class="o">=</span> <span class="nx">Sizzle</span><span class="p">.</span><span class="nx">matchesSelector</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_selectionPrototype</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">selection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_selectionRoot</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">;</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">subnode</span><span class="p">,</span>
      <span class="nx">group</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">selector</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">d3_selection_selector</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="nx">subgroup</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subnode</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">subnode</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;__data__&quot;</span> <span class="k">in</span> <span class="nx">node</span><span class="p">)</span> <span class="nx">subnode</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_selection_selector</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_select</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">selectAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">selector</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">d3_selection_selectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">d3_array</span><span class="p">(</span><span class="nx">selector</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">)));</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_selection_selectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_selectAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">attr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">qualify</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>If no value is specified, return the first value.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span>
        <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrNull</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrNullNS</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrConstant</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrConstantNS</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrFunctionNS</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrNullNS</span> <span class="o">:</span> <span class="nx">attrNull</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrFunctionNS</span> <span class="o">:</span> <span class="nx">attrFunction</span><span class="p">)</span>
      <span class="o">:</span> <span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrConstantNS</span> <span class="o">:</span> <span class="nx">attrConstant</span><span class="p">)));</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">classed</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">names</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">d3_selection_classedWhitespace</span><span class="p">),</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">d3_selection_classed</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_selection_classed</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_selection_classedWhitespace</span> <span class="o">=</span> <span class="sr">/\s+/g</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_selection_classed</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;(^|\\s+)&quot;</span> <span class="o">+</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">requote</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;(\\s+|$)&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>If no value is specified, return the first value.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">classList</span><span class="p">)</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">className</span><span class="p">;</span>
    <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">:</span> <span class="nx">c</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedAdd</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">classList</span><span class="p">)</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span><span class="p">,</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">cv</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">?</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">:</span> <span class="nx">c</span><span class="p">;</span>
    <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">re</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">cv</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">cv</span> <span class="o">=</span> <span class="nx">d3_collapse</span><span class="p">(</span><span class="nx">cv</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedRemove</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">classList</span><span class="p">)</span> <span class="k">return</span> <span class="nx">c</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span><span class="p">,</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">cv</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">?</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">:</span> <span class="nx">c</span><span class="p">;</span>
    <span class="nx">cv</span> <span class="o">=</span> <span class="nx">d3_collapse</span><span class="p">(</span><span class="nx">cv</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">re</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">baseVal</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">cv</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">classedFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="p">(</span><span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="o">?</span> <span class="nx">classedAdd</span>
        <span class="o">:</span> <span class="nx">classedRemove</span><span class="p">).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="nx">classedFunction</span> <span class="o">:</span> <span class="nx">value</span>
      <span class="o">?</span> <span class="nx">classedAdd</span>
      <span class="o">:</span> <span class="nx">classedRemove</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">priority</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>If no value is specified, return the first value.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="nb">window</span>
      <span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">(),</span> <span class="kc">null</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">styleNull</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleConstant</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">styleFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">priority</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">?</span> <span class="nx">styleNull</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="nx">styleFunction</span> <span class="o">:</span> <span class="nx">styleConstant</span><span class="p">));</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">property</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>If no value is specified, return the first value.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">()[</span><span class="nx">name</span><span class="p">];</span>

  <span class="kd">function</span> <span class="nx">propertyNull</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">propertyConstant</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">propertyFunction</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">delete</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">else</span> <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">?</span> <span class="nx">propertyNull</span> <span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="nx">propertyFunction</span> <span class="o">:</span> <span class="nx">propertyConstant</span><span class="p">));</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">textContent</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">v</span><span class="p">;</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="p">}</span>
      <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">innerHTML</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="o">:</span> <span class="nx">v</span><span class="p">;</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">value</span> <span class="o">==</span> <span class="kc">null</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span> <span class="p">}</span>
      <span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">});</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>TODO append(node)?
TODO append(function)?</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">append</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">qualify</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">append</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">,</span> <span class="nx">name</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">appendNS</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">appendNS</span> <span class="o">:</span> <span class="nx">append</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>TODO insert(node, function)?
TODO insert(function, string)?
TODO insert(function, function)?</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">insert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">before</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">name</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">qualify</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">insert</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">namespaceURI</span><span class="p">,</span> <span class="nx">name</span><span class="p">),</span>
        <span class="nx">d3_select</span><span class="p">(</span><span class="nx">before</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">insertNS</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">),</span>
        <span class="nx">d3_select</span><span class="p">(</span><span class="nx">before</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">insertNS</span> <span class="o">:</span> <span class="nx">insert</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>TODO remove(selector)?
TODO remove(node)?
TODO remove(function)?</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">parent</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">group</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>If no value is specified, return the first value.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">bind</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">groupData</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">groupData</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">n0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span><span class="p">),</span>
        <span class="nx">n1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">m</span><span class="p">),</span>
        <span class="nx">updateNodes</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">enterNodes</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">exitNodes</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">node</span><span class="p">,</span>
        <span class="nx">nodeData</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">nodeByKeyValue</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">,</span>
          <span class="nx">keyValues</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">keyValue</span><span class="p">,</span>
          <span class="nx">j</span> <span class="o">=</span> <span class="nx">groupData</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
        <span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span> <span class="c1">// duplicate key</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">,</span> <span class="nx">node</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">keyValues</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
        <span class="nx">keyValue</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">groupData</span><span class="p">,</span> <span class="nx">nodeData</span> <span class="o">=</span> <span class="nx">groupData</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">);</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">nodeData</span><span class="p">;</span>
          <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_selection_dataNode</span><span class="p">(</span><span class="nx">nodeData</span><span class="p">);</span>
          <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">keyValue</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nodeByKeyValue</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">keyValues</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n0</span><span class="p">;)</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">nodeData</span> <span class="o">=</span> <span class="nx">groupData</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">nodeData</span><span class="p">;</span>
          <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
          <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_selection_dataNode</span><span class="p">(</span><span class="nx">nodeData</span><span class="p">);</span>
          <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_selection_dataNode</span><span class="p">(</span><span class="nx">groupData</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n1</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">exitNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">enterNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">updateNodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">enterNodes</span><span class="p">.</span><span class="nx">update</span>
        <span class="o">=</span> <span class="nx">updateNodes</span><span class="p">;</span>

    <span class="nx">enterNodes</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="o">=</span> <span class="nx">updateNodes</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="o">=</span> <span class="nx">exitNodes</span><span class="p">.</span><span class="nx">parentNode</span>
        <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>

    <span class="nx">enter</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">enterNodes</span><span class="p">);</span>
    <span class="nx">update</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">updateNodes</span><span class="p">);</span>
    <span class="nx">exit</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">exitNodes</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">enter</span> <span class="o">=</span> <span class="nx">d3_selection_enter</span><span class="p">([]),</span>
      <span class="nx">update</span> <span class="o">=</span> <span class="nx">d3_selection</span><span class="p">([]),</span>
      <span class="nx">exit</span> <span class="o">=</span> <span class="nx">d3_selection</span><span class="p">([]);</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bind</span><span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">group</span><span class="p">,</span> <span class="nx">group</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bind</span><span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">update</span><span class="p">.</span><span class="nx">enter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">enter</span><span class="p">;</span> <span class="p">};</span>
  <span class="nx">update</span><span class="p">.</span><span class="nx">exit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">exit</span><span class="p">;</span> <span class="p">};</span>
  <span class="k">return</span> <span class="nx">update</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_selection_dataNode</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">__data__</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">datum</span> <span class="o">=</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s2">&quot;__data__&quot;</span><span class="p">)</span>
      <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s2">&quot;__data__&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">filter</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">group</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">filter</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">filter</span> <span class="o">=</span> <span class="nx">d3_selection_filter</span><span class="p">(</span><span class="nx">filter</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="nx">subgroup</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_selection_filter</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_selectMatches</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">selector</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">node</span><span class="p">;</span> <span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">next</span> <span class="o">&amp;&amp;</span> <span class="nx">next</span> <span class="o">!==</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nextSibling</span><span class="p">)</span> <span class="nx">next</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
        <span class="nx">next</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">comparator</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">comparator</span> <span class="o">=</span> <span class="nx">d3_selection_sortComparator</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">sort</span><span class="p">(</span><span class="nx">comparator</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">order</span><span class="p">();</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_selection_sortComparator</span><span class="p">(</span><span class="nx">comparator</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">comparator</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">;</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">comparator</span><span class="p">(</span><span class="nx">a</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">__data__</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>type can be namespaced, e.g., "click.foo"
listener can be null for removal</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">,</span> <span class="nx">capture</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">capture</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>parse the type specifier</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;__on&quot;</span> <span class="o">+</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">type</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>if called with only one argument, return the current listener</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">()[</span><span class="nx">name</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">i</span><span class="p">.</span><span class="nx">_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>remove the old event listener, and add the new event listener</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="nx">node</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>remove the old listener, if any (using the previously-set capture)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">$</span><span class="p">);</span>
      <span class="k">delete</span> <span class="nx">node</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>add the new listener, if any (remembering the capture flag)</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">node</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">l</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nx">capture</span><span class="p">);</span>
      <span class="nx">l</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">listener</span><span class="p">;</span> <span class="c1">// stash the unwrapped listener for get</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>wrapped event listener that preserves i</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">l</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span> <span class="c1">// Events can be reentrant (e.g., focus).</span>
      <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">listener</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
        <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Note: assigning to the arguments array simultaneously changes the value of
the corresponding argument!</p>

<p>TODO The <code>this</code> argument probably shouldn't be the first argument to the
callback, anyway, since it's redundant. However, that will require a major
version bump due to backwards compatibility, so I'm not changing it right
away.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">empty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">();</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">transition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">?</span> <span class="p">{</span><span class="nx">node</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">delay</span><span class="o">:</span> <span class="nx">d3_transitionDelay</span><span class="p">,</span> <span class="nx">duration</span><span class="o">:</span> <span class="nx">d3_transitionDuration</span><span class="p">}</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_transition</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="nx">d3_transitionId</span> <span class="o">||</span> <span class="o">++</span><span class="nx">d3_transitionNextId</span><span class="p">,</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">d3_selectionRoot</span> <span class="o">=</span> <span class="nx">d3_selection</span><span class="p">([[</span><span class="nb">document</span><span class="p">]]);</span>

<span class="nx">d3_selectionRoot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">d3_selectRoot</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>TODO fast singleton implementation!
TODO select(function)</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span>
      <span class="o">?</span> <span class="nx">d3_selectionRoot</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">d3_selection</span><span class="p">([[</span><span class="nx">selector</span><span class="p">]]);</span> <span class="c1">// assume node</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>TODO selectAll(function)</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">selector</span> <span class="o">===</span> <span class="s2">&quot;string&quot;</span>
      <span class="o">?</span> <span class="nx">d3_selectionRoot</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">d3_selection</span><span class="p">([</span><span class="nx">d3_array</span><span class="p">(</span><span class="nx">selector</span><span class="p">)]);</span> <span class="c1">// assume node[]</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_selection_enter</span><span class="p">(</span><span class="nx">selection</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_arraySubclass</span><span class="p">(</span><span class="nx">selection</span><span class="p">,</span> <span class="nx">d3_selection_enterPrototype</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">selection</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_selection_enterPrototype</span> <span class="o">=</span> <span class="p">[];</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">enter</span> <span class="o">=</span> <span class="nx">d3_selection_enter</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">selection</span><span class="p">.</span><span class="nx">enter</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">d3_selection_enterPrototype</span><span class="p">;</span>

<span class="nx">d3_selection_enterPrototype</span><span class="p">.</span><span class="nx">append</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">append</span><span class="p">;</span>
<span class="nx">d3_selection_enterPrototype</span><span class="p">.</span><span class="nx">insert</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">insert</span><span class="p">;</span>
<span class="nx">d3_selection_enterPrototype</span><span class="p">.</span><span class="nx">empty</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">empty</span><span class="p">;</span>
<span class="nx">d3_selection_enterPrototype</span><span class="p">.</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">node</span><span class="p">;</span>
<span class="nx">d3_selection_enterPrototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">subnode</span><span class="p">,</span>
      <span class="nx">upgroup</span><span class="p">,</span>
      <span class="nx">group</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="nx">upgroup</span> <span class="o">=</span> <span class="p">(</span><span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">]).</span><span class="nx">update</span><span class="p">;</span>
    <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="nx">subgroup</span><span class="p">.</span><span class="nx">parentNode</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">upgroup</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">subnode</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">group</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
        <span class="nx">subnode</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_selection</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_transition</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">time</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_arraySubclass</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="nx">d3_transitionPrototype</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">tweens</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">,</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">),</span>
      <span class="nx">ease</span> <span class="o">=</span> <span class="nx">d3_transitionEase</span><span class="p">;</span>

  <span class="nx">groups</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>

  <span class="nx">groups</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">;</span>

  <span class="nx">groups</span><span class="p">.</span><span class="nx">tween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tween</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tweens</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tween</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">tweens</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>
    <span class="k">else</span> <span class="nx">tweens</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tween</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">groups</span><span class="p">.</span><span class="nx">ease</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">ease</span><span class="p">;</span>
    <span class="nx">ease</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">value</span> <span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ease</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">d3</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">groups</span><span class="p">.</span><span class="nx">each</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d3_transition_each</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">groups</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">listener</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">groups</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">tweened</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">node</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
          <span class="nx">delay</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">delay</span><span class="p">,</span>
          <span class="nx">duration</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">duration</span><span class="p">,</span>
          <span class="nx">lock</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__transition__</span> <span class="o">||</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">__transition__</span> <span class="o">=</span> <span class="p">{</span><span class="nx">active</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">count</span><span class="o">:</span> <span class="mi">0</span><span class="p">});</span>

      <span class="o">++</span><span class="nx">lock</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span>

      <span class="nx">delay</span> <span class="o">&lt;=</span> <span class="nx">elapsed</span> <span class="o">?</span> <span class="nx">start</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">)</span> <span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">delay</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>

      <span class="kd">function</span> <span class="nx">start</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lock</span><span class="p">.</span><span class="nx">active</span> <span class="o">&gt;</span> <span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="nx">stop</span><span class="p">();</span>
        <span class="nx">lock</span><span class="p">.</span><span class="nx">active</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>

        <span class="nx">tweens</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">tweened</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">});</span>

        <span class="nx">event</span><span class="p">.</span><span class="nx">start</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">tick</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">))</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">(</span><span class="nx">tick</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">tick</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">lock</span><span class="p">.</span><span class="nx">active</span> <span class="o">!==</span> <span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="nx">stop</span><span class="p">();</span>

        <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="p">(</span><span class="nx">elapsed</span> <span class="o">-</span> <span class="nx">delay</span><span class="p">)</span> <span class="o">/</span> <span class="nx">duration</span><span class="p">,</span>
            <span class="nx">e</span> <span class="o">=</span> <span class="nx">ease</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span>
            <span class="nx">n</span> <span class="o">=</span> <span class="nx">tweened</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">tweened</span><span class="p">[</span><span class="o">--</span><span class="nx">n</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">stop</span><span class="p">();</span>
          <span class="nx">d3_transitionId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
          <span class="nx">event</span><span class="p">.</span><span class="nx">end</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
          <span class="nx">d3_transitionId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!--</span><span class="nx">lock</span><span class="p">.</span><span class="nx">count</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__transition__</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">time</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_transitionRemove</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">function</span> <span class="nx">d3_transitionNull</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">d3_transitionRemove</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_transitionTween</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">d3_interpolateByName</span><span class="p">(</span><span class="nx">name</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">transitionFunction</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">v</span> <span class="o">==</span> <span class="kc">null</span>
        <span class="o">?</span> <span class="nx">a</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nx">d3_transitionRemove</span>
        <span class="o">:</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">v</span> <span class="o">&amp;&amp;</span> <span class="nx">interpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">transitionString</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span> <span class="o">&amp;&amp;</span> <span class="nx">interpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">typeof</span> <span class="nx">b</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">transitionFunction</span>
      <span class="o">:</span> <span class="nx">b</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">d3_transitionNull</span>
      <span class="o">:</span> <span class="p">(</span><span class="nx">b</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="nx">transitionString</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_transitionPrototype</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">d3_transitionNextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">d3_transitionId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">d3_transitionDefaultDelay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">d3_transitionDefaultDuration</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
    <span class="nx">d3_transitionDefaultEase</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ease</span><span class="p">(</span><span class="s2">&quot;cubic-in-out&quot;</span><span class="p">),</span>
    <span class="nx">d3_transitionDelay</span> <span class="o">=</span> <span class="nx">d3_transitionDefaultDelay</span><span class="p">,</span>
    <span class="nx">d3_transitionDuration</span> <span class="o">=</span> <span class="nx">d3_transitionDefaultDuration</span><span class="p">,</span>
    <span class="nx">d3_transitionEase</span> <span class="o">=</span> <span class="nx">d3_transitionDefaultEase</span><span class="p">;</span>

<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">call</span> <span class="o">=</span> <span class="nx">d3_selectionPrototype</span><span class="p">.</span><span class="nx">call</span><span class="p">;</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selection</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">d3_transitionId</span> <span class="o">?</span> <span class="nx">selection</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span> <span class="o">:</span> <span class="nx">selection</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">d3_selectionRoot</span><span class="p">.</span><span class="nx">transition</span><span class="p">();</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nx">d3_transitionPrototype</span><span class="p">;</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">subnode</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">selector</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">d3_selection_selector</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">subnode</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;__data__&quot;</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span> <span class="nx">subnode</span><span class="p">.</span><span class="nx">__data__</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">;</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">node</span><span class="o">:</span> <span class="nx">subnode</span><span class="p">,</span> <span class="nx">delay</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">delay</span><span class="p">,</span> <span class="nx">duration</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">duration</span><span class="p">});</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_transition</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">time</span><span class="p">).</span><span class="nx">ease</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ease</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">selectAll</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">subgroup</span><span class="p">,</span>
      <span class="nx">subnodes</span><span class="p">,</span>
      <span class="nx">node</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">selector</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">selector</span> <span class="o">=</span> <span class="nx">d3_selection_selectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="p">{</span>
        <span class="nx">subnodes</span> <span class="o">=</span> <span class="nx">selector</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="nx">subgroups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">subgroup</span> <span class="o">=</span> <span class="p">[]);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">subnodes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">o</span><span class="p">;)</span> <span class="p">{</span>
          <span class="nx">subgroup</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">node</span><span class="o">:</span> <span class="nx">subnodes</span><span class="p">[</span><span class="nx">k</span><span class="p">],</span> <span class="nx">delay</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">delay</span><span class="p">,</span> <span class="nx">duration</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">duration</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3_transition</span><span class="p">(</span><span class="nx">subgroups</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">time</span><span class="p">).</span><span class="nx">ease</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ease</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">attr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">attrTween</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">d3_transitionTween</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">));</span>
<span class="p">};</span>

<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">attrTween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nameNS</span><span class="p">,</span> <span class="nx">tween</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">qualify</span><span class="p">(</span><span class="nx">nameNS</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">attrTween</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">tween</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">f</span> <span class="o">===</span> <span class="nx">d3_transitionRemove</span>
        <span class="o">?</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">removeAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">f</span> <span class="o">&amp;&amp;</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span><span class="p">));</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">attrTweenNS</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">tween</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">f</span> <span class="o">===</span> <span class="nx">d3_transitionRemove</span>
        <span class="o">?</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">removeAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">f</span> <span class="o">&amp;&amp;</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">setAttributeNS</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">space</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span><span class="p">));</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;attr.&quot;</span> <span class="o">+</span> <span class="nx">nameNS</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">local</span> <span class="o">?</span> <span class="nx">attrTweenNS</span> <span class="o">:</span> <span class="nx">attrTween</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">style</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">priority</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">styleTween</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">d3_transitionTween</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">),</span> <span class="nx">priority</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">styleTween</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">tween</span><span class="p">,</span> <span class="nx">priority</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="nx">priority</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;style.&quot;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">tween</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">getComputedStyle</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">getPropertyValue</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">f</span> <span class="o">===</span> <span class="nx">d3_transitionRemove</span>
        <span class="o">?</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">removeProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="kc">null</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">f</span> <span class="o">&amp;&amp;</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">setProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">f</span><span class="p">(</span><span class="nx">t</span><span class="p">),</span> <span class="nx">priority</span><span class="p">);</span> <span class="p">};</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">tween</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">textContent</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">value</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="s2">&quot;end.transition&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">__transition__</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">p</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">))</span> <span class="nx">p</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">delay</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">delay</span> <span class="o">=</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
      <span class="o">:</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">delay</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}));</span>
<span class="p">};</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
      <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">duration</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">value</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">|</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
      <span class="o">:</span> <span class="p">(</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">value</span> <span class="o">|</span> <span class="mi">0</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="nx">groups</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">duration</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="p">}));</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_transition_each</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">d3_transitionId</span><span class="p">,</span>
      <span class="nx">ease</span> <span class="o">=</span> <span class="nx">d3_transitionEase</span><span class="p">,</span>
      <span class="nx">delay</span> <span class="o">=</span> <span class="nx">d3_transitionDelay</span><span class="p">,</span>
      <span class="nx">duration</span> <span class="o">=</span> <span class="nx">d3_transitionDuration</span><span class="p">;</span>

  <span class="nx">d3_transitionId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="nx">d3_transitionEase</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ease</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d3_transitionDelay</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">delay</span><span class="p">;</span>
        <span class="nx">d3_transitionDuration</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">i</span><span class="p">].</span><span class="nx">duration</span><span class="p">;</span>
        <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">__data__</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">d3_transitionId</span> <span class="o">=</span> <span class="nx">id</span><span class="p">;</span>
  <span class="nx">d3_transitionEase</span> <span class="o">=</span> <span class="nx">ease</span><span class="p">;</span>
  <span class="nx">d3_transitionDelay</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">;</span>
  <span class="nx">d3_transitionDuration</span> <span class="o">=</span> <span class="nx">duration</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3_transitionPrototype</span><span class="p">.</span><span class="nx">transition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">d3_this</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">d3_timer_queue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">d3_timer_interval</span><span class="p">,</span> <span class="c1">// is an interval (or frame) active?</span>
    <span class="nx">d3_timer_timeout</span><span class="p">;</span> <span class="c1">// is a timeout active?</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>The timer will continue to fire until callback returns true.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">delay</span><span class="p">,</span> <span class="nx">then</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">found</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">t0</span><span class="p">,</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="nx">d3_timer_queue</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isFinite</span><span class="p">(</span><span class="nx">delay</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
    <span class="nx">then</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>See if the callback's already in the queue.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">while</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t1</span><span class="p">.</span><span class="nx">callback</span> <span class="o">===</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t1</span><span class="p">.</span><span class="nx">then</span> <span class="o">=</span> <span class="nx">then</span><span class="p">;</span>
      <span class="nx">t1</span><span class="p">.</span><span class="nx">delay</span> <span class="o">=</span> <span class="nx">delay</span><span class="p">;</span>
      <span class="nx">found</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">t0</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">;</span>
    <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Otherwise, add the callback to the queue.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">found</span><span class="p">)</span> <span class="nx">d3_timer_queue</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="o">:</span> <span class="nx">callback</span><span class="p">,</span>
    <span class="nx">then</span><span class="o">:</span> <span class="nx">then</span><span class="p">,</span>
    <span class="nx">delay</span><span class="o">:</span> <span class="nx">delay</span><span class="p">,</span>
    <span class="nx">next</span><span class="o">:</span> <span class="nx">d3_timer_queue</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Start animatin'!</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_timer_interval</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_timer_timeout</span> <span class="o">=</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">d3_timer_timeout</span><span class="p">);</span>
    <span class="nx">d3_timer_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">d3_timer_frame</span><span class="p">(</span><span class="nx">d3_timer_step</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_timer_step</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elapsed</span><span class="p">,</span>
      <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="nx">d3_timer_queue</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elapsed</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">elapsed</span> <span class="o">&gt;=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">delay</span><span class="p">)</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">flush</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">);</span>
    <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">delay</span> <span class="o">=</span> <span class="nx">d3_timer_flush</span><span class="p">()</span> <span class="o">-</span> <span class="nx">now</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">delay</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isFinite</span><span class="p">(</span><span class="nx">delay</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">d3_timer_timeout</span><span class="p">);</span>
      <span class="nx">d3_timer_timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">d3_timer_step</span><span class="p">,</span> <span class="nx">delay</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">d3_timer_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">d3_timer_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">d3_timer_frame</span><span class="p">(</span><span class="nx">d3_timer_step</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">flush</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">elapsed</span><span class="p">,</span>
      <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">(),</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="nx">d3_timer_queue</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">elapsed</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">then</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">t1</span><span class="p">.</span><span class="nx">delay</span><span class="p">)</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">flush</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">callback</span><span class="p">(</span><span class="nx">elapsed</span><span class="p">);</span>
    <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">d3_timer_flush</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Flush after callbacks, to avoid concurrent queue modification.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_timer_flush</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t0</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="nx">d3_timer_queue</span><span class="p">,</span>
      <span class="nx">then</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">t1</span><span class="p">.</span><span class="nx">flush</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="nx">t0</span> <span class="o">?</span> <span class="nx">t0</span><span class="p">.</span><span class="nx">next</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">next</span> <span class="o">:</span> <span class="nx">d3_timer_queue</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">then</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">then</span><span class="p">,</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">then</span> <span class="o">+</span> <span class="nx">t1</span><span class="p">.</span><span class="nx">delay</span><span class="p">);</span>
      <span class="nx">t1</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t0</span> <span class="o">=</span> <span class="nx">t1</span><span class="p">).</span><span class="nx">next</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">then</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_timer_frame</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span>
    <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span>
    <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span>
    <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">oRequestAnimationFrame</span>
    <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span>
    <span class="o">||</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="mi">17</span><span class="p">);</span> <span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElementNS</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">ns</span><span class="p">.</span><span class="nx">prefix</span><span class="p">.</span><span class="nx">svg</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">),</span>
      <span class="nx">identity</span> <span class="o">=</span> <span class="p">{</span><span class="nx">a</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">c</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">f</span><span class="o">:</span> <span class="mi">0</span><span class="p">};</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">transform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="nx">string</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">baseVal</span><span class="p">.</span><span class="nx">consolidate</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_transform</span><span class="p">(</span><span class="nx">t</span> <span class="o">?</span> <span class="nx">t</span><span class="p">.</span><span class="nx">matrix</span> <span class="o">:</span> <span class="nx">identity</span><span class="p">);</span>
  <span class="p">})(</span><span class="nx">string</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Compute x-scale and normalize the first row.
Compute shear and make second row orthogonal to first.
Compute y-scale and normalize the second row.
Finally, compute the rotation.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_transform</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r0</span> <span class="o">=</span> <span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">a</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">b</span><span class="p">],</span>
      <span class="nx">r1</span> <span class="o">=</span> <span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">c</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">d</span><span class="p">],</span>
      <span class="nx">kx</span> <span class="o">=</span> <span class="nx">d3_transformNormalize</span><span class="p">(</span><span class="nx">r0</span><span class="p">),</span>
      <span class="nx">kz</span> <span class="o">=</span> <span class="nx">d3_transformDot</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nx">r1</span><span class="p">),</span>
      <span class="nx">ky</span> <span class="o">=</span> <span class="nx">d3_transformNormalize</span><span class="p">(</span><span class="nx">d3_transformCombine</span><span class="p">(</span><span class="nx">r1</span><span class="p">,</span> <span class="nx">r0</span><span class="p">,</span> <span class="o">-</span><span class="nx">kz</span><span class="p">))</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">r0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">r0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">r0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">r0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">kx</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">kz</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">=</span> <span class="p">(</span><span class="nx">kx</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">r0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">r0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="o">-</span><span class="nx">r1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">r1</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="nx">d3_transformDegrees</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">e</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">f</span><span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="p">[</span><span class="nx">kx</span><span class="p">,</span> <span class="nx">ky</span><span class="p">];</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">skew</span> <span class="o">=</span> <span class="nx">ky</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">kz</span><span class="p">,</span> <span class="nx">ky</span><span class="p">)</span> <span class="o">*</span> <span class="nx">d3_transformDegrees</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">d3_transform</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">translate</span>
      <span class="o">+</span> <span class="s2">&quot;)rotate(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">rotate</span>
      <span class="o">+</span> <span class="s2">&quot;)skewX(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">skew</span>
      <span class="o">+</span> <span class="s2">&quot;)scale(&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">scale</span>
      <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_transformDot</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_transformNormalize</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">d3_transformDot</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">a</span><span class="p">));</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="nx">k</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_transformCombine</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_transformDegrees</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_mousePoint</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">d3_eventSource</span><span class="p">());</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>https://bugs.webkit.org/show_bug.cgi?id=44083</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_mouse_bug44083</span> <span class="o">=</span> <span class="sr">/WebKit/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_mousePoint</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">ownerSVGElement</span> <span class="o">||</span> <span class="nx">container</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">svg</span><span class="p">.</span><span class="nx">createSVGPoint</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">.</span><span class="nx">createSVGPoint</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">d3_mouse_bug44083</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">scrollX</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">scrollY</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;position&quot;</span><span class="p">,</span> <span class="s2">&quot;absolute&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="kd">var</span> <span class="nx">ctm</span> <span class="o">=</span> <span class="nx">svg</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">getScreenCTM</span><span class="p">();</span>
      <span class="nx">d3_mouse_bug44083</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="nx">ctm</span><span class="p">.</span><span class="nx">f</span> <span class="o">||</span> <span class="nx">ctm</span><span class="p">.</span><span class="nx">e</span><span class="p">);</span>
      <span class="nx">svg</span><span class="p">.</span><span class="nx">remove</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">d3_mouse_bug44083</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">;</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">point</span> <span class="o">=</span> <span class="nx">point</span><span class="p">.</span><span class="nx">matrixTransform</span><span class="p">(</span><span class="nx">container</span><span class="p">.</span><span class="nx">getScreenCTM</span><span class="p">().</span><span class="nx">inverse</span><span class="p">());</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">container</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">container</span><span class="p">.</span><span class="nx">clientLeft</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">container</span><span class="p">.</span><span class="nx">clientTop</span><span class="p">];</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">d3_eventSource</span><span class="p">().</span><span class="nx">touches</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">touches</span> <span class="o">?</span> <span class="nx">d3_array</span><span class="p">(</span><span class="nx">touches</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">touch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">d3_mousePoint</span><span class="p">(</span><span class="nx">container</span><span class="p">,</span> <span class="nx">touch</span><span class="p">);</span>
    <span class="nx">point</span><span class="p">.</span><span class="nx">identifier</span> <span class="o">=</span> <span class="nx">touch</span><span class="p">.</span><span class="nx">identifier</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">point</span><span class="p">;</span>
  <span class="p">})</span> <span class="o">:</span> <span class="p">[];</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_noop</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">function</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">stop</span> <span class="o">?</span> <span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">stop</span><span class="p">,</span> <span class="nx">start</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scaleRange</span><span class="p">(</span><span class="nx">scale</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeExtent</span> <span class="o">?</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeExtent</span><span class="p">()</span> <span class="o">:</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">range</span><span class="p">());</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_scale_nice</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">nice</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">i1</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">x0</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="nx">i0</span><span class="p">],</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="nx">i1</span><span class="p">],</span>
      <span class="nx">dx</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">dx</span> <span class="o">=</span> <span class="nx">i0</span><span class="p">;</span> <span class="nx">i0</span> <span class="o">=</span> <span class="nx">i1</span><span class="p">;</span> <span class="nx">i1</span> <span class="o">=</span> <span class="nx">dx</span><span class="p">;</span>
    <span class="nx">dx</span> <span class="o">=</span> <span class="nx">x0</span><span class="p">;</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">;</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">dx</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">nice</span> <span class="o">=</span> <span class="nx">nice</span><span class="p">(</span><span class="nx">dx</span><span class="p">);</span>
    <span class="nx">domain</span><span class="p">[</span><span class="nx">i0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nice</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x0</span><span class="p">);</span>
    <span class="nx">domain</span><span class="p">[</span><span class="nx">i1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">nice</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">x1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_niceDefault</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_linear</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_linear</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">,</span> <span class="nx">clamp</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">output</span><span class="p">,</span>
      <span class="nx">input</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">rescale</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">linear</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="nx">d3_scale_polylinear</span> <span class="o">:</span> <span class="nx">d3_scale_bilinear</span><span class="p">,</span>
        <span class="nx">uninterpolate</span> <span class="o">=</span> <span class="nx">clamp</span> <span class="o">?</span> <span class="nx">d3_uninterpolateClamp</span> <span class="o">:</span> <span class="nx">d3_uninterpolateNumber</span><span class="p">;</span>
    <span class="nx">output</span> <span class="o">=</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">uninterpolate</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">);</span>
    <span class="nx">input</span> <span class="o">=</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">domain</span><span class="p">,</span> <span class="nx">uninterpolate</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">interpolate</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">output</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Note: requires range is coercible to number!</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">scale</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">input</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
    <span class="nx">domain</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Number</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeRound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">interpolateRound</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">clamp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">clamp</span><span class="p">;</span>
    <span class="nx">clamp</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">interpolate</span><span class="p">;</span>
    <span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTicks</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTickFormat</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">nice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">d3_scale_nice</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">d3_scale_linearNice</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linear</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">,</span> <span class="nx">clamp</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_linearRebind</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">linear</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">linear</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="s2">&quot;rangeRound&quot;</span><span class="p">,</span> <span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="s2">&quot;clamp&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_linearNice</span><span class="p">(</span><span class="nx">dx</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">dx</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">dx</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">floor</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">dx</span><span class="p">)</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">;</span> <span class="p">},</span>
    <span class="nx">ceil</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">dx</span><span class="p">)</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_linearTickRange</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">domain</span><span class="p">),</span>
      <span class="nx">span</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">step</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">span</span> <span class="o">/</span> <span class="nx">m</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">)),</span>
      <span class="nx">err</span> <span class="o">=</span> <span class="nx">m</span> <span class="o">/</span> <span class="nx">span</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Filter ticks to get closer to the desired count.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&lt;=</span> <span class="p">.</span><span class="mi">15</span><span class="p">)</span> <span class="nx">step</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&lt;=</span> <span class="p">.</span><span class="mi">35</span><span class="p">)</span> <span class="nx">step</span> <span class="o">*=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">err</span> <span class="o">&lt;=</span> <span class="p">.</span><span class="mi">75</span><span class="p">)</span> <span class="nx">step</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Round start and stop values to step interval.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nx">step</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
  <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nx">step</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span> <span class="c1">// inclusive</span>
  <span class="nx">extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">step</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">extent</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_linearTicks</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">d3</span><span class="p">,</span> <span class="nx">d3_scale_linearTickRange</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_linearTickFormat</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;,.&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d3_scale_linearTickRange</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">)[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span> <span class="o">+</span> <span class="p">.</span><span class="mi">01</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;f&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_scale_bilinear</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">uninterpolate</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">uninterpolate</span><span class="p">(</span><span class="nx">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">domain</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="nx">interpolate</span><span class="p">(</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">(</span><span class="nx">u</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_scale_polylinear</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">uninterpolate</span><span class="p">,</span> <span class="nx">interpolate</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Handle descending domains.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">domain</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
    <span class="nx">domain</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">slice</span><span class="p">().</span><span class="nx">reverse</span><span class="p">();</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">slice</span><span class="p">().</span><span class="nx">reverse</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;=</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">u</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">uninterpolate</span><span class="p">(</span><span class="nx">domain</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">domain</span><span class="p">[</span><span class="nx">j</span><span class="p">]));</span>
    <span class="nx">i</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">range</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">range</span><span class="p">[</span><span class="nx">j</span><span class="p">]));</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">[</span><span class="nx">j</span><span class="p">](</span><span class="nx">u</span><span class="p">[</span><span class="nx">j</span><span class="p">](</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_log</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span> <span class="nx">d3_scale_logp</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_log</span><span class="p">(</span><span class="nx">linear</span><span class="p">,</span> <span class="nx">log</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">pow</span> <span class="o">=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">pow</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">pow</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">pow</span><span class="p">);</span>
    <span class="nx">log</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">d3_scale_logn</span> <span class="o">:</span> <span class="nx">d3_scale_logp</span><span class="p">;</span>
    <span class="nx">pow</span> <span class="o">=</span> <span class="nx">log</span><span class="p">.</span><span class="nx">pow</span><span class="p">;</span>
    <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">log</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">nice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">d3_scale_nice</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(),</span> <span class="nx">d3_scale_niceDefault</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">()),</span>
        <span class="nx">ticks</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">extent</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nb">isFinite</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">j</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
          <span class="nx">u</span> <span class="o">=</span> <span class="nx">pow</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">v</span> <span class="o">=</span> <span class="nx">pow</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">log</span> <span class="o">===</span> <span class="nx">d3_scale_logn</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">ticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pow</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">;)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">k</span><span class="o">--</span><span class="p">)</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pow</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="nx">k</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">k</span><span class="o">++</span><span class="p">)</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pow</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">*</span> <span class="nx">k</span><span class="p">);</span>
        <span class="nx">ticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pow</span><span class="p">(</span><span class="nx">i</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">ticks</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">u</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// strip small values</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">ticks</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">v</span><span class="p">;</span> <span class="nx">j</span><span class="o">--</span><span class="p">)</span> <span class="p">{}</span> <span class="c1">// strip big values</span>
      <span class="nx">ticks</span> <span class="o">=</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">ticks</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">format</span> <span class="o">=</span> <span class="nx">d3_scale_logFormat</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span><span class="p">().</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">f</span> <span class="o">=</span> <span class="nx">log</span> <span class="o">===</span> <span class="nx">d3_scale_logn</span> <span class="o">?</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">e</span> <span class="o">=</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">),</span>
        <span class="nx">e</span><span class="p">;</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">d</span> <span class="o">/</span> <span class="nx">pow</span><span class="p">(</span><span class="nx">f</span><span class="p">(</span><span class="nx">log</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="nx">e</span><span class="p">))</span> <span class="o">&lt;</span> <span class="nx">k</span> <span class="o">?</span> <span class="nx">format</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_log</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span> <span class="nx">log</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_scale_linearRebind</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">linear</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_scale_logFormat</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;.0e&quot;</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">d3_scale_logp</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_logn</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN10</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3_scale_logp</span><span class="p">.</span><span class="nx">pow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_scale_logn</span><span class="p">.</span><span class="nx">pow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="nx">x</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">pow</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_pow</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_pow</span><span class="p">(</span><span class="nx">linear</span><span class="p">,</span> <span class="nx">exponent</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">powp</span> <span class="o">=</span> <span class="nx">d3_scale_powPow</span><span class="p">(</span><span class="nx">exponent</span><span class="p">),</span>
      <span class="nx">powb</span> <span class="o">=</span> <span class="nx">d3_scale_powPow</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nx">exponent</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">powp</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">powb</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">powb</span><span class="p">);</span>
    <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">powp</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTicks</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(),</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTickFormat</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(),</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">nice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">d3_scale_nice</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(),</span> <span class="nx">d3_scale_linearNice</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">exponent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">exponent</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">domain</span> <span class="o">=</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">();</span>
    <span class="nx">powp</span> <span class="o">=</span> <span class="nx">d3_scale_powPow</span><span class="p">(</span><span class="nx">exponent</span> <span class="o">=</span> <span class="nx">x</span><span class="p">);</span>
    <span class="nx">powb</span> <span class="o">=</span> <span class="nx">d3_scale_powPow</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nx">exponent</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_pow</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span> <span class="nx">exponent</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_scale_linearRebind</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">linear</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_scale_powPow</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="o">-</span><span class="nx">x</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">sqrt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">pow</span><span class="p">().</span><span class="nx">exponent</span><span class="p">(.</span><span class="mi">5</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_ordinal</span><span class="p">([],</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="p">[]});</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_ordinal</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">ranger</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">index</span><span class="p">,</span>
      <span class="nx">range</span><span class="p">,</span>
      <span class="nx">rangeBand</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">[((</span><span class="nx">index</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">index</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">)))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">steps</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">step</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="nx">i</span><span class="p">;</span> <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
    <span class="nx">domain</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">index</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_Map</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="nx">xi</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">index</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">xi</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span> <span class="nx">index</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">xi</span><span class="p">,</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">xi</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">[</span><span class="nx">ranger</span><span class="p">.</span><span class="nx">t</span><span class="p">](</span><span class="nx">ranger</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">ranger</span><span class="p">.</span><span class="nx">p</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">rangeBand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">ranger</span> <span class="o">=</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">};</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangePoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">padding</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">stop</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">);</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">stop</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">:</span> <span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="nx">padding</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">step</span><span class="p">);</span>
    <span class="nx">rangeBand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">ranger</span> <span class="o">=</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="s2">&quot;rangePoints&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="o">:</span> <span class="nx">padding</span><span class="p">};</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeBands</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">padding</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">reverse</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">reverse</span> <span class="o">-</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">stop</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">reverse</span><span class="p">],</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="p">(</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">);</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span> <span class="o">*</span> <span class="nx">padding</span><span class="p">,</span> <span class="nx">step</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">reverse</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
    <span class="nx">rangeBand</span> <span class="o">=</span> <span class="nx">step</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">);</span>
    <span class="nx">ranger</span> <span class="o">=</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="s2">&quot;rangeBands&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="o">:</span> <span class="nx">padding</span><span class="p">};</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeRoundBands</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">padding</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="nx">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">reverse</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">start</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">reverse</span> <span class="o">-</span> <span class="mi">0</span><span class="p">],</span>
        <span class="nx">stop</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">reverse</span><span class="p">],</span>
        <span class="nx">step</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">)),</span>
        <span class="nx">error</span> <span class="o">=</span> <span class="nx">stop</span> <span class="o">-</span> <span class="nx">start</span> <span class="o">-</span> <span class="p">(</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">)</span> <span class="o">*</span> <span class="nx">step</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">steps</span><span class="p">(</span><span class="nx">start</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">error</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="nx">step</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">reverse</span><span class="p">)</span> <span class="nx">range</span><span class="p">.</span><span class="nx">reverse</span><span class="p">();</span>
    <span class="nx">rangeBand</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">step</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">));</span>
    <span class="nx">ranger</span> <span class="o">=</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="s2">&quot;rangeRoundBands&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">p</span><span class="o">:</span> <span class="nx">padding</span><span class="p">};</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeBand</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">rangeBand</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">rangeExtent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">ranger</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_ordinal</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">ranger</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * This product includes color specifications and designs developed by Cynthia</span>
<span class="cm"> * Brewer (http://colorbrewer.org/). See lib/colorbrewer for more information.</span>
<span class="cm"> */</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category10</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span><span class="p">().</span><span class="nx">range</span><span class="p">(</span><span class="nx">d3_category10</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category20</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span><span class="p">().</span><span class="nx">range</span><span class="p">(</span><span class="nx">d3_category20</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category20b</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span><span class="p">().</span><span class="nx">range</span><span class="p">(</span><span class="nx">d3_category20b</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">category20c</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ordinal</span><span class="p">().</span><span class="nx">range</span><span class="p">(</span><span class="nx">d3_category20c</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_category10</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="s2">&quot;#2ca02c&quot;</span><span class="p">,</span> <span class="s2">&quot;#d62728&quot;</span><span class="p">,</span> <span class="s2">&quot;#9467bd&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#8c564b&quot;</span><span class="p">,</span> <span class="s2">&quot;#e377c2&quot;</span><span class="p">,</span> <span class="s2">&quot;#7f7f7f&quot;</span><span class="p">,</span> <span class="s2">&quot;#bcbd22&quot;</span><span class="p">,</span> <span class="s2">&quot;#17becf&quot;</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_category20</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;#1f77b4&quot;</span><span class="p">,</span> <span class="s2">&quot;#aec7e8&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#ff7f0e&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffbb78&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#2ca02c&quot;</span><span class="p">,</span> <span class="s2">&quot;#98df8a&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#d62728&quot;</span><span class="p">,</span> <span class="s2">&quot;#ff9896&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#9467bd&quot;</span><span class="p">,</span> <span class="s2">&quot;#c5b0d5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#8c564b&quot;</span><span class="p">,</span> <span class="s2">&quot;#c49c94&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#e377c2&quot;</span><span class="p">,</span> <span class="s2">&quot;#f7b6d2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#7f7f7f&quot;</span><span class="p">,</span> <span class="s2">&quot;#c7c7c7&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#bcbd22&quot;</span><span class="p">,</span> <span class="s2">&quot;#dbdb8d&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#17becf&quot;</span><span class="p">,</span> <span class="s2">&quot;#9edae5&quot;</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_category20b</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;#393b79&quot;</span><span class="p">,</span> <span class="s2">&quot;#5254a3&quot;</span><span class="p">,</span> <span class="s2">&quot;#6b6ecf&quot;</span><span class="p">,</span> <span class="s2">&quot;#9c9ede&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#637939&quot;</span><span class="p">,</span> <span class="s2">&quot;#8ca252&quot;</span><span class="p">,</span> <span class="s2">&quot;#b5cf6b&quot;</span><span class="p">,</span> <span class="s2">&quot;#cedb9c&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#8c6d31&quot;</span><span class="p">,</span> <span class="s2">&quot;#bd9e39&quot;</span><span class="p">,</span> <span class="s2">&quot;#e7ba52&quot;</span><span class="p">,</span> <span class="s2">&quot;#e7cb94&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#843c39&quot;</span><span class="p">,</span> <span class="s2">&quot;#ad494a&quot;</span><span class="p">,</span> <span class="s2">&quot;#d6616b&quot;</span><span class="p">,</span> <span class="s2">&quot;#e7969c&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#7b4173&quot;</span><span class="p">,</span> <span class="s2">&quot;#a55194&quot;</span><span class="p">,</span> <span class="s2">&quot;#ce6dbd&quot;</span><span class="p">,</span> <span class="s2">&quot;#de9ed6&quot;</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_category20c</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;#3182bd&quot;</span><span class="p">,</span> <span class="s2">&quot;#6baed6&quot;</span><span class="p">,</span> <span class="s2">&quot;#9ecae1&quot;</span><span class="p">,</span> <span class="s2">&quot;#c6dbef&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#e6550d&quot;</span><span class="p">,</span> <span class="s2">&quot;#fd8d3c&quot;</span><span class="p">,</span> <span class="s2">&quot;#fdae6b&quot;</span><span class="p">,</span> <span class="s2">&quot;#fdd0a2&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#31a354&quot;</span><span class="p">,</span> <span class="s2">&quot;#74c476&quot;</span><span class="p">,</span> <span class="s2">&quot;#a1d99b&quot;</span><span class="p">,</span> <span class="s2">&quot;#c7e9c0&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#756bb1&quot;</span><span class="p">,</span> <span class="s2">&quot;#9e9ac8&quot;</span><span class="p">,</span> <span class="s2">&quot;#bcbddc&quot;</span><span class="p">,</span> <span class="s2">&quot;#dadaeb&quot;</span><span class="p">,</span>
  <span class="s2">&quot;#636363&quot;</span><span class="p">,</span> <span class="s2">&quot;#969696&quot;</span><span class="p">,</span> <span class="s2">&quot;#bdbdbd&quot;</span><span class="p">,</span> <span class="s2">&quot;#d9d9d9&quot;</span>
<span class="p">];</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">quantile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_quantile</span><span class="p">([],</span> <span class="p">[]);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_quantile</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">thresholds</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">rescale</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">q</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">thresholds</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">q</span><span class="p">)</span> <span class="nx">thresholds</span><span class="p">[</span><span class="nx">k</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">quantile</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">k</span> <span class="o">/</span> <span class="nx">q</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">))</span> <span class="k">return</span> <span class="kc">NaN</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">thresholds</span><span class="p">,</span> <span class="nx">x</span><span class="p">)];</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
    <span class="nx">domain</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span> <span class="p">}).</span><span class="nx">sort</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">quantiles</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">thresholds</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_quantile</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">range</span><span class="p">);</span> <span class="c1">// copy on write!</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">quantize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_quantize</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_quantize</span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">range</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">kx</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">range</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">kx</span> <span class="o">*</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">))))];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">rescale</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">kx</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">);</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="nx">range</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">];</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">x1</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">range</span><span class="p">;</span>
    <span class="nx">range</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_quantize</span><span class="p">(</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">range</span><span class="p">);</span> <span class="c1">// copy on write</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">rescale</span><span class="p">();</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">identity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_scale_identity</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_scale_identity</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">identity</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span> <span class="p">}</span>

  <span class="nx">identity</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="nx">identity</span><span class="p">;</span>

  <span class="nx">identity</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="nx">identity</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">domain</span><span class="p">;</span>
    <span class="nx">domain</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">identity</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">identity</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">identity</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTicks</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">identity</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_linearTickFormat</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">identity</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_scale_identity</span><span class="p">(</span><span class="nx">domain</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">identity</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span> <span class="o">=</span> <span class="p">{};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">arc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">innerRadius</span> <span class="o">=</span> <span class="nx">d3_svg_arcInnerRadius</span><span class="p">,</span>
      <span class="nx">outerRadius</span> <span class="o">=</span> <span class="nx">d3_svg_arcOuterRadius</span><span class="p">,</span>
      <span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">d3_svg_arcStartAngle</span><span class="p">,</span>
      <span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">d3_svg_arcEndAngle</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">arc</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r0</span> <span class="o">=</span> <span class="nx">innerRadius</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">r1</span> <span class="o">=</span> <span class="nx">outerRadius</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">a0</span> <span class="o">=</span> <span class="nx">startAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">,</span>
        <span class="nx">a1</span> <span class="o">=</span> <span class="nx">endAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">,</span>
        <span class="nx">da</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a1</span> <span class="o">&lt;</span> <span class="nx">a0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">da</span> <span class="o">=</span> <span class="nx">a0</span><span class="p">,</span> <span class="nx">a0</span> <span class="o">=</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a1</span> <span class="o">=</span> <span class="nx">da</span><span class="p">),</span> <span class="nx">a1</span> <span class="o">-</span> <span class="nx">a0</span><span class="p">),</span>
        <span class="nx">df</span> <span class="o">=</span> <span class="nx">da</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">?</span> <span class="s2">&quot;0&quot;</span> <span class="o">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
        <span class="nx">c0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a0</span><span class="p">),</span>
        <span class="nx">s0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a0</span><span class="p">),</span>
        <span class="nx">c1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a1</span><span class="p">),</span>
        <span class="nx">s1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">da</span> <span class="o">&gt;=</span> <span class="nx">d3_svg_arcMax</span>
      <span class="o">?</span> <span class="p">(</span><span class="nx">r0</span>
      <span class="o">?</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="nx">r1</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">r1</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="nx">r1</span>
      <span class="o">+</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="nx">r0</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot; 0 1,0 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">r0</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot; 0 1,0 0,&quot;</span> <span class="o">+</span> <span class="nx">r0</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
      <span class="o">:</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="nx">r1</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">r1</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="nx">r1</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>
      <span class="o">:</span> <span class="p">(</span><span class="nx">r0</span>
      <span class="o">?</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">c0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">s0</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 &quot;</span> <span class="o">+</span> <span class="nx">df</span> <span class="o">+</span> <span class="s2">&quot;,1 &quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">c1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">s1</span>
      <span class="o">+</span> <span class="s2">&quot;L&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">*</span> <span class="nx">c1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">*</span> <span class="nx">s1</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">+</span> <span class="s2">&quot; 0 &quot;</span> <span class="o">+</span> <span class="nx">df</span> <span class="o">+</span> <span class="s2">&quot;,0 &quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">*</span> <span class="nx">c0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r0</span> <span class="o">*</span> <span class="nx">s0</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span>
      <span class="o">:</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">c0</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">s0</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">+</span> <span class="s2">&quot; 0 &quot;</span> <span class="o">+</span> <span class="nx">df</span> <span class="o">+</span> <span class="s2">&quot;,1 &quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">c1</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r1</span> <span class="o">*</span> <span class="nx">s1</span>
      <span class="o">+</span> <span class="s2">&quot;L0,0&quot;</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">arc</span><span class="p">.</span><span class="nx">innerRadius</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">innerRadius</span><span class="p">;</span>
    <span class="nx">innerRadius</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">arc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">arc</span><span class="p">.</span><span class="nx">outerRadius</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">outerRadius</span><span class="p">;</span>
    <span class="nx">outerRadius</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">arc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">arc</span><span class="p">.</span><span class="nx">startAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">startAngle</span><span class="p">;</span>
    <span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">arc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">arc</span><span class="p">.</span><span class="nx">endAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">endAngle</span><span class="p">;</span>
    <span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">arc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">arc</span><span class="p">.</span><span class="nx">centroid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">(</span><span class="nx">innerRadius</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="o">+</span> <span class="nx">outerRadius</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="nx">startAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="o">+</span> <span class="nx">endAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nx">r</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="nx">r</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">arc</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_svg_arcOffset</span> <span class="o">=</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="nx">d3_svg_arcMax</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_svg_arcInnerRadius</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">innerRadius</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_arcOuterRadius</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">outerRadius</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_arcStartAngle</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">startAngle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_arcEndAngle</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">endAngle</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_svg_line</span><span class="p">(</span><span class="nx">projection</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">d3_svg_lineX</span><span class="p">,</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">d3_svg_lineY</span><span class="p">,</span>
      <span class="nx">defined</span> <span class="o">=</span> <span class="nx">d3_true</span><span class="p">,</span>
      <span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolatorDefault</span><span class="p">,</span>
      <span class="nx">interpolator</span> <span class="o">=</span> <span class="nx">d3_svg_lineLinear</span><span class="p">,</span>
      <span class="nx">tension</span> <span class="o">=</span> <span class="p">.</span><span class="mi">7</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">line</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">segments</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">points</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">d</span><span class="p">,</span>
        <span class="nx">fx</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">),</span>
        <span class="nx">fy</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">segment</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="nx">interpolator</span><span class="p">(</span><span class="nx">projection</span><span class="p">(</span><span class="nx">points</span><span class="p">),</span> <span class="nx">tension</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">defined</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="o">+</span><span class="nx">fx</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="o">+</span><span class="nx">fy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">segment</span><span class="p">();</span>
        <span class="nx">points</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">segment</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">line</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">line</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">line</span><span class="p">.</span><span class="nx">defined</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">defined</span><span class="p">;</span>
    <span class="nx">defined</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">line</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">interpolate</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_svg_lineInterpolators</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">_</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolatorDefault</span><span class="p">;</span>
    <span class="nx">interpolator</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">line</span><span class="p">.</span><span class="nx">tension</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tension</span><span class="p">;</span>
    <span class="nx">tension</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">line</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_svg_line</span><span class="p">(</span><span class="nx">d3_identity</span><span class="p">);</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>The default <code>x</code> property, which references d[0].</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineX</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>The default <code>y</code> property, which references d[1].</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineY</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_svg_lineInterpolatorDefault</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>The various interpolators supported by the <code>line</code> class.</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_svg_lineInterpolators</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="s2">&quot;linear&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineLinear</span><span class="p">,</span>
  <span class="s2">&quot;step-before&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineStepBefore</span><span class="p">,</span>
  <span class="s2">&quot;step-after&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineStepAfter</span><span class="p">,</span>
  <span class="s2">&quot;basis&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineBasis</span><span class="p">,</span>
  <span class="s2">&quot;basis-open&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineBasisOpen</span><span class="p">,</span>
  <span class="s2">&quot;basis-closed&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineBasisClosed</span><span class="p">,</span>
  <span class="s2">&quot;bundle&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineBundle</span><span class="p">,</span>
  <span class="s2">&quot;cardinal&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineCardinal</span><span class="p">,</span>
  <span class="s2">&quot;cardinal-open&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineCardinalOpen</span><span class="p">,</span>
  <span class="s2">&quot;cardinal-closed&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineCardinalClosed</span><span class="p">,</span>
  <span class="s2">&quot;monotone&quot;</span><span class="o">:</span> <span class="nx">d3_svg_lineMonotone</span>
<span class="p">});</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>Linear interpolation; generates "L" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Step interpolation; generates "H" and "V" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineStepBefore</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">])[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>Step interpolation; generates "H" and "V" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineStepAfter</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">])[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Open cardinal spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineCardinalOpen</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span>
      <span class="o">?</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_lineHermite</span><span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
        <span class="nx">d3_svg_lineCardinalTangents</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Closed cardinal spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineCardinalClosed</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
      <span class="o">?</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_lineHermite</span><span class="p">((</span><span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">points</span><span class="p">),</span>
        <span class="nx">d3_svg_lineCardinalTangents</span><span class="p">([</span><span class="nx">points</span><span class="p">[</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]]</span>
        <span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="p">[</span><span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="nx">tension</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Cardinal spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineCardinal</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">,</span> <span class="nx">closed</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
      <span class="o">?</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_lineHermite</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span>
        <span class="nx">d3_svg_lineCardinalTangents</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Hermite spline construction; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineHermite</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tangents</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="o">||</span> <span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span>
      <span class="o">&amp;&amp;</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">quad</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
      <span class="nx">p0</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">t0</span> <span class="o">=</span> <span class="nx">tangents</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">t0</span><span class="p">,</span>
      <span class="nx">pi</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">quad</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;Q&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">p0</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="nx">tangents</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span>
    <span class="nx">pi</span><span class="o">++</span><span class="p">;</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">t0</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">t0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">tangents</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">,</span> <span class="nx">pi</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">tangents</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;S&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
          <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">quad</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lp</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">pi</span><span class="p">];</span>
    <span class="nx">path</span> <span class="o">+=</span> <span class="s2">&quot;Q&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">lp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">lp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Generates tangents for a cardinal spline.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineCardinalTangents</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tangents</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">tension</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">p0</span><span class="p">,</span>
      <span class="nx">p1</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">p2</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p0</span> <span class="o">=</span> <span class="nx">p1</span><span class="p">;</span>
    <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p2</span><span class="p">;</span>
    <span class="nx">p2</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">tangents</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">a</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">a</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">])]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">tangents</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>B-spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineBasis</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">x0</span> <span class="o">=</span> <span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">px</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">x0</span><span class="p">,</span> <span class="p">(</span><span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]],</span>
      <span class="nx">py</span> <span class="o">=</span> <span class="p">[</span><span class="nx">y0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
      <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x0</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">y0</span><span class="p">];</span>
  <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Open B-spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineBasisOpen</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="k">return</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">pi</span><span class="p">,</span>
      <span class="nx">px</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">py</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">px</span><span class="p">)</span>
    <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">py</span><span class="p">));</span>
  <span class="o">--</span><span class="nx">i</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Closed B-spline interpolation; generates "C" commands.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineBasisClosed</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">path</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
      <span class="nx">pi</span><span class="p">,</span>
      <span class="nx">px</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">py</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">];</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">px</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span>
    <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">py</span><span class="p">)</span>
  <span class="p">];</span>
  <span class="o">--</span><span class="nx">i</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">pi</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span> <span class="o">%</span> <span class="nx">n</span><span class="p">];</span>
    <span class="nx">px</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">px</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">py</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span> <span class="nx">py</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pi</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">px</span><span class="p">,</span> <span class="nx">py</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_lineBundle</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">tension</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">x0</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">,</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">n</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">y0</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">p</span><span class="p">,</span>
      <span class="nx">t</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">t</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="nx">n</span><span class="p">;</span>
    <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tension</span> <span class="o">*</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">tension</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">x0</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">);</span>
    <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tension</span> <span class="o">*</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">tension</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">y0</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">d3_svg_lineBasis</span><span class="p">(</span><span class="nx">points</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Returns the dot product of the given four-element vectors.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="nx">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Matrix to transform basis (b-spline) control points to bezier
control points. Derived from FvD 11.2.8.</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_svg_lineBasisBezier1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="nx">d3_svg_lineBasisBezier2</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
    <span class="nx">d3_svg_lineBasisBezier3</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>Pushes a "C" BÃ©zier curve onto the specified path array, given the
two specified four-element arrays which define the control points.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineBasisBezier</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
      <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier1</span><span class="p">,</span> <span class="nx">x</span><span class="p">),</span>
      <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier1</span><span class="p">,</span> <span class="nx">y</span><span class="p">),</span>
      <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier2</span><span class="p">,</span> <span class="nx">x</span><span class="p">),</span>
      <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier2</span><span class="p">,</span> <span class="nx">y</span><span class="p">),</span>
      <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">x</span><span class="p">),</span>
      <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="nx">d3_svg_lineDot4</span><span class="p">(</span><span class="nx">d3_svg_lineBasisBezier3</span><span class="p">,</span> <span class="nx">y</span><span class="p">));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Computes the slope from points p0 to p1.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineSlope</span><span class="p">(</span><span class="nx">p0</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="nx">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>Compute three-point differences for the given points.
http://en.wikipedia.org/wiki/Cubic<em>Hermite</em>spline#Finite_difference</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineFiniteDifferences</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">p0</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">p1</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_svg_lineSlope</span><span class="p">(</span><span class="nx">p0</span><span class="p">,</span> <span class="nx">p1</span><span class="p">);</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">=</span> <span class="nx">d3_svg_lineSlope</span><span class="p">(</span><span class="nx">p0</span> <span class="o">=</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">p1</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>
  <span class="p">}</span>
  <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">m</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Interpolates the given points using Fritsch-Carlson Monotone cubic Hermite
interpolation. Returns an array of tangent vectors. For details, see
http://en.wikipedia.org/wiki/Monotone<em>cubic</em>interpolation</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_svg_lineMonotoneTangents</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">tangents</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">d</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span>
      <span class="nx">b</span><span class="p">,</span>
      <span class="nx">s</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">d3_svg_lineFiniteDifferences</span><span class="p">(</span><span class="nx">points</span><span class="p">),</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>The first two steps are done by computing finite-differences:
1. Compute the slopes of the secant lines between successive points.
2. Initialize the tangents at every point as the average of the secants.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Then, for each segmentâ¦</p></td><td class="code"><div class="highlight"><pre>  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d</span> <span class="o">=</span> <span class="nx">d3_svg_lineSlope</span><span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><ol>
<li>If two successive yk = y{k + 1} are equal (i.e., d is zero), then set
mk = m{k + 1} = 0 as the spline connecting these points must be flat to
preserve monotonicity. Ignore step 4 and 5 for those k.</li>
</ol></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><ol>
<li>Let ak = mk / dk and bk = m{k + 1} / dk.</li>
</ol></td><td class="code"><div class="highlight"><pre>      <span class="nx">a</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nx">d</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><ol>
<li>Prevent overshoot and ensure monotonicity by restricting the
magnitude of vector <ak, bk> to a circle of radius 3.</li>
</ol></td><td class="code"><div class="highlight"><pre>      <span class="nx">s</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span> <span class="o">*</span> <span class="nx">b</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s</span> <span class="o">=</span> <span class="nx">d</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
        <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">*</span> <span class="nx">a</span><span class="p">;</span>
        <span class="nx">m</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">s</span> <span class="o">*</span> <span class="nx">b</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>Compute the normalized tangent vector from the slopes. Note that if x is
not monotonic, it's possible that the slope will be infinite, so we protect
against NaN by setting the coordinate to zero.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">s</span> <span class="o">=</span> <span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">points</span><span class="p">[</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="nx">tangents</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">s</span> <span class="o">||</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="nx">s</span> <span class="o">||</span> <span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">tangents</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_lineMonotone</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span>
      <span class="o">?</span> <span class="nx">d3_svg_lineLinear</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_lineHermite</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">d3_svg_lineMonotoneTangents</span><span class="p">(</span><span class="nx">points</span><span class="p">));</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">line</span><span class="p">.</span><span class="nx">radial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="nx">d3_svg_line</span><span class="p">(</span><span class="nx">d3_svg_lineRadial</span><span class="p">);</span>
  <span class="nx">line</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">line</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="nx">line</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">line</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">line</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_lineRadial</span><span class="p">(</span><span class="nx">points</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">point</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">r</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">point</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">r</span> <span class="o">=</span> <span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">a</span> <span class="o">=</span> <span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">;</span>
    <span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
    <span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">;</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">d3_svg_area</span><span class="p">(</span><span class="nx">projection</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">d3_svg_lineX</span><span class="p">,</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">d3_svg_lineX</span><span class="p">,</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">d3_svg_lineY</span><span class="p">,</span>
      <span class="nx">defined</span> <span class="o">=</span> <span class="nx">d3_true</span><span class="p">,</span>
      <span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolatorDefault</span><span class="p">,</span>
      <span class="nx">i0</span> <span class="o">=</span> <span class="nx">d3_svg_lineLinear</span><span class="p">,</span>
      <span class="nx">i1</span> <span class="o">=</span> <span class="nx">d3_svg_lineLinear</span><span class="p">,</span>
      <span class="nx">L</span> <span class="o">=</span> <span class="s2">&quot;L&quot;</span><span class="p">,</span>
      <span class="nx">tension</span> <span class="o">=</span> <span class="p">.</span><span class="mi">7</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">area</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">segments</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">points0</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">points1</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">d</span><span class="p">,</span>
        <span class="nx">fx0</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x0</span><span class="p">),</span>
        <span class="nx">fy0</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">y0</span><span class="p">),</span>
        <span class="nx">fx1</span> <span class="o">=</span> <span class="nx">x0</span> <span class="o">===</span> <span class="nx">x1</span> <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span>
        <span class="nx">fy1</span> <span class="o">=</span> <span class="nx">y0</span> <span class="o">===</span> <span class="nx">y1</span> <span class="o">?</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">y</span><span class="p">;</span> <span class="p">}</span> <span class="o">:</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">y1</span><span class="p">),</span>
        <span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">segment</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">segments</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="nx">i0</span><span class="p">(</span><span class="nx">projection</span><span class="p">(</span><span class="nx">points1</span><span class="p">),</span> <span class="nx">tension</span><span class="p">),</span>
          <span class="nx">L</span><span class="p">,</span> <span class="nx">i1</span><span class="p">(</span><span class="nx">projection</span><span class="p">(</span><span class="nx">points0</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()),</span> <span class="nx">tension</span><span class="p">),</span>
          <span class="s2">&quot;Z&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">defined</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">points0</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">x</span> <span class="o">=</span> <span class="o">+</span><span class="nx">fx0</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="nx">y</span> <span class="o">=</span> <span class="o">+</span><span class="nx">fy0</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)]);</span>
        <span class="nx">points1</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="o">+</span><span class="nx">fx1</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="o">+</span><span class="nx">fy1</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)]);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">points0</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">segment</span><span class="p">();</span>
        <span class="nx">points0</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">points1</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">points0</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">segment</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">segments</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x1</span><span class="p">;</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">x0</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x0</span><span class="p">;</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">x1</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x1</span><span class="p">;</span>
    <span class="nx">x1</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y1</span><span class="p">;</span>
    <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">y0</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y0</span><span class="p">;</span>
    <span class="nx">y0</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">y1</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y1</span><span class="p">;</span>
    <span class="nx">y1</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">defined</span>  <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">defined</span><span class="p">;</span>
    <span class="nx">defined</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">interpolate</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_svg_lineInterpolators</span><span class="p">.</span><span class="nx">has</span><span class="p">(</span><span class="nx">_</span> <span class="o">+=</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="nx">_</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolatorDefault</span><span class="p">;</span>
    <span class="nx">i0</span> <span class="o">=</span> <span class="nx">d3_svg_lineInterpolators</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">_</span><span class="p">);</span>
    <span class="nx">i1</span> <span class="o">=</span> <span class="nx">i0</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">||</span> <span class="nx">i0</span><span class="p">;</span>
    <span class="nx">L</span> <span class="o">=</span> <span class="sr">/-closed$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="o">?</span> <span class="s2">&quot;M&quot;</span> <span class="o">:</span> <span class="s2">&quot;L&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">area</span><span class="p">.</span><span class="nx">tension</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tension</span><span class="p">;</span>
    <span class="nx">tension</span> <span class="o">=</span> <span class="nx">_</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">d3_svg_lineStepBefore</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="nx">d3_svg_lineStepAfter</span><span class="p">;</span>
<span class="nx">d3_svg_lineStepAfter</span><span class="p">.</span><span class="nx">reverse</span> <span class="o">=</span> <span class="nx">d3_svg_lineStepBefore</span><span class="p">;</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_svg_area</span><span class="p">(</span><span class="nb">Object</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">radial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">area</span> <span class="o">=</span> <span class="nx">d3_svg_area</span><span class="p">(</span><span class="nx">d3_svg_lineRadial</span><span class="p">);</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">innerRadius</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x0</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x0</span><span class="p">;</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">outerRadius</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x1</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">x1</span><span class="p">;</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y0</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y0</span><span class="p">;</span>
  <span class="nx">area</span><span class="p">.</span><span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y1</span><span class="p">,</span> <span class="k">delete</span> <span class="nx">area</span><span class="p">.</span><span class="nx">y1</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">chord</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">d3_svg_chordSource</span><span class="p">,</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">d3_svg_chordTarget</span><span class="p">,</span>
      <span class="nx">radius</span> <span class="o">=</span> <span class="nx">d3_svg_chordRadius</span><span class="p">,</span>
      <span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">d3_svg_arcStartAngle</span><span class="p">,</span>
      <span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">d3_svg_arcEndAngle</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>TODO Allow control point to be customized.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">chord</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">subgroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nx">subgroup</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p0</span>
      <span class="o">+</span> <span class="nx">arc</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">a1</span> <span class="o">-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">a0</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">equals</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span>
      <span class="o">?</span> <span class="nx">curve</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p0</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">curve</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">p0</span><span class="p">)</span>
      <span class="o">+</span> <span class="nx">arc</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">a1</span> <span class="o">-</span> <span class="nx">t</span><span class="p">.</span><span class="nx">a0</span><span class="p">)</span>
      <span class="o">+</span> <span class="nx">curve</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">t</span><span class="p">.</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">p0</span><span class="p">))</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">subgroup</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subgroup</span> <span class="o">=</span> <span class="nx">f</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">r</span> <span class="o">=</span> <span class="nx">radius</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">a0</span> <span class="o">=</span> <span class="nx">startAngle</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">,</span>
        <span class="nx">a1</span> <span class="o">=</span> <span class="nx">endAngle</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span> <span class="nx">subgroup</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">r</span><span class="o">:</span> <span class="nx">r</span><span class="p">,</span>
      <span class="nx">a0</span><span class="o">:</span> <span class="nx">a0</span><span class="p">,</span>
      <span class="nx">a1</span><span class="o">:</span> <span class="nx">a1</span><span class="p">,</span>
      <span class="nx">p0</span><span class="o">:</span> <span class="p">[</span><span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a0</span><span class="p">),</span> <span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a0</span><span class="p">)],</span>
      <span class="nx">p1</span><span class="o">:</span> <span class="p">[</span><span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a1</span><span class="p">),</span> <span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a1</span><span class="p">)]</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">equals</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">a0</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">a0</span> <span class="o">&amp;&amp;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">a1</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">a1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">arc</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot; 0 &quot;</span> <span class="o">+</span> <span class="o">+</span><span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,1 &quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">curve</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nx">p0</span><span class="p">,</span> <span class="nx">r1</span><span class="p">,</span> <span class="nx">p1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;Q 0,0 &quot;</span> <span class="o">+</span> <span class="nx">p1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">radius</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">radius</span><span class="p">;</span>
    <span class="nx">radius</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">source</span><span class="p">;</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">startAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">startAngle</span><span class="p">;</span>
    <span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">endAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">endAngle</span><span class="p">;</span>
    <span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_chordSource</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_chordTarget</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_chordRadius</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">radius</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_chordStartAngle</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">startAngle</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_chordEndAngle</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">endAngle</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">diagonal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">d3_svg_chordSource</span><span class="p">,</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">d3_svg_chordTarget</span><span class="p">,</span>
      <span class="nx">projection</span> <span class="o">=</span> <span class="nx">d3_svg_diagonalProjection</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">diagonal</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p0</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">p3</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p0</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">p3</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="p">[</span><span class="nx">p0</span><span class="p">,</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">p0</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">m</span><span class="p">},</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">p3</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">m</span><span class="p">},</span> <span class="nx">p3</span><span class="p">];</span>
    <span class="nx">p</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">projection</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;C&quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">diagonal</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">source</span><span class="p">;</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">diagonal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">diagonal</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">diagonal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">diagonal</span><span class="p">.</span><span class="nx">projection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">projection</span><span class="p">;</span>
    <span class="nx">projection</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">diagonal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">diagonal</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_diagonalProjection</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">diagonal</span><span class="p">.</span><span class="nx">radial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">diagonal</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">diagonal</span><span class="p">(),</span>
      <span class="nx">projection</span> <span class="o">=</span> <span class="nx">d3_svg_diagonalProjection</span><span class="p">,</span>
      <span class="nx">projection_</span> <span class="o">=</span> <span class="nx">diagonal</span><span class="p">.</span><span class="nx">projection</span><span class="p">;</span>

  <span class="nx">diagonal</span><span class="p">.</span><span class="nx">projection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span>
        <span class="o">?</span> <span class="nx">projection_</span><span class="p">(</span><span class="nx">d3_svg_diagonalRadialProjection</span><span class="p">(</span><span class="nx">projection</span> <span class="o">=</span> <span class="nx">x</span><span class="p">))</span>
        <span class="o">:</span> <span class="nx">projection</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">diagonal</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_diagonalRadialProjection</span><span class="p">(</span><span class="nx">projection</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">projection</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">r</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">d3_svg_arcOffset</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span> <span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">a</span><span class="p">)];</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">mouse</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">touches</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">symbol</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">d3_svg_symbolType</span><span class="p">,</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="nx">d3_svg_symbolSize</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">symbol</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">d3_svg_symbols</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">type</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span>
        <span class="o">||</span> <span class="nx">d3_svg_symbolCircle</span><span class="p">)</span>
        <span class="p">(</span><span class="nx">size</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="nx">symbol</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">type</span><span class="p">;</span>
    <span class="nx">type</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">symbol</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>size of symbol in square pixels</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">symbol</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">symbol</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">symbol</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_symbolSize</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">64</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_symbolType</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">&quot;circle&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_symbolCircle</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">);</span>
  <span class="k">return</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="nx">r</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="nx">r</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;A&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="nx">r</span>
      <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>TODO cross-diagonal?</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_svg_symbols</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="s2">&quot;circle&quot;</span><span class="o">:</span> <span class="nx">d3_svg_symbolCircle</span><span class="p">,</span>
  <span class="s2">&quot;cross&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">&quot;diamond&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ry</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">d3_svg_symbolTan30</span><span class="p">)),</span>
        <span class="nx">rx</span> <span class="o">=</span> <span class="nx">ry</span> <span class="o">*</span> <span class="nx">d3_svg_symbolTan30</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot;L&quot;</span> <span class="o">+</span> <span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot;,0&quot;</span>
        <span class="o">+</span> <span class="s2">&quot; 0,&quot;</span> <span class="o">+</span> <span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot;,0&quot;</span>
        <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">&quot;square&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;L&quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">r</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">r</span>
        <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">&quot;triangle-down&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rx</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span> <span class="o">/</span> <span class="nx">d3_svg_symbolSqrt3</span><span class="p">),</span>
        <span class="nx">ry</span> <span class="o">=</span> <span class="nx">rx</span> <span class="o">*</span> <span class="nx">d3_svg_symbolSqrt3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot;L&quot;</span> <span class="o">+</span> <span class="nx">rx</span> <span class="o">+</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="s2">&quot;triangle-up&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">rx</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">size</span> <span class="o">/</span> <span class="nx">d3_svg_symbolSqrt3</span><span class="p">),</span>
        <span class="nx">ry</span> <span class="o">=</span> <span class="nx">rx</span> <span class="o">*</span> <span class="nx">d3_svg_symbolSqrt3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">return</span> <span class="s2">&quot;M0,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot;L&quot;</span> <span class="o">+</span> <span class="nx">rx</span> <span class="o">+</span><span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">rx</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">ry</span>
        <span class="o">+</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">symbolTypes</span> <span class="o">=</span> <span class="nx">d3_svg_symbols</span><span class="p">.</span><span class="nx">keys</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">d3_svg_symbolSqrt3</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="nx">d3_svg_symbolTan30</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span><span class="p">(</span><span class="mi">30</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">);</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span>
      <span class="nx">orient</span> <span class="o">=</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
      <span class="nx">tickMajorSize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
      <span class="nx">tickMinorSize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
      <span class="nx">tickEndSize</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
      <span class="nx">tickPadding</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
      <span class="nx">tickArguments_</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">],</span>
      <span class="nx">tickValues</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">tickFormat_</span><span class="p">,</span>
      <span class="nx">tickSubdivide</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">axis</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>Ticks, or domain values for ordinal scales.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">ticks</span> <span class="o">=</span> <span class="nx">tickValues</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">?</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">tickArguments_</span><span class="p">)</span> <span class="o">:</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">())</span> <span class="o">:</span> <span class="nx">tickValues</span><span class="p">,</span>
          <span class="nx">tickFormat</span> <span class="o">=</span> <span class="nx">tickFormat_</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">?</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">tickArguments_</span><span class="p">)</span> <span class="o">:</span> <span class="nb">String</span><span class="p">)</span> <span class="o">:</span> <span class="nx">tickFormat_</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Minor ticks.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">subticks</span> <span class="o">=</span> <span class="nx">d3_svg_axisSubdivide</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">ticks</span><span class="p">,</span> <span class="nx">tickSubdivide</span><span class="p">),</span>
          <span class="nx">subtick</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.minor&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">subticks</span><span class="p">,</span> <span class="nb">String</span><span class="p">),</span>
          <span class="nx">subtickEnter</span> <span class="o">=</span> <span class="nx">subtick</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">insert</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;tick minor&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">),</span>
          <span class="nx">subtickExit</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">subtick</span><span class="p">.</span><span class="nx">exit</span><span class="p">()).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">).</span><span class="nx">remove</span><span class="p">(),</span>
          <span class="nx">subtickUpdate</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">subtick</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Major ticks.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">tick</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">ticks</span><span class="p">,</span> <span class="nb">String</span><span class="p">),</span>
          <span class="nx">tickEnter</span> <span class="o">=</span> <span class="nx">tick</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">insert</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">),</span>
          <span class="nx">tickExit</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">tick</span><span class="p">.</span><span class="nx">exit</span><span class="p">()).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">6</span><span class="p">).</span><span class="nx">remove</span><span class="p">(),</span>
          <span class="nx">tickUpdate</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">tick</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;opacity&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
          <span class="nx">tickTransform</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Domain.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">d3_scaleRange</span><span class="p">(</span><span class="nx">scale</span><span class="p">),</span>
          <span class="nx">path</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.domain&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">pathEnter</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;domain&quot;</span><span class="p">),</span>
          <span class="nx">pathUpdate</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">transition</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Stash a snapshot of the new scale, and retrieve the old snapshot.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">scale1</span> <span class="o">=</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span>
          <span class="nx">scale0</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span> <span class="o">||</span> <span class="nx">scale1</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span> <span class="o">=</span> <span class="nx">scale1</span><span class="p">;</span>

      <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;tick&quot;</span><span class="p">);</span>
      <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">);</span>
      <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">tickFormat</span><span class="p">);</span>

      <span class="k">switch</span> <span class="p">(</span><span class="nx">orient</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s2">&quot;bottom&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">tickTransform</span> <span class="o">=</span> <span class="nx">d3_svg_axisX</span><span class="p">;</span>
          <span class="nx">subtickEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">subtickUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;.71em&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">);</span>
          <span class="nx">pathUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">tickEndSize</span> <span class="o">+</span> <span class="s2">&quot;V0H&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="nx">tickEndSize</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="s2">&quot;top&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">tickTransform</span> <span class="o">=</span> <span class="nx">d3_svg_axisX</span><span class="p">;</span>
          <span class="nx">subtickEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">subtickUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">));</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;0em&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">);</span>
          <span class="nx">pathUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">tickEndSize</span> <span class="o">+</span> <span class="s2">&quot;V0H&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;V&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">tickEndSize</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="s2">&quot;left&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">tickTransform</span> <span class="o">=</span> <span class="nx">d3_svg_axisY</span><span class="p">;</span>
          <span class="nx">subtickEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">subtickUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMinorSize</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">));</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="o">-</span><span class="nx">tickMajorSize</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;.32em&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">);</span>
          <span class="nx">pathUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">tickEndSize</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;H0V&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="o">-</span><span class="nx">tickEndSize</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="s2">&quot;right&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="nx">tickTransform</span> <span class="o">=</span> <span class="nx">d3_svg_axisY</span><span class="p">;</span>
          <span class="nx">subtickEnter</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nx">tickMinorSize</span><span class="p">);</span>
          <span class="nx">subtickUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nx">tickMinorSize</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nx">tickMajorSize</span><span class="p">);</span>
          <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nx">tickMajorSize</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
          <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;text&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">tickMajorSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">tickPadding</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;.32em&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">);</span>
          <span class="nx">pathUpdate</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">tickEndSize</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;H0V&quot;</span> <span class="o">+</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;H&quot;</span> <span class="o">+</span> <span class="nx">tickEndSize</span><span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>For quantitative scales:
- enter new ticks from the old scale
- exit old ticks to the new scale</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale0</span><span class="p">);</span>
        <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale1</span><span class="p">);</span>
        <span class="nx">tickExit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale1</span><span class="p">);</span>
        <span class="nx">subtickEnter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale0</span><span class="p">);</span>
        <span class="nx">subtickUpdate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale1</span><span class="p">);</span>
        <span class="nx">subtickExit</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">scale1</span><span class="p">);</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>For ordinal scales:
- any entering ticks are undefined in the old scale
- any exiting ticks are undefined in the new scale
Therefore, we only need to transition updating ticks.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">scale1</span><span class="p">.</span><span class="nx">rangeBand</span><span class="p">()</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">scale1</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="nx">dx</span><span class="p">;</span> <span class="p">};</span>
        <span class="nx">tickEnter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
        <span class="nx">tickUpdate</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">tickTransform</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">orient</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">orient</span><span class="p">;</span>
    <span class="nx">orient</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickArguments_</span><span class="p">;</span>
    <span class="nx">tickArguments_</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">tickValues</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickValues</span><span class="p">;</span>
    <span class="nx">tickValues</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickFormat_</span><span class="p">;</span>
    <span class="nx">tickFormat_</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">tickSize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickMajorSize</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">tickMajorSize</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">tickMinorSize</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">+</span><span class="nx">y</span> <span class="o">:</span> <span class="nx">tickMajorSize</span><span class="p">;</span>
    <span class="nx">tickEndSize</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">+</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">n</span><span class="p">]</span> <span class="o">:</span> <span class="nx">tickMajorSize</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">tickPadding</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickPadding</span><span class="p">;</span>
    <span class="nx">tickPadding</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">axis</span><span class="p">.</span><span class="nx">tickSubdivide</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">tickSubdivide</span><span class="p">;</span>
    <span class="nx">tickSubdivide</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">axis</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_svg_axisX</span><span class="p">(</span><span class="nx">selection</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">x</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;,0)&quot;</span><span class="p">;</span> <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_axisY</span><span class="p">(</span><span class="nx">selection</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">selection</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="nx">y</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span> <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_svg_axisSubdivide</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">ticks</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">subticks</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&amp;&amp;</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="nx">d3_scaleExtent</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">()),</span>
        <span class="nx">subticks</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">ticks</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="nx">ticks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">ticks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="o">++</span><span class="nx">m</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">v</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">m</span><span class="p">;</span> <span class="o">--</span><span class="nx">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">v</span> <span class="o">=</span> <span class="o">+</span><span class="nx">ticks</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">d</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">subticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="o">--</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">v</span> <span class="o">=</span> <span class="o">+</span><span class="nx">ticks</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="nx">j</span> <span class="o">*</span> <span class="nx">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">];)</span> <span class="p">{</span>
      <span class="nx">subticks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">subticks</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">brush</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">d3_eventDispatch</span><span class="p">(</span><span class="nx">brush</span><span class="p">,</span> <span class="s2">&quot;brushstart&quot;</span><span class="p">,</span> <span class="s2">&quot;brush&quot;</span><span class="p">,</span> <span class="s2">&quot;brushend&quot;</span><span class="p">),</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// x-scale, optional</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// y-scale, optional</span>
      <span class="nx">resizes</span> <span class="o">=</span> <span class="nx">d3_svg_brushResizes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">extent</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="c1">// [x0, y0], [x1, y1], in pixels (integers)</span>
      <span class="nx">extentDomain</span><span class="p">;</span> <span class="c1">// the extent in data space, lazily created</span>

  <span class="kd">function</span> <span class="nx">brush</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
          <span class="nx">bg</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.background&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">fg</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.extent&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">([</span><span class="mi">0</span><span class="p">]),</span>
          <span class="nx">tz</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.resize&quot;</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="nx">resizes</span><span class="p">,</span> <span class="nb">String</span><span class="p">),</span>
          <span class="nx">e</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>Prepare the brush container for events.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">g</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousedown.brush&quot;</span><span class="p">,</span> <span class="nx">brushstart</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchstart.brush&quot;</span><span class="p">,</span> <span class="nx">brushstart</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>An invisible, mouseable area for starting a new brush.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">bg</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;visibility&quot;</span><span class="p">,</span> <span class="s2">&quot;hidden&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="s2">&quot;crosshair&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>The visible brush extent; style this as you like!</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">fg</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;extent&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="s2">&quot;move&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>More invisible rects for resizing the extent.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">tz</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;resize &quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">;</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_svg_brushCursor</span><span class="p">[</span><span class="nx">d</span><span class="p">];</span> <span class="p">})</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="sr">/[ew]$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">3</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="sr">/^[ns]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">3</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;visibility&quot;</span><span class="p">,</span> <span class="s2">&quot;hidden&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>Show or hide the resizers.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">tz</span><span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="nx">brush</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;none&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>Remove any superfluous resizers.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">tz</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">remove</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Initialize the background to fill the defined range.
If the range isn't defined, you can post-process.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">d3_scaleRange</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
        <span class="nx">bg</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">redrawX</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">d3_scaleRange</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
        <span class="nx">bg</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="nx">redrawY</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">redraw</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">redraw</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.resize&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">[</span><span class="o">+</span><span class="sr">/e$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">[</span><span class="o">+</span><span class="sr">/^s/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">d</span><span class="p">)][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">redrawX</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.extent&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.extent,.n&gt;rect,.s&gt;rect&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">redrawY</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.extent&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.extent,.e&gt;rect,.w&gt;rect&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">brushstart</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">eventTarget</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">),</span>
        <span class="nx">event_</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">g</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nx">target</span><span class="p">),</span>
        <span class="nx">resizing</span> <span class="o">=</span> <span class="nx">eventTarget</span><span class="p">.</span><span class="nx">datum</span><span class="p">(),</span>
        <span class="nx">resizingX</span> <span class="o">=</span> <span class="o">!</span><span class="sr">/^(n|s)$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">resizing</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">x</span><span class="p">,</span>
        <span class="nx">resizingY</span> <span class="o">=</span> <span class="o">!</span><span class="sr">/^(e|w)$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">resizing</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span><span class="p">,</span>
        <span class="nx">dragging</span> <span class="o">=</span> <span class="nx">eventTarget</span><span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;extent&quot;</span><span class="p">),</span>
        <span class="nx">center</span><span class="p">,</span>
        <span class="nx">origin</span> <span class="o">=</span> <span class="nx">mouse</span><span class="p">(),</span>
        <span class="nx">offset</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.brush&quot;</span><span class="p">,</span> <span class="nx">brushmove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.brush&quot;</span><span class="p">,</span> <span class="nx">brushend</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchmove.brush&quot;</span><span class="p">,</span> <span class="nx">brushmove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchend.brush&quot;</span><span class="p">,</span> <span class="nx">brushend</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keydown.brush&quot;</span><span class="p">,</span> <span class="nx">keydown</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keyup.brush&quot;</span><span class="p">,</span> <span class="nx">keyup</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>If the extent was clicked on, drag rather than brush;
store the point between the mouse and extent origin instead.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>If a resizer was clicked on, record which side is to be resized.
Also, set the origin to the opposite side.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">resizing</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">ex</span> <span class="o">=</span> <span class="o">+</span><span class="sr">/w$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">resizing</span><span class="p">),</span>
          <span class="nx">ey</span> <span class="o">=</span> <span class="o">+</span><span class="sr">/^n/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">resizing</span><span class="p">);</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="p">[</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">ex</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="nx">ey</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
      <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="nx">ex</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="nx">ey</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>If the ALT key is down when starting a brush, the center is at the mouse.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="nx">center</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>Propagate the active cursor to the body for the drag duration.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">g</span><span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.resize&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="nx">eventTarget</span><span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>Notify listeners.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;brushstart&quot;</span><span class="p">});</span>
    <span class="nx">brushmove</span><span class="p">();</span>
    <span class="nx">d3_eventCancel</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">mouse</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">touches</span> <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">touches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="nx">target</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">keydown</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">center</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
          <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
          <span class="nx">dragging</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">d3_eventCancel</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">keyup</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span> <span class="nx">dragging</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">dragging</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">d3_eventCancel</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">brushmove</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="nx">mouse</span><span class="p">(),</span>
          <span class="nx">moved</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Preserve the offset for thick resizers.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>If needed, determine the center from the current extent.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">altKey</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">center</span><span class="p">)</span> <span class="nx">center</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>Update the origin, for when the ALT key is released.</p></td><td class="code"><div class="highlight"><pre>          <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="o">+</span><span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">];</span>
          <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="o">+</span><span class="p">(</span><span class="nx">point</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">1</span><span class="p">];</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>When the ALT key is released, we clear the center.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">else</span> <span class="nx">center</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>Update the brush extent for each dimension.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">resizingX</span> <span class="o">&amp;&amp;</span> <span class="nx">move1</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">redrawX</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
        <span class="nx">moved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">resizingY</span> <span class="o">&amp;&amp;</span> <span class="nx">move1</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">redrawY</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
        <span class="nx">moved</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>Final redraw and notify listeners.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">moved</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">redraw</span><span class="p">(</span><span class="nx">g</span><span class="p">);</span>
        <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;brush&quot;</span><span class="p">,</span> <span class="nx">mode</span><span class="o">:</span> <span class="nx">dragging</span> <span class="o">?</span> <span class="s2">&quot;move&quot;</span> <span class="o">:</span> <span class="s2">&quot;resize&quot;</span><span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">move1</span><span class="p">(</span><span class="nx">point</span><span class="p">,</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">d3_scaleRange</span><span class="p">(</span><span class="nx">scale</span><span class="p">),</span>
          <span class="nx">r0</span> <span class="o">=</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">r1</span> <span class="o">=</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
          <span class="nx">position</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
          <span class="nx">size</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">i</span><span class="p">],</span>
          <span class="nx">min</span><span class="p">,</span>
          <span class="nx">max</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>When dragging, reduce the range by the extent size and position.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r0</span> <span class="o">-=</span> <span class="nx">position</span><span class="p">;</span>
        <span class="nx">r1</span> <span class="o">-=</span> <span class="nx">size</span> <span class="o">+</span> <span class="nx">position</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>Clamp the point so that the extent fits within the range extent.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">min</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">r1</span><span class="p">,</span> <span class="nx">point</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>Compute the new extent bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="p">(</span><span class="nx">min</span> <span class="o">+=</span> <span class="nx">position</span><span class="p">)</span> <span class="o">+</span> <span class="nx">size</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>If the ALT key is pressed, then preserve the center of the extent.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">center</span><span class="p">)</span> <span class="nx">position</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">r0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">r1</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">center</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="nx">min</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Compute the min and max of the position and point.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">position</span> <span class="o">&lt;</span> <span class="nx">min</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">min</span><span class="p">;</span>
          <span class="nx">min</span> <span class="o">=</span> <span class="nx">position</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">max</span> <span class="o">=</span> <span class="nx">position</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Update the stored bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">min</span> <span class="o">||</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">extentDomain</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">min</span><span class="p">;</span>
        <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">max</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">brushend</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">brushmove</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>reset the cursor styles</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">g</span><span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;pointer-events&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;.resize&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="nx">brush</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span> <span class="o">?</span> <span class="s2">&quot;none&quot;</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
      <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;cursor&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

      <span class="nx">w</span> <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchmove.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchend.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keydown.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;keyup.brush&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

      <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;brushend&quot;</span><span class="p">});</span>
      <span class="nx">d3_eventCancel</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">brush</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="nx">resizes</span> <span class="o">=</span> <span class="nx">d3_svg_brushResizes</span><span class="p">[</span><span class="o">!</span><span class="nx">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="o">!</span><span class="nx">y</span><span class="p">];</span> <span class="c1">// fore!</span>
    <span class="k">return</span> <span class="nx">brush</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">brush</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="nx">resizes</span> <span class="o">=</span> <span class="nx">d3_svg_brushResizes</span><span class="p">[</span><span class="o">!</span><span class="nx">x</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="o">!</span><span class="nx">y</span><span class="p">];</span> <span class="c1">// fore!</span>
    <span class="k">return</span> <span class="nx">brush</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">brush</span><span class="p">.</span><span class="nx">extent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>Invert the pixel extent to data-space.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">z</span> <span class="o">=</span> <span class="nx">extentDomain</span> <span class="o">||</span> <span class="nx">extent</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">x0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">extentDomain</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">x0</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">invert</span><span class="p">)</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">x0</span><span class="p">),</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">x1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">x0</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">extentDomain</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">y0</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">invert</span><span class="p">)</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">y0</span><span class="p">),</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">y1</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">&lt;</span> <span class="nx">y0</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">y</span> <span class="o">?</span> <span class="p">[[</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">y0</span><span class="p">],</span> <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">]]</span> <span class="o">:</span> <span class="nx">x</span> <span class="o">?</span> <span class="p">[</span><span class="nx">x0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="p">[</span><span class="nx">y0</span><span class="p">,</span> <span class="nx">y1</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>Scale the data-space extent to pixels.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">extentDomain</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">extentDomain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">extentDomain</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">invert</span><span class="p">)</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">(</span><span class="nx">x0</span><span class="p">),</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">x</span><span class="p">(</span><span class="nx">x1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">&lt;</span> <span class="nx">x0</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">x0</span><span class="p">,</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x0</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">extentDomain</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">extentDomain</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y</span><span class="p">.</span><span class="nx">invert</span><span class="p">)</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y</span><span class="p">(</span><span class="nx">y0</span><span class="p">),</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">y</span><span class="p">(</span><span class="nx">y1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">&lt;</span> <span class="nx">y0</span><span class="p">)</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">y0</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
      <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y0</span> <span class="o">|</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">|</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">brush</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">brush</span><span class="p">.</span><span class="nx">clear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">extentDomain</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
    <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
    <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
    <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">brush</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">brush</span><span class="p">.</span><span class="nx">empty</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&amp;&amp;</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">===</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="o">||</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">brush</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_svg_brushCursor</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">n</span><span class="o">:</span> <span class="s2">&quot;ns-resize&quot;</span><span class="p">,</span>
  <span class="nx">e</span><span class="o">:</span> <span class="s2">&quot;ew-resize&quot;</span><span class="p">,</span>
  <span class="nx">s</span><span class="o">:</span> <span class="s2">&quot;ns-resize&quot;</span><span class="p">,</span>
  <span class="nx">w</span><span class="o">:</span> <span class="s2">&quot;ew-resize&quot;</span><span class="p">,</span>
  <span class="nx">nw</span><span class="o">:</span> <span class="s2">&quot;nwse-resize&quot;</span><span class="p">,</span>
  <span class="nx">ne</span><span class="o">:</span> <span class="s2">&quot;nesw-resize&quot;</span><span class="p">,</span>
  <span class="nx">se</span><span class="o">:</span> <span class="s2">&quot;nwse-resize&quot;</span><span class="p">,</span>
  <span class="nx">sw</span><span class="o">:</span> <span class="s2">&quot;nesw-resize&quot;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_svg_brushResizes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="s2">&quot;nw&quot;</span><span class="p">,</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;sw&quot;</span><span class="p">],</span>
  <span class="p">[</span><span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">],</span>
  <span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">],</span>
  <span class="p">[]</span>
<span class="p">];</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">behavior</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>TODO Track touch points by identifier.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">behavior</span><span class="p">.</span><span class="nx">drag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">event</span> <span class="o">=</span> <span class="nx">d3_eventDispatch</span><span class="p">(</span><span class="nx">drag</span><span class="p">,</span> <span class="s2">&quot;drag&quot;</span><span class="p">,</span> <span class="s2">&quot;dragstart&quot;</span><span class="p">,</span> <span class="s2">&quot;dragend&quot;</span><span class="p">),</span>
      <span class="nx">origin</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">drag</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousedown.drag&quot;</span><span class="p">,</span> <span class="nx">mousedown</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchstart.drag&quot;</span><span class="p">,</span> <span class="nx">mousedown</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mousedown</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">event_</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">eventTarget</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
        <span class="nx">offset</span><span class="p">,</span>
        <span class="nx">origin_</span> <span class="o">=</span> <span class="nx">point</span><span class="p">(),</span>
        <span class="nx">moved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nb">window</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.drag&quot;</span><span class="p">,</span> <span class="nx">dragmove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchmove.drag&quot;</span><span class="p">,</span> <span class="nx">dragmove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.drag&quot;</span><span class="p">,</span> <span class="nx">dragend</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchend.drag&quot;</span><span class="p">,</span> <span class="nx">dragend</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">origin</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="p">[</span><span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">origin_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">origin_</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">d3_eventCancel</span><span class="p">();</span>
    <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;dragstart&quot;</span><span class="p">});</span>

    <span class="kd">function</span> <span class="nx">point</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span>
          <span class="nx">t</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">changedTouches</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">t</span> <span class="o">?</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">t</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">dragmove</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">)</span> <span class="k">return</span> <span class="nx">dragend</span><span class="p">();</span> <span class="c1">// target removed from DOM</span>

      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">point</span><span class="p">(),</span>
          <span class="nx">dx</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">dy</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">origin_</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

      <span class="nx">moved</span> <span class="o">|=</span> <span class="nx">dx</span> <span class="o">|</span> <span class="nx">dy</span><span class="p">;</span>
      <span class="nx">origin_</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
      <span class="nx">d3_eventCancel</span><span class="p">();</span>

      <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;drag&quot;</span><span class="p">,</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">dx</span><span class="o">:</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="o">:</span> <span class="nx">dy</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">dragend</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">event_</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;dragend&quot;</span><span class="p">});</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>if moved, prevent the mouseup (and possibly click) from propagating</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">moved</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d3_eventCancel</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">eventTarget</span><span class="p">)</span> <span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click.drag&quot;</span><span class="p">,</span> <span class="nx">click</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="nx">w</span> <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.drag&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchmove.drag&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.drag&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchend.drag&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>prevent the subsequent click from propagating (e.g., for anchors)</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">click</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">d3_eventCancel</span><span class="p">();</span>
      <span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click.drag&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">drag</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">origin</span><span class="p">;</span>
    <span class="nx">origin</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">drag</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">drag</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">behavior</span><span class="p">.</span><span class="nx">zoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="nx">translate0</span><span class="p">,</span> <span class="c1">// translate when we started zooming (to avoid drift)</span>
      <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">scale0</span><span class="p">,</span> <span class="c1">// scale when we started touching</span>
      <span class="nx">scaleExtent</span> <span class="o">=</span> <span class="nx">d3_behavior_zoomInfinity</span><span class="p">,</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nx">d3_eventDispatch</span><span class="p">(</span><span class="nx">zoom</span><span class="p">,</span> <span class="s2">&quot;zoom&quot;</span><span class="p">),</span>
      <span class="nx">x0</span><span class="p">,</span>
      <span class="nx">x1</span><span class="p">,</span>
      <span class="nx">y0</span><span class="p">,</span>
      <span class="nx">y1</span><span class="p">,</span>
      <span class="nx">touchtime</span><span class="p">;</span> <span class="c1">// time of last touchstart (to detect double-tap)</span>

  <span class="kd">function</span> <span class="nx">zoom</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousedown.zoom&quot;</span><span class="p">,</span> <span class="nx">mousedown</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousewheel.zoom&quot;</span><span class="p">,</span> <span class="nx">mousewheel</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.zoom&quot;</span><span class="p">,</span> <span class="nx">mousemove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;DOMMouseScroll.zoom&quot;</span><span class="p">,</span> <span class="nx">mousewheel</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;dblclick.zoom&quot;</span><span class="p">,</span> <span class="nx">dblclick</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchstart.zoom&quot;</span><span class="p">,</span> <span class="nx">touchstart</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchmove.zoom&quot;</span><span class="p">,</span> <span class="nx">touchmove</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;touchend.zoom&quot;</span><span class="p">,</span> <span class="nx">touchstart</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">zoom</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Number</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">zoom</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">zoom</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">zoom</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">zoom</span><span class="p">.</span><span class="nx">scaleExtent</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scaleExtent</span><span class="p">;</span>
    <span class="nx">scaleExtent</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">d3_behavior_zoomInfinity</span> <span class="o">:</span> <span class="nx">x</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nb">Number</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">zoom</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">zoom</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x1</span><span class="p">;</span>
    <span class="nx">x1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">zoom</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">zoom</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y1</span><span class="p">;</span>
    <span class="nx">y1</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="nx">y0</span> <span class="o">=</span> <span class="nx">z</span><span class="p">.</span><span class="nx">copy</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">zoom</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">location</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">point</span><span class="p">(</span><span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">scale</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">scale</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">scaleTo</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">scaleExtent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">scaleExtent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">s</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">translateTo</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">l</span> <span class="o">=</span> <span class="nx">point</span><span class="p">(</span><span class="nx">l</span><span class="p">);</span>
    <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x1</span><span class="p">)</span> <span class="nx">x1</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">x0</span><span class="p">.</span><span class="nx">range</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">;</span> <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="nx">x0</span><span class="p">.</span><span class="nx">invert</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span><span class="p">)</span> <span class="nx">y1</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">y0</span><span class="p">.</span><span class="nx">range</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">;</span> <span class="p">}).</span><span class="nx">map</span><span class="p">(</span><span class="nx">y0</span><span class="p">.</span><span class="nx">invert</span><span class="p">));</span>
    <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">event</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;zoom&quot;</span><span class="p">,</span> <span class="nx">scale</span><span class="o">:</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">translate</span><span class="o">:</span> <span class="nx">translate</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mousedown</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">event_</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">),</span>
        <span class="nx">eventTarget</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
        <span class="nx">moved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">w</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.zoom&quot;</span><span class="p">,</span> <span class="nx">mousemove</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.zoom&quot;</span><span class="p">,</span> <span class="nx">mouseup</span><span class="p">),</span>
        <span class="nx">l</span> <span class="o">=</span> <span class="nx">location</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="nx">target</span><span class="p">));</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">focus</span><span class="p">();</span>
    <span class="nx">d3_eventCancel</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">mousemove</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">moved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">translateTo</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="nx">target</span><span class="p">),</span> <span class="nx">l</span><span class="p">);</span>
      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event_</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">mouseup</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">moved</span><span class="p">)</span> <span class="nx">d3_eventCancel</span><span class="p">();</span>
      <span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mousemove.zoom&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseup.zoom&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">moved</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span> <span class="o">===</span> <span class="nx">eventTarget</span><span class="p">)</span> <span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click.zoom&quot;</span><span class="p">,</span> <span class="nx">click</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">click</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">d3_eventCancel</span><span class="p">();</span>
      <span class="nx">w</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click.zoom&quot;</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mousewheel</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">translate0</span><span class="p">)</span> <span class="nx">translate0</span> <span class="o">=</span> <span class="nx">location</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="k">this</span><span class="p">));</span>
    <span class="nx">scaleTo</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">d3_behavior_zoomDelta</span><span class="p">()</span> <span class="o">*</span> <span class="p">.</span><span class="mi">002</span><span class="p">)</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">);</span>
    <span class="nx">translateTo</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">translate0</span><span class="p">);</span>
    <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">mousemove</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">translate0</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">dblclick</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">mouse</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">location</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
    <span class="nx">scaleTo</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="o">?</span> <span class="nx">scale</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">:</span> <span class="nx">scale</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
    <span class="nx">translateTo</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
    <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">touchstart</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

    <span class="nx">scale0</span> <span class="o">=</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">translate0</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">touches</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span> <span class="nx">translate0</span><span class="p">[</span><span class="nx">t</span><span class="p">.</span><span class="nx">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="nx">location</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span> <span class="p">});</span>
    <span class="nx">d3_eventCancel</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">touches</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">touchtime</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// dbltap</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">l</span> <span class="o">=</span> <span class="nx">location</span><span class="p">(</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="nx">scaleTo</span><span class="p">(</span><span class="nx">scale</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
      <span class="nx">translateTo</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">l</span><span class="p">);</span>
      <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="nx">touchtime</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">touchmove</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">touches</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">touches</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
        <span class="nx">p0</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">l0</span> <span class="o">=</span> <span class="nx">translate0</span><span class="p">[</span><span class="nx">p0</span><span class="p">.</span><span class="nx">identifier</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">p1</span> <span class="o">=</span> <span class="nx">touches</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">p1</span><span class="p">,</span> <span class="nx">l1</span> <span class="o">=</span> <span class="nx">translate0</span><span class="p">[</span><span class="nx">p1</span><span class="p">.</span><span class="nx">identifier</span><span class="p">];</span>
      <span class="nx">p0</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">p0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">p1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">p0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">p1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">l0</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">l0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">l1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="nx">l0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">l1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
      <span class="nx">scaleTo</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">scale</span> <span class="o">*</span> <span class="nx">scale0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">translateTo</span><span class="p">(</span><span class="nx">p0</span><span class="p">,</span> <span class="nx">l0</span><span class="p">);</span>
    <span class="nx">dispatch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">of</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">zoom</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_behavior_zoomDiv</span><span class="p">,</span> <span class="c1">// for interpreting mousewheel events</span>
    <span class="nx">d3_behavior_zoomInfinity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">];</span> <span class="c1">// default scale extent</span>

<span class="kd">function</span> <span class="nx">d3_behavior_zoomDelta</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>mousewheel events are totally broken!
https://bugs.webkit.org/show_bug.cgi?id=40441
not only that, but Chrome and Safari differ in re. to acceleration!</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_behavior_zoomDiv</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_behavior_zoomDiv</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;visibility&quot;</span><span class="p">,</span> <span class="s2">&quot;hidden&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;overflow-y&quot;</span><span class="p">,</span> <span class="s2">&quot;scroll&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;2000px&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">node</span><span class="p">().</span><span class="nx">parentNode</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">,</span> <span class="nx">delta</span><span class="p">;</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">d3_behavior_zoomDiv</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="nx">d3_behavior_zoomDiv</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="nx">delta</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">-</span> <span class="nx">d3_behavior_zoomDiv</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">delta</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">wheelDelta</span> <span class="o">||</span> <span class="p">(</span><span class="o">-</span><span class="nx">e</span><span class="p">.</span><span class="nx">detail</span> <span class="o">*</span> <span class="mi">5</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">delta</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>Implements hierarchical edge bundling using Holten's algorithm. For each
input link, a path is computed that travels through the tree, up the parent
hierarchy to the least common ancestor, and then back down to the destination
node. Each path is simply an array of nodes.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">bundle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">links</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">paths</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_layout_bundlePath</span><span class="p">(</span><span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="k">return</span> <span class="nx">paths</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_bundlePath</span><span class="p">(</span><span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">source</span><span class="p">,</span>
      <span class="nx">end</span> <span class="o">=</span> <span class="nx">link</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
      <span class="nx">lca</span> <span class="o">=</span> <span class="nx">d3_layout_bundleLeastCommonAncestor</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span> <span class="nx">end</span><span class="p">),</span>
      <span class="nx">points</span> <span class="o">=</span> <span class="p">[</span><span class="nx">start</span><span class="p">];</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">start</span> <span class="o">!==</span> <span class="nx">lca</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">start</span> <span class="o">=</span> <span class="nx">start</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
    <span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">start</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">end</span> <span class="o">!==</span> <span class="nx">lca</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">points</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">end</span><span class="p">);</span>
    <span class="nx">end</span> <span class="o">=</span> <span class="nx">end</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">points</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_bundleAncestors</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ancestors</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">parent</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ancestors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="nx">node</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">;</span>
    <span class="nx">parent</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">.</span><span class="nx">parent</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">ancestors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">ancestors</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_bundleLeastCommonAncestor</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="nx">b</span><span class="p">)</span> <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">aNodes</span> <span class="o">=</span> <span class="nx">d3_layout_bundleAncestors</span><span class="p">(</span><span class="nx">a</span><span class="p">),</span>
      <span class="nx">bNodes</span> <span class="o">=</span> <span class="nx">d3_layout_bundleAncestors</span><span class="p">(</span><span class="nx">b</span><span class="p">),</span>
      <span class="nx">aNode</span> <span class="o">=</span> <span class="nx">aNodes</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
      <span class="nx">bNode</span> <span class="o">=</span> <span class="nx">bNodes</span><span class="p">.</span><span class="nx">pop</span><span class="p">(),</span>
      <span class="nx">sharedNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">aNode</span> <span class="o">===</span> <span class="nx">bNode</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sharedNode</span> <span class="o">=</span> <span class="nx">aNode</span><span class="p">;</span>
    <span class="nx">aNode</span> <span class="o">=</span> <span class="nx">aNodes</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="nx">bNode</span> <span class="o">=</span> <span class="nx">bNodes</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">sharedNode</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">chord</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">chord</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">chords</span><span class="p">,</span>
      <span class="nx">groups</span><span class="p">,</span>
      <span class="nx">matrix</span><span class="p">,</span>
      <span class="nx">n</span><span class="p">,</span>
      <span class="nx">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">sortGroups</span><span class="p">,</span>
      <span class="nx">sortSubgroups</span><span class="p">,</span>
      <span class="nx">sortChords</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">relayout</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">subgroups</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">groupSums</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">groupIndex</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">n</span><span class="p">),</span>
        <span class="nx">subgroupIndex</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">k</span><span class="p">,</span>
        <span class="nx">x</span><span class="p">,</span>
        <span class="nx">x0</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">;</span>

    <span class="nx">chords</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">groups</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>Compute the sum.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="o">+=</span> <span class="nx">matrix</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">groupSums</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
      <span class="nx">subgroupIndex</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">n</span><span class="p">));</span>
      <span class="nx">k</span> <span class="o">+=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>Sort groupsâ¦</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">sortGroups</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">groupIndex</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">sortGroups</span><span class="p">(</span><span class="nx">groupSums</span><span class="p">[</span><span class="nx">a</span><span class="p">],</span> <span class="nx">groupSums</span><span class="p">[</span><span class="nx">b</span><span class="p">]);</span>
      <span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Sort subgroupsâ¦</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">sortSubgroups</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">subgroupIndex</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">sortSubgroups</span><span class="p">(</span><span class="nx">matrix</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">a</span><span class="p">],</span> <span class="nx">matrix</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">b</span><span class="p">]);</span>
        <span class="p">});</span>
      <span class="p">});</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>Convert the sum to scaling factor for [0, 2pi].
TODO Allow start and end angle to be specified.
TODO Allow padding to be specified as percentage?</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">k</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">-</span> <span class="nx">padding</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="nx">k</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>Compute the start and end angle for each group and subgroup.
Note: Opera has a bug reordering object literal properties!</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">di</span> <span class="o">=</span> <span class="nx">groupIndex</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
            <span class="nx">dj</span> <span class="o">=</span> <span class="nx">subgroupIndex</span><span class="p">[</span><span class="nx">di</span><span class="p">][</span><span class="nx">j</span><span class="p">],</span>
            <span class="nx">v</span> <span class="o">=</span> <span class="nx">matrix</span><span class="p">[</span><span class="nx">di</span><span class="p">][</span><span class="nx">dj</span><span class="p">],</span>
            <span class="nx">a0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">,</span>
            <span class="nx">a1</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+=</span> <span class="nx">v</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
        <span class="nx">subgroups</span><span class="p">[</span><span class="nx">di</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">dj</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">index</span><span class="o">:</span> <span class="nx">di</span><span class="p">,</span>
          <span class="nx">subindex</span><span class="o">:</span> <span class="nx">dj</span><span class="p">,</span>
          <span class="nx">startAngle</span><span class="o">:</span> <span class="nx">a0</span><span class="p">,</span>
          <span class="nx">endAngle</span><span class="o">:</span> <span class="nx">a1</span><span class="p">,</span>
          <span class="nx">value</span><span class="o">:</span> <span class="nx">v</span>
        <span class="p">};</span>
      <span class="p">}</span>
      <span class="nx">groups</span><span class="p">[</span><span class="nx">di</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">index</span><span class="o">:</span> <span class="nx">di</span><span class="p">,</span>
        <span class="nx">startAngle</span><span class="o">:</span> <span class="nx">x0</span><span class="p">,</span>
        <span class="nx">endAngle</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span>
        <span class="nx">value</span><span class="o">:</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">k</span>
      <span class="p">};</span>
      <span class="nx">x</span> <span class="o">+=</span> <span class="nx">padding</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>Generate chords for each (non-empty) subgroup-subgroup link.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">subgroups</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">j</span><span class="p">],</span>
            <span class="nx">target</span> <span class="o">=</span> <span class="nx">subgroups</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span> <span class="o">||</span> <span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">chords</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span> <span class="o">&lt;</span> <span class="nx">target</span><span class="p">.</span><span class="nx">value</span>
              <span class="o">?</span> <span class="p">{</span><span class="nx">source</span><span class="o">:</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">source</span><span class="p">}</span>
              <span class="o">:</span> <span class="p">{</span><span class="nx">source</span><span class="o">:</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">target</span><span class="p">});</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sortChords</span><span class="p">)</span> <span class="nx">resort</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">resort</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">chords</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">sortChords</span><span class="p">(</span>
          <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="nx">a</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
          <span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">matrix</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">matrix</span><span class="p">;</span>
    <span class="nx">n</span> <span class="o">=</span> <span class="p">(</span><span class="nx">matrix</span> <span class="o">=</span> <span class="nx">x</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">matrix</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="nx">chords</span> <span class="o">=</span> <span class="nx">groups</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">padding</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">padding</span><span class="p">;</span>
    <span class="nx">padding</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">chords</span> <span class="o">=</span> <span class="nx">groups</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">sortGroups</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sortGroups</span><span class="p">;</span>
    <span class="nx">sortGroups</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">chords</span> <span class="o">=</span> <span class="nx">groups</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">sortSubgroups</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sortSubgroups</span><span class="p">;</span>
    <span class="nx">sortSubgroups</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">chords</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">sortChords</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sortChords</span><span class="p">;</span>
    <span class="nx">sortChords</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">chords</span><span class="p">)</span> <span class="nx">resort</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">chords</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">chords</span><span class="p">)</span> <span class="nx">relayout</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">chords</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">chord</span><span class="p">.</span><span class="nx">groups</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">groups</span><span class="p">)</span> <span class="nx">relayout</span><span class="p">();</span>
    <span class="k">return</span> <span class="nx">groups</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">chord</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>A rudimentary force layout using Gauss-Seidel.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">force</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">force</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">event</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;tick&quot;</span><span class="p">,</span> <span class="s2">&quot;end&quot;</span><span class="p">),</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="nx">drag</span><span class="p">,</span>
      <span class="nx">alpha</span><span class="p">,</span>
      <span class="nx">friction</span> <span class="o">=</span> <span class="p">.</span><span class="mi">9</span><span class="p">,</span>
      <span class="nx">linkDistance</span> <span class="o">=</span> <span class="nx">d3_layout_forceLinkDistance</span><span class="p">,</span>
      <span class="nx">linkStrength</span> <span class="o">=</span> <span class="nx">d3_layout_forceLinkStrength</span><span class="p">,</span>
      <span class="nx">charge</span> <span class="o">=</span> <span class="o">-</span><span class="mi">30</span><span class="p">,</span>
      <span class="nx">gravity</span> <span class="o">=</span> <span class="p">.</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">theta</span> <span class="o">=</span> <span class="p">.</span><span class="mi">8</span><span class="p">,</span>
      <span class="nx">interval</span><span class="p">,</span>
      <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">links</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">distances</span><span class="p">,</span>
      <span class="nx">strengths</span><span class="p">,</span>
      <span class="nx">charges</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">repulse</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">quad</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">point</span> <span class="o">!==</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">cx</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
            <span class="nx">dy</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">cy</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
            <span class="nx">dn</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">);</span>

        <span class="cm">/* Barnes-Hut criterion. */</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">x2</span> <span class="o">-</span> <span class="nx">x1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">dn</span> <span class="o">&lt;</span> <span class="nx">theta</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span> <span class="o">*</span> <span class="nx">dn</span> <span class="o">*</span> <span class="nx">dn</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">px</span> <span class="o">-=</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">py</span> <span class="o">-=</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">point</span> <span class="o">&amp;&amp;</span> <span class="nb">isFinite</span><span class="p">(</span><span class="nx">dn</span><span class="p">))</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">pointCharge</span> <span class="o">*</span> <span class="nx">dn</span> <span class="o">*</span> <span class="nx">dn</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">px</span> <span class="o">-=</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
          <span class="nx">node</span><span class="p">.</span><span class="nx">py</span> <span class="o">-=</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">tick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>simulated annealing, basically</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">((</span><span class="nx">alpha</span> <span class="o">*=</span> <span class="p">.</span><span class="mi">99</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">005</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">end</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;end&quot;</span><span class="p">,</span> <span class="nx">alpha</span><span class="o">:</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">});</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">q</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span> <span class="c1">// current index</span>
        <span class="nx">o</span><span class="p">,</span> <span class="c1">// current object</span>
        <span class="nx">s</span><span class="p">,</span> <span class="c1">// current source</span>
        <span class="nx">t</span><span class="p">,</span> <span class="c1">// current target</span>
        <span class="nx">l</span><span class="p">,</span> <span class="c1">// current distance</span>
        <span class="nx">k</span><span class="p">,</span> <span class="c1">// current force</span>
        <span class="nx">x</span><span class="p">,</span> <span class="c1">// x-distance</span>
        <span class="nx">y</span><span class="p">;</span> <span class="c1">// y-distance</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>gauss-seidel relaxation for links</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">o</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">s</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">t</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">l</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">l</span> <span class="o">=</span> <span class="nx">alpha</span> <span class="o">*</span> <span class="nx">strengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="nx">l</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">l</span><span class="p">))</span> <span class="o">-</span> <span class="nx">distances</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span> <span class="o">/</span> <span class="nx">l</span><span class="p">;</span>
        <span class="nx">x</span> <span class="o">*=</span> <span class="nx">l</span><span class="p">;</span>
        <span class="nx">y</span> <span class="o">*=</span> <span class="nx">l</span><span class="p">;</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">x</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">weight</span> <span class="o">/</span> <span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">weight</span> <span class="o">+</span> <span class="nx">s</span><span class="p">.</span><span class="nx">weight</span><span class="p">));</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">x</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">k</span><span class="p">);</span>
        <span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>apply gravity forces</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="nx">alpha</span> <span class="o">*</span> <span class="nx">gravity</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">k</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>compute quadtree center of mass and apply charge forces</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">charge</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d3_layout_forceAccumulate</span><span class="p">(</span><span class="nx">q</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">quadtree</span><span class="p">(</span><span class="nx">nodes</span><span class="p">),</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">charges</span><span class="p">);</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">fixed</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">q</span><span class="p">.</span><span class="nx">visit</span><span class="p">(</span><span class="nx">repulse</span><span class="p">(</span><span class="nx">o</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>position verlet integration</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">o</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">fixed</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">px</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">py</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">px</span> <span class="o">-</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">px</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span> <span class="o">*</span> <span class="nx">friction</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">py</span> <span class="o">-</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">py</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="o">*</span> <span class="nx">friction</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">tick</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;tick&quot;</span><span class="p">,</span> <span class="nx">alpha</span><span class="o">:</span> <span class="nx">alpha</span><span class="p">});</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
    <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">links</span><span class="p">;</span>
    <span class="nx">links</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">linkDistance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linkDistance</span><span class="p">;</span>
    <span class="nx">linkDistance</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>For backwards-compatibility.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">force</span><span class="p">.</span><span class="nx">distance</span> <span class="o">=</span> <span class="nx">force</span><span class="p">.</span><span class="nx">linkDistance</span><span class="p">;</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">linkStrength</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linkStrength</span><span class="p">;</span>
    <span class="nx">linkStrength</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">friction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">friction</span><span class="p">;</span>
    <span class="nx">friction</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">charge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">charge</span><span class="p">;</span>
    <span class="nx">charge</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">:</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">gravity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">gravity</span><span class="p">;</span>
    <span class="nx">gravity</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">theta</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">theta</span><span class="p">;</span>
    <span class="nx">theta</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">alpha</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">alpha</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">alpha</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// if we&#39;re already running</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span> <span class="c1">// we might keep it hot</span>
      <span class="k">else</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// or, next tick will dispatch &quot;end&quot;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// otherwise, fire it up!</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">start</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="nx">alpha</span><span class="o">:</span> <span class="nx">alpha</span> <span class="o">=</span> <span class="nx">x</span><span class="p">});</span>
      <span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">(</span><span class="nx">force</span><span class="p">.</span><span class="nx">tick</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">w</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">neighbors</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">index</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">weight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">distances</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">strengths</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">o</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">o</span><span class="p">.</span><span class="nx">source</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">o</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">source</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">o</span><span class="p">.</span><span class="nx">target</span> <span class="o">==</span> <span class="s2">&quot;number&quot;</span><span class="p">)</span> <span class="nx">o</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">target</span><span class="p">];</span>
      <span class="nx">distances</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">linkDistance</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="nx">strengths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">linkStrength</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
      <span class="o">++</span><span class="nx">o</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">weight</span><span class="p">;</span>
      <span class="o">++</span><span class="nx">o</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">weight</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">o</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">position</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">w</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">position</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">px</span><span class="p">))</span> <span class="nx">o</span><span class="p">.</span><span class="nx">px</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">py</span><span class="p">))</span> <span class="nx">o</span><span class="p">.</span><span class="nx">py</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">charges</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">charge</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">charges</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">+</span><span class="nx">charge</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">i</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">charges</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">charge</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>initialize node position based on first neighbor</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">position</span><span class="p">(</span><span class="nx">dimension</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">neighbors</span> <span class="o">=</span> <span class="nx">neighbor</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span>
          <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">m</span> <span class="o">=</span> <span class="nx">neighbors</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">x</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">neighbors</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="nx">dimension</span><span class="p">]))</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">size</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>initialize neighbors lazily</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">function</span> <span class="nx">neighbor</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">neighbors</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">neighbors</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">neighbors</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">links</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="nx">neighbors</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">source</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">target</span><span class="p">);</span>
          <span class="nx">neighbors</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">source</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">neighbors</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">force</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">resume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">.</span><span class="nx">alpha</span><span class="p">(.</span><span class="mi">1</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">force</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">force</span><span class="p">.</span><span class="nx">alpha</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>use <code>node.call(force.drag)</code> to make nodes draggable</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">force</span><span class="p">.</span><span class="nx">drag</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">drag</span><span class="p">)</span> <span class="nx">drag</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">behavior</span><span class="p">.</span><span class="nx">drag</span><span class="p">()</span>
        <span class="p">.</span><span class="nx">origin</span><span class="p">(</span><span class="nx">d3_identity</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;dragstart&quot;</span><span class="p">,</span> <span class="nx">dragstart</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;drag&quot;</span><span class="p">,</span> <span class="nx">d3_layout_forceDrag</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;dragend&quot;</span><span class="p">,</span> <span class="nx">d3_layout_forceDragEnd</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseover.force&quot;</span><span class="p">,</span> <span class="nx">d3_layout_forceDragOver</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;mouseout.force&quot;</span><span class="p">,</span> <span class="nx">d3_layout_forceDragOut</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">drag</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">dragstart</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_layout_forceDragOver</span><span class="p">(</span><span class="nx">d3_layout_forceDragNode</span> <span class="o">=</span> <span class="nx">d</span><span class="p">);</span>
    <span class="nx">d3_layout_forceDragForce</span> <span class="o">=</span> <span class="nx">force</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">force</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="s2">&quot;on&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_layout_forceDragForce</span><span class="p">,</span>
    <span class="nx">d3_layout_forceDragNode</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceDragOver</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceDragOut</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">d</span> <span class="o">!==</span> <span class="nx">d3_layout_forceDragNode</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceDragEnd</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">d3_layout_forceDragNode</span><span class="p">.</span><span class="nx">fixed</span> <span class="o">&amp;=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nx">d3_layout_forceDragForce</span> <span class="o">=</span> <span class="nx">d3_layout_forceDragNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceDrag</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">d3_layout_forceDragNode</span><span class="p">.</span><span class="nx">px</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="nx">d3_layout_forceDragNode</span><span class="p">.</span><span class="nx">py</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="nx">d3_layout_forceDragForce</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span> <span class="c1">// restart annealing</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceAccumulate</span><span class="p">(</span><span class="nx">quad</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">charges</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">cx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">cy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quad</span><span class="p">.</span><span class="nx">leaf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">nodes</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">c</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
      <span class="nx">d3_layout_forceAccumulate</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">alpha</span><span class="p">,</span> <span class="nx">charges</span><span class="p">);</span>
      <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charge</span><span class="p">;</span>
      <span class="nx">cx</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charge</span> <span class="o">*</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cx</span><span class="p">;</span>
      <span class="nx">cy</span> <span class="o">+=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">charge</span> <span class="o">*</span> <span class="nx">c</span><span class="p">.</span><span class="nx">cy</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>jitter internal nodes that are coincident</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">quad</span><span class="p">.</span><span class="nx">leaf</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span>
      <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">-</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">alpha</span> <span class="o">*</span> <span class="nx">charges</span><span class="p">[</span><span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">index</span><span class="p">];</span>
    <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span> <span class="o">+=</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">pointCharge</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="nx">cx</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">cy</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">quad</span><span class="p">.</span><span class="nx">cx</span> <span class="o">=</span> <span class="nx">cx</span> <span class="o">/</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span><span class="p">;</span>
  <span class="nx">quad</span><span class="p">.</span><span class="nx">cy</span> <span class="o">=</span> <span class="nx">cy</span> <span class="o">/</span> <span class="nx">quad</span><span class="p">.</span><span class="nx">charge</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceLinkDistance</span><span class="p">(</span><span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">20</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_forceLinkStrength</span><span class="p">(</span><span class="nx">link</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">partition</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hierarchy</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span><span class="p">(),</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// width, height</span>

  <span class="kd">function</span> <span class="nx">position</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">depth</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">dx</span> <span class="o">=</span> <span class="nx">dx</span><span class="p">;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">dy</span> <span class="o">=</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">n</span><span class="p">,</span>
          <span class="nx">c</span><span class="p">,</span>
          <span class="nx">d</span><span class="p">;</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">?</span> <span class="nx">dx</span> <span class="o">/</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">position</span><span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">value</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="p">);</span>
        <span class="nx">x</span> <span class="o">+=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">depth</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">n</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">d</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">depth</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">d</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">partition</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
    <span class="nx">position</span><span class="p">(</span><span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nx">depth</span><span class="p">(</span><span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">partition</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">partition</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">partition</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">pie</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">,</span>
      <span class="nx">sort</span> <span class="o">=</span> <span class="nx">d3_layout_pieSortByValue</span><span class="p">,</span>
      <span class="nx">startAngle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">endAngle</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">pie</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>Compute the numeric values for each data element.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">pie</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span> <span class="p">});</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>Compute the start angle.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="o">+</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">startAngle</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="nx">startAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">startAngle</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>Compute the angular scale factor: from value to radians.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">k</span> <span class="o">=</span> <span class="p">((</span><span class="k">typeof</span> <span class="nx">endAngle</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span>
        <span class="o">?</span> <span class="nx">endAngle</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">endAngle</span><span class="p">)</span> <span class="o">-</span> <span class="nx">startAngle</span><span class="p">)</span>
        <span class="o">/</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">values</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>Optionally sort the data.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">index</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sort</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="nx">index</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span> <span class="o">===</span> <span class="nx">d3_layout_pieSortByValue</span>
        <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">values</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">-</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span> <span class="p">}</span>
        <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">sort</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">data</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span> <span class="p">});</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>Compute the arcs!
They are stored in the original data's order.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">arcs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">index</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">d</span><span class="p">;</span>
      <span class="nx">arcs</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">value</span><span class="o">:</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">startAngle</span><span class="o">:</span> <span class="nx">a</span><span class="p">,</span>
        <span class="nx">endAngle</span><span class="o">:</span> <span class="nx">a</span> <span class="o">+=</span> <span class="nx">d</span> <span class="o">*</span> <span class="nx">k</span>
      <span class="p">};</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">arcs</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="cm">/**</span>
<span class="cm">   * Specifies the value function *x*, which returns a nonnegative numeric value</span>
<span class="cm">   * for each datum. The default value function is `Number`. The value function</span>
<span class="cm">   * is passed two arguments: the current datum and the current index.</span>
<span class="cm">   */</span>
  <span class="nx">pie</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pie</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Specifies a sort comparison operator *x*. The comparator is passed two data</span>
<span class="cm">   * elements from the data array, a and b; it returns a negative value if a is</span>
<span class="cm">   * less than b, a positive value if a is greater than b, and zero if a equals</span>
<span class="cm">   * b.</span>
<span class="cm">   */</span>
  <span class="nx">pie</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sort</span><span class="p">;</span>
    <span class="nx">sort</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pie</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Specifies the overall start angle of the pie chart. Defaults to 0. The</span>
<span class="cm">   * start angle can be specified either as a constant or as a function; in the</span>
<span class="cm">   * case of a function, it is evaluated once per array (as opposed to per</span>
<span class="cm">   * element).</span>
<span class="cm">   */</span>
  <span class="nx">pie</span><span class="p">.</span><span class="nx">startAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">startAngle</span><span class="p">;</span>
    <span class="nx">startAngle</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pie</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="cm">/**</span>
<span class="cm">   * Specifies the overall end angle of the pie chart. Defaults to 2Ï. The</span>
<span class="cm">   * end angle can be specified either as a constant or as a function; in the</span>
<span class="cm">   * case of a function, it is evaluated once per array (as opposed to per</span>
<span class="cm">   * element).</span>
<span class="cm">   */</span>
  <span class="nx">pie</span><span class="p">.</span><span class="nx">endAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">endAngle</span><span class="p">;</span>
    <span class="nx">endAngle</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pie</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">pie</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_layout_pieSortByValue</span> <span class="o">=</span> <span class="p">{};</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>data is two-dimensional array of x,y; we populate y0</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">stack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">d3_identity</span><span class="p">,</span>
      <span class="nx">order</span> <span class="o">=</span> <span class="nx">d3_layout_stackOrderDefault</span><span class="p">,</span>
      <span class="nx">offset</span> <span class="o">=</span> <span class="nx">d3_layout_stackOffsetZero</span><span class="p">,</span>
      <span class="nx">out</span> <span class="o">=</span> <span class="nx">d3_layout_stackOut</span><span class="p">,</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">d3_layout_stackX</span><span class="p">,</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">d3_layout_stackY</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">stack</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">index</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>Convert series to canonical two-dimensional representation.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">series</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">values</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
    <span class="p">});</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>Convert each series to canonical [[x,y]] representation.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">points</span> <span class="o">=</span> <span class="nx">series</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">x</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span> <span class="nx">y</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)];</span>
      <span class="p">});</span>
    <span class="p">});</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>Compute the order of series, and permute them.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">orders</span> <span class="o">=</span> <span class="nx">order</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">points</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span>
    <span class="nx">series</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">permute</span><span class="p">(</span><span class="nx">series</span><span class="p">,</span> <span class="nx">orders</span><span class="p">);</span>
    <span class="nx">points</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">permute</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">orders</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>Compute the baselineâ¦</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">offsets</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">points</span><span class="p">,</span> <span class="nx">index</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>And propagate it to other series.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">series</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">series</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">out</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">series</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">j</span><span class="p">],</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">offsets</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">stack</span><span class="p">,</span> <span class="nx">series</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">],</span> <span class="nx">o</span> <span class="o">+=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]);</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">data</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">values</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">values</span><span class="p">;</span>
    <span class="nx">values</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">order</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">order</span><span class="p">;</span>
    <span class="nx">order</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">:</span> <span class="nx">d3_layout_stackOrders</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d3_layout_stackOrderDefault</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">offset</span><span class="p">;</span>
    <span class="nx">offset</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">:</span> <span class="nx">d3_layout_stackOffsets</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nx">d3_layout_stackOffsetZero</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">stack</span><span class="p">.</span><span class="nx">out</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
    <span class="nx">out</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">stack</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackX</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackY</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackOut</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">y0</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">y0</span> <span class="o">=</span> <span class="nx">y0</span><span class="p">;</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_layout_stackOrders</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>

  <span class="s2">&quot;inside-out&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_layout_stackMaxIndex</span><span class="p">),</span>
        <span class="nx">sums</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_layout_stackReduceSum</span><span class="p">),</span>
        <span class="nx">index</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">n</span><span class="p">).</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">max</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span> <span class="o">-</span> <span class="nx">max</span><span class="p">[</span><span class="nx">b</span><span class="p">];</span> <span class="p">}),</span>
        <span class="nx">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">bottom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">tops</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">bottoms</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">index</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">top</span> <span class="o">&lt;</span> <span class="nx">bottom</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">top</span> <span class="o">+=</span> <span class="nx">sums</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="nx">tops</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">bottom</span> <span class="o">+=</span> <span class="nx">sums</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="nx">bottoms</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">bottoms</span><span class="p">.</span><span class="nx">reverse</span><span class="p">().</span><span class="nx">concat</span><span class="p">(</span><span class="nx">tops</span><span class="p">);</span>
  <span class="p">},</span>

  <span class="s2">&quot;reverse&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">reverse</span><span class="p">();</span>
  <span class="p">},</span>

  <span class="s2">&quot;default&quot;</span><span class="o">:</span> <span class="nx">d3_layout_stackOrderDefault</span>

<span class="p">});</span>

<span class="kd">var</span> <span class="nx">d3_layout_stackOffsets</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>

  <span class="s2">&quot;silhouette&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">sums</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">,</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">o</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span> <span class="o">&gt;</span> <span class="nx">max</span><span class="p">)</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
      <span class="nx">sums</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">y0</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nx">max</span> <span class="o">-</span> <span class="nx">sums</span><span class="p">[</span><span class="nx">j</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">y0</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="s2">&quot;wiggle&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">k</span><span class="p">,</span>
        <span class="nx">s1</span><span class="p">,</span>
        <span class="nx">s2</span><span class="p">,</span>
        <span class="nx">s3</span><span class="p">,</span>
        <span class="nx">dx</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">,</span>
        <span class="nx">o0</span><span class="p">,</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">y0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">o0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="nx">s1</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">x</span><span class="p">[</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s3</span> <span class="o">=</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">);</span> <span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">i</span><span class="p">;</span> <span class="o">++</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">s3</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">data</span><span class="p">[</span><span class="nx">k</span><span class="p">][</span><span class="nx">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">dx</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">s2</span> <span class="o">+=</span> <span class="nx">s3</span> <span class="o">*</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="nx">y0</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="nx">o</span> <span class="o">-=</span> <span class="nx">s1</span> <span class="o">?</span> <span class="nx">s2</span> <span class="o">/</span> <span class="nx">s1</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span> <span class="o">&lt;</span> <span class="nx">o0</span><span class="p">)</span> <span class="nx">o0</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">y0</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">-=</span> <span class="nx">o0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">y0</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="s2">&quot;expand&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">n</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">,</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">o</span> <span class="o">+=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="nx">o</span><span class="p">;</span>
      <span class="k">else</span> <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="nx">y0</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">y0</span><span class="p">;</span>
  <span class="p">},</span>

  <span class="s2">&quot;zero&quot;</span><span class="o">:</span> <span class="nx">d3_layout_stackOffsetZero</span>

<span class="p">});</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackOrderDefault</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackOffsetZero</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="nx">y0</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">y0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackMaxIndex</span><span class="p">(</span><span class="nx">array</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">k</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">k</span> <span class="o">=</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">k</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackReduceSum</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">d3_layout_stackSum</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_stackSum</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">histogram</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">frequency</span> <span class="o">=</span> <span class="kc">true</span><span class="p">,</span>
      <span class="nx">valuer</span> <span class="o">=</span> <span class="nb">Number</span><span class="p">,</span>
      <span class="nx">ranger</span> <span class="o">=</span> <span class="nx">d3_layout_histogramRange</span><span class="p">,</span>
      <span class="nx">binner</span> <span class="o">=</span> <span class="nx">d3_layout_histogramBinSturges</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">histogram</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">bins</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">values</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">valuer</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
        <span class="nx">range</span> <span class="o">=</span> <span class="nx">ranger</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">thresholds</span> <span class="o">=</span> <span class="nx">binner</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">range</span><span class="p">,</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">bin</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">thresholds</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="nx">frequency</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">n</span><span class="p">,</span>
        <span class="nx">x</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>Initialize the bins.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">bin</span> <span class="o">=</span> <span class="nx">bins</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">bin</span><span class="p">.</span><span class="nx">dx</span> <span class="o">=</span> <span class="nx">thresholds</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="nx">bin</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">thresholds</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="nx">bin</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>Fill the bins, ignoring values outside the range.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
          <span class="nx">bin</span> <span class="o">=</span> <span class="nx">bins</span><span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">thresholds</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
          <span class="nx">bin</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">k</span><span class="p">;</span>
          <span class="nx">bin</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">bins</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>Specifies how to extract a value from the associated data. The default
value function is <code>Number</code>, which is equivalent to the identity function.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">histogram</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">valuer</span><span class="p">;</span>
    <span class="nx">valuer</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">histogram</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>Specifies the range of the histogram. Values outside the specified range
will be ignored. The argument <code>x</code> may be specified either as a two-element
array representing the minimum and maximum value of the range, or as a
function that returns the range given the array of values and the current
index <code>i</code>. The default range is the extent (minimum and maximum) of the
values.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">histogram</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">ranger</span><span class="p">;</span>
    <span class="nx">ranger</span> <span class="o">=</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">histogram</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>Specifies how to bin values in the histogram. The argument <code>x</code> may be
specified as a number, in which case the range of values will be split
uniformly into the given number of bins. Or, <code>x</code> may be an array of
threshold values, defining the bins; the specified array must contain the
rightmost (upper) value, thus specifying n + 1 values for n bins. Or, <code>x</code>
may be a function which is evaluated, being passed the range, the array of
values, and the current index <code>i</code>, returning an array of thresholds. The
default bin function will divide the values into uniform bins using
Sturges' formula.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">histogram</span><span class="p">.</span><span class="nx">bins</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">binner</span><span class="p">;</span>
    <span class="nx">binner</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span>
        <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">range</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_layout_histogramBinFixed</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span> <span class="p">}</span>
        <span class="o">:</span> <span class="nx">d3_functor</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">histogram</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>Specifies whether the histogram's <code>y</code> value is a count (frequency) or a
probability (density). The default value is true.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">histogram</span><span class="p">.</span><span class="nx">frequency</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">frequency</span><span class="p">;</span>
    <span class="nx">frequency</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">histogram</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">histogram</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_histogramBinSturges</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_layout_histogramBinFixed</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">LN2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_histogramBinFixed</span><span class="p">(</span><span class="nx">range</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="o">+</span><span class="nx">range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="nx">n</span><span class="p">,</span>
      <span class="nx">f</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">x</span> <span class="o">&lt;=</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">f</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">m</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">f</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_histogramRange</span><span class="p">(</span><span class="nx">values</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">values</span><span class="p">),</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">values</span><span class="p">)];</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">sort</span> <span class="o">=</span> <span class="nx">d3_layout_hierarchySort</span><span class="p">,</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="nx">d3_layout_hierarchyChildren</span><span class="p">,</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">d3_layout_hierarchyValue</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>Recursively compute the node depth and value.
Also converts the data representation into a standard hierarchy structure.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">recurse</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">childs</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">hierarchy</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">depth</span><span class="p">),</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">d3_layout_hierarchyInline</span> <span class="o">?</span> <span class="nx">data</span> <span class="o">:</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">};</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">depth</span> <span class="o">=</span> <span class="nx">depth</span><span class="p">;</span>
    <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">childs</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">childs</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">n</span><span class="p">,</span>
          <span class="nx">c</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">j</span> <span class="o">=</span> <span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">d</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="nx">recurse</span><span class="p">(</span><span class="nx">childs</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">nodes</span><span class="p">);</span>
        <span class="nx">d</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
        <span class="nx">v</span> <span class="o">+=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sort</span><span class="p">)</span> <span class="nx">c</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="nx">sort</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">hierarchy</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>Recursively re-evaluates the node value.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">revalue</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
        <span class="nx">v</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">n</span><span class="p">,</span>
          <span class="nx">j</span> <span class="o">=</span> <span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">v</span> <span class="o">+=</span> <span class="nx">revalue</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">j</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="o">+</span><span class="nx">value</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">hierarchy</span><span class="p">,</span> <span class="nx">d3_layout_hierarchyInline</span> <span class="o">?</span> <span class="nx">node</span> <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">v</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">hierarchy</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="nx">recurse</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">nodes</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">sort</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sort</span><span class="p">;</span>
    <span class="nx">sort</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">hierarchy</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">children</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">children</span><span class="p">;</span>
    <span class="nx">children</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">hierarchy</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">value</span><span class="p">;</span>
    <span class="nx">value</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">hierarchy</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>Re-evaluates the <code>value</code> property for the specified hierarchy.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">revalue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">revalue</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">root</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">hierarchy</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>A method assignment helper for hierarchy subclasses.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">,</span> <span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="s2">&quot;children&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>Add an alias for links, for convenience.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">object</span><span class="p">.</span><span class="nx">links</span> <span class="o">=</span> <span class="nx">d3_layout_hierarchyLinks</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>If the new API is used, enabling inlining.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">object</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_layout_hierarchyInline</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">nodes</span> <span class="o">=</span> <span class="nx">object</span><span class="p">)(</span><span class="nx">d</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_hierarchyChildren</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_hierarchyValue</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_hierarchySort</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">value</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>Returns an array source+target objects for the specified nodes.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_layout_hierarchyLinks</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">nodes</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">parent</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span> <span class="o">||</span> <span class="p">[]).</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span><span class="nx">source</span><span class="o">:</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">target</span><span class="o">:</span> <span class="nx">child</span><span class="p">};</span>
    <span class="p">});</span>
  <span class="p">}));</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>For backwards-compatibility, don't enable inlining by default.</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_layout_hierarchyInline</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">pack</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hierarchy</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="nx">d3_layout_packSort</span><span class="p">),</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span>

  <span class="kd">function</span> <span class="nx">pack</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>Recursively compute the layout.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">root</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">d3_layout_packTree</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>Scale the layout to fit the requested size.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">h</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">root</span><span class="p">.</span><span class="nx">r</span> <span class="o">/</span> <span class="nx">w</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">root</span><span class="p">.</span><span class="nx">r</span> <span class="o">/</span> <span class="nx">h</span><span class="p">);</span>
    <span class="nx">d3_layout_packTransform</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">k</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">pack</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">pack</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">pack</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_packSort</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">value</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packInsert</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_next</span><span class="p">;</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_next</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="nx">b</span><span class="p">.</span><span class="nx">_pack_prev</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
  <span class="nx">b</span><span class="p">.</span><span class="nx">_pack_next</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">_pack_prev</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packSplice</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_next</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
  <span class="nx">b</span><span class="p">.</span><span class="nx">_pack_prev</span> <span class="o">=</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packIntersects</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
      <span class="nx">dr</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">dr</span> <span class="o">*</span> <span class="nx">dr</span> <span class="o">-</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">-</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">&gt;</span> <span class="p">.</span><span class="mi">001</span><span class="p">;</span> <span class="c1">// within epsilon</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packCircle</span><span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">xMin</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">xMax</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">yMin</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">yMax</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">k</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">bound</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">xMin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">xMin</span><span class="p">);</span>
    <span class="nx">xMax</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">xMax</span><span class="p">);</span>
    <span class="nx">yMin</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">node</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">yMin</span><span class="p">);</span>
    <span class="nx">yMax</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span> <span class="nx">yMax</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><p>Create node links.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d3_layout_packLink</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>Create first node.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">a</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="o">-</span><span class="nx">a</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
  <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">bound</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-176"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-176">&#182;</a></div><p>Create second node.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">b</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">bound</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-177"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-177">&#182;</a></div><p>Create third node and build chain.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="nx">d3_layout_packPlace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span>
      <span class="nx">bound</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
      <span class="nx">d3_layout_packInsert</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_prev</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">d3_layout_packInsert</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_next</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-178"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-178">&#182;</a></div><p>Now iterate through the rest.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d3_layout_packPlace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-179"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-179">&#182;</a></div><p>Search for the closest intersection.</p></td><td class="code"><div class="highlight"><pre>        <span class="kd">var</span> <span class="nx">isect</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">s1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">s2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">_pack_next</span><span class="p">;</span> <span class="nx">j</span> <span class="o">!==</span> <span class="nx">b</span><span class="p">;</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">j</span><span class="p">.</span><span class="nx">_pack_next</span><span class="p">,</span> <span class="nx">s1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">d3_layout_packIntersects</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">c</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">isect</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isect</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">k</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">_pack_prev</span><span class="p">;</span> <span class="nx">k</span> <span class="o">!==</span> <span class="nx">j</span><span class="p">.</span><span class="nx">_pack_prev</span><span class="p">;</span> <span class="nx">k</span> <span class="o">=</span> <span class="nx">k</span><span class="p">.</span><span class="nx">_pack_prev</span><span class="p">,</span> <span class="nx">s2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">d3_layout_packIntersects</span><span class="p">(</span><span class="nx">k</span><span class="p">,</span> <span class="nx">c</span><span class="p">))</span> <span class="p">{</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div></td></tr>


<tr id="section-180"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-180">&#182;</a></div><p>Update node chain.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">isect</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">s1</span> <span class="o">&lt;</span> <span class="nx">s2</span> <span class="o">||</span> <span class="p">(</span><span class="nx">s1</span> <span class="o">==</span> <span class="nx">s2</span> <span class="o">&amp;&amp;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">r</span><span class="p">))</span> <span class="nx">d3_layout_packSplice</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">j</span><span class="p">);</span>
          <span class="k">else</span> <span class="nx">d3_layout_packSplice</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">b</span><span class="p">);</span>
          <span class="nx">i</span><span class="o">--</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">d3_layout_packInsert</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">c</span><span class="p">);</span>
          <span class="nx">b</span> <span class="o">=</span> <span class="nx">c</span><span class="p">;</span>
          <span class="nx">bound</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-181"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-181">&#182;</a></div><p>Re-center the circles and return the encompassing radius.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">cx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xMin</span> <span class="o">+</span> <span class="nx">xMax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">cy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">yMin</span> <span class="o">+</span> <span class="nx">yMax</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
      <span class="nx">cr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">node</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">-=</span> <span class="nx">cx</span><span class="p">;</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">-=</span> <span class="nx">cy</span><span class="p">;</span>
    <span class="nx">cr</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">cr</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span><span class="p">));</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-182"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-182">&#182;</a></div><p>Remove node links.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d3_layout_packUnlink</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">cr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packLink</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">_pack_next</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_pack_prev</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packUnlink</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_pack_next</span><span class="p">;</span>
  <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_pack_prev</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packTree</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">d3_layout_packTree</span><span class="p">);</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">d3_layout_packCircle</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">node</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packTransform</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span><span class="p">);</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">r</span> <span class="o">*=</span> <span class="nx">k</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">d3_layout_packTransform</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">k</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_packPlace</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">db</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">||</span> <span class="nx">dy</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">da</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">r</span> <span class="o">+</span> <span class="nx">c</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
        <span class="nx">dc</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">),</span>
        <span class="nx">cos</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="nx">db</span> <span class="o">*</span> <span class="nx">db</span> <span class="o">+</span> <span class="nx">dc</span> <span class="o">*</span> <span class="nx">dc</span> <span class="o">-</span> <span class="nx">da</span> <span class="o">*</span> <span class="nx">da</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">db</span> <span class="o">*</span> <span class="nx">dc</span><span class="p">))),</span>
        <span class="nx">theta</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">cos</span><span class="p">),</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">cos</span> <span class="o">*</span> <span class="p">(</span><span class="nx">db</span> <span class="o">/=</span> <span class="nx">dc</span><span class="p">),</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">theta</span><span class="p">)</span> <span class="o">*</span> <span class="nx">db</span><span class="p">;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">-</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">dx</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">db</span><span class="p">;</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-183"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-183">&#182;</a></div><p>Implements a hierarchical layout using the cluster (or dendrogram)
algorithm.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">cluster</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hierarchy</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="kc">null</span><span class="p">).</span><span class="nx">value</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
      <span class="nx">separation</span> <span class="o">=</span> <span class="nx">d3_layout_treeSeparation</span><span class="p">,</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// width, height</span>

  <span class="kd">function</span> <span class="nx">cluster</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">previousNode</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">kx</span><span class="p">,</span>
        <span class="nx">ky</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-184"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-184">&#182;</a></div><p>First walk, computing the initial x &amp; y values.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">d3_layout_treeVisitAfter</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">d3_layout_clusterX</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">d3_layout_clusterY</span><span class="p">(</span><span class="nx">children</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">previousNode</span> <span class="o">?</span> <span class="nx">x</span> <span class="o">+=</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousNode</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nx">previousNode</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">});</span></pre></div></td></tr>


<tr id="section-185"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-185">&#182;</a></div><p>Compute the left-most, right-most, and depth-most nodes for extents.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">d3_layout_clusterLeft</span><span class="p">(</span><span class="nx">root</span><span class="p">),</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="nx">d3_layout_clusterRight</span><span class="p">(</span><span class="nx">root</span><span class="p">),</span>
        <span class="nx">x0</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">x1</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-186"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-186">&#182;</a></div><p>Second walk, normalizing x &amp; y to the desired size.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">d3_layout_treeVisitAfter</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="o">*</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">y</span> <span class="o">?</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">root</span><span class="p">.</span><span class="nx">y</span> <span class="o">:</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">cluster</span><span class="p">.</span><span class="nx">separation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">separation</span><span class="p">;</span>
    <span class="nx">separation</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">cluster</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">cluster</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">cluster</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">cluster</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_clusterY</span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">children</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">child</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_clusterX</span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">children</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">child</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
  <span class="p">},</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_clusterLeft</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">d3_layout_clusterLeft</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">:</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_clusterRight</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span> <span class="nx">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">d3_layout_clusterRight</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">:</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-187"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-187">&#182;</a></div><p>Node-link tree diagram using the Reingold-Tilford "tidy" algorithm</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">tree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hierarchy</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span><span class="p">().</span><span class="nx">sort</span><span class="p">(</span><span class="kc">null</span><span class="p">).</span><span class="nx">value</span><span class="p">(</span><span class="kc">null</span><span class="p">),</span>
      <span class="nx">separation</span> <span class="o">=</span> <span class="nx">d3_layout_treeSeparation</span><span class="p">,</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// width, height</span>

  <span class="kd">function</span> <span class="nx">tree</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
        <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="kd">function</span> <span class="nx">firstWalk</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
          <span class="nx">layout</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">n</span><span class="p">,</span>
            <span class="nx">firstChild</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nx">previousChild</span><span class="p">,</span>
            <span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">firstChild</span><span class="p">,</span>
            <span class="nx">child</span><span class="p">,</span>
            <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="nx">firstWalk</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">previousChild</span><span class="p">);</span>
          <span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">apportion</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">previousChild</span><span class="p">,</span> <span class="nx">ancestor</span><span class="p">);</span>
          <span class="nx">previousChild</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">d3_layout_treeShift</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">midpoint</span> <span class="o">=</span> <span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="nx">firstChild</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+</span> <span class="nx">child</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">layout</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">=</span> <span class="nx">previousSibling</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">);</span>
          <span class="nx">layout</span><span class="p">.</span><span class="nx">mod</span> <span class="o">=</span> <span class="nx">layout</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">-</span> <span class="nx">midpoint</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">layout</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">=</span> <span class="nx">midpoint</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">layout</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">=</span> <span class="nx">previousSibling</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">secondWalk</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+</span> <span class="nx">x</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="nx">n</span><span class="p">;</span>
        <span class="nx">x</span> <span class="o">+=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">secondWalk</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">x</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">apportion</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">,</span> <span class="nx">ancestor</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">vip</span> <span class="o">=</span> <span class="nx">node</span><span class="p">,</span>
            <span class="nx">vop</span> <span class="o">=</span> <span class="nx">node</span><span class="p">,</span>
            <span class="nx">vim</span> <span class="o">=</span> <span class="nx">previousSibling</span><span class="p">,</span>
            <span class="nx">vom</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="nx">sip</span> <span class="o">=</span> <span class="nx">vip</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">,</span>
            <span class="nx">sop</span> <span class="o">=</span> <span class="nx">vop</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">,</span>
            <span class="nx">sim</span> <span class="o">=</span> <span class="nx">vim</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">,</span>
            <span class="nx">som</span> <span class="o">=</span> <span class="nx">vom</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">,</span>
            <span class="nx">shift</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">vim</span> <span class="o">=</span> <span class="nx">d3_layout_treeRight</span><span class="p">(</span><span class="nx">vim</span><span class="p">),</span> <span class="nx">vip</span> <span class="o">=</span> <span class="nx">d3_layout_treeLeft</span><span class="p">(</span><span class="nx">vip</span><span class="p">),</span> <span class="nx">vim</span> <span class="o">&amp;&amp;</span> <span class="nx">vip</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">vom</span> <span class="o">=</span> <span class="nx">d3_layout_treeLeft</span><span class="p">(</span><span class="nx">vom</span><span class="p">);</span>
          <span class="nx">vop</span> <span class="o">=</span> <span class="nx">d3_layout_treeRight</span><span class="p">(</span><span class="nx">vop</span><span class="p">);</span>
          <span class="nx">vop</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
          <span class="nx">shift</span> <span class="o">=</span> <span class="nx">vim</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+</span> <span class="nx">sim</span> <span class="o">-</span> <span class="nx">vip</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">-</span> <span class="nx">sip</span> <span class="o">+</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">vim</span><span class="p">,</span> <span class="nx">vip</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">shift</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">d3_layout_treeMove</span><span class="p">(</span><span class="nx">d3_layout_treeAncestor</span><span class="p">(</span><span class="nx">vim</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">ancestor</span><span class="p">),</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">shift</span><span class="p">);</span>
            <span class="nx">sip</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
            <span class="nx">sop</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">sim</span> <span class="o">+=</span> <span class="nx">vim</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">;</span>
          <span class="nx">sip</span> <span class="o">+=</span> <span class="nx">vip</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">;</span>
          <span class="nx">som</span> <span class="o">+=</span> <span class="nx">vom</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">;</span>
          <span class="nx">sop</span> <span class="o">+=</span> <span class="nx">vop</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vim</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">d3_layout_treeRight</span><span class="p">(</span><span class="nx">vop</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">vop</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">thread</span> <span class="o">=</span> <span class="nx">vim</span><span class="p">;</span>
          <span class="nx">vop</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span> <span class="o">+=</span> <span class="nx">sim</span> <span class="o">-</span> <span class="nx">sop</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">vip</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">d3_layout_treeLeft</span><span class="p">(</span><span class="nx">vom</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">vom</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">thread</span> <span class="o">=</span> <span class="nx">vip</span><span class="p">;</span>
          <span class="nx">vom</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">mod</span> <span class="o">+=</span> <span class="nx">sip</span> <span class="o">-</span> <span class="nx">som</span><span class="p">;</span>
          <span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">ancestor</span><span class="p">;</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-188"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-188">&#182;</a></div><p>Initialize temporary layout variables.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">d3_layout_treeVisitAfter</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">ancestor</span><span class="o">:</span> <span class="nx">node</span><span class="p">,</span>
        <span class="nx">prelim</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">mod</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">change</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">shift</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">number</span><span class="o">:</span> <span class="nx">previousSibling</span> <span class="o">?</span> <span class="nx">previousSibling</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">number</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span>
      <span class="p">};</span>
    <span class="p">});</span></pre></div></td></tr>


<tr id="section-189"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-189">&#182;</a></div><p>Compute the layout using Buchheim et al.'s algorithm.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">firstWalk</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
    <span class="nx">secondWalk</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="o">-</span><span class="nx">root</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">prelim</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-190"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-190">&#182;</a></div><p>Compute the left-most, right-most, and depth-most nodes for extents.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">d3_layout_treeSearch</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">d3_layout_treeLeftmost</span><span class="p">),</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="nx">d3_layout_treeSearch</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">d3_layout_treeRightmost</span><span class="p">),</span>
        <span class="nx">deep</span> <span class="o">=</span> <span class="nx">d3_layout_treeSearch</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">d3_layout_treeDeepest</span><span class="p">),</span>
        <span class="nx">x0</span> <span class="o">=</span> <span class="nx">left</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">x1</span> <span class="o">=</span> <span class="nx">right</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">separation</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nx">y1</span> <span class="o">=</span> <span class="nx">deep</span><span class="p">.</span><span class="nx">depth</span> <span class="o">||</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-191"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-191">&#182;</a></div><p>Clear temporary layout variables; transform x and y.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">d3_layout_treeVisitAfter</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)</span> <span class="o">*</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">depth</span> <span class="o">/</span> <span class="nx">y1</span> <span class="o">*</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">delete</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">tree</span><span class="p">.</span><span class="nx">separation</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">separation</span><span class="p">;</span>
    <span class="nx">separation</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">tree</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">tree</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">tree</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeSeparation</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="nx">b</span><span class="p">.</span><span class="nx">parent</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-192"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-192">&#182;</a></div><p>function d3<em>layout</em>treeSeparationRadial(a, b) {
  return (a.parent == b.parent ? 1 : 2) / a.depth;
}</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_layout_treeLeft</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">thread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeRight</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
      <span class="nx">n</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">?</span> <span class="nx">children</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">thread</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeSearch</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">compare</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">child</span><span class="p">,</span>
        <span class="nx">n</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">compare</span><span class="p">(</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">d3_layout_treeSearch</span><span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">compare</span><span class="p">),</span> <span class="nx">node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">node</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeRightmost</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeLeftmost</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeDeepest</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">depth</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">depth</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeVisitAfter</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">function</span> <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">))</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">child</span><span class="p">,</span>
          <span class="nx">previousChild</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
          <span class="nx">n</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">visit</span><span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">previousChild</span><span class="p">);</span>
        <span class="nx">previousChild</span> <span class="o">=</span> <span class="nx">child</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">previousSibling</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="nx">visit</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeShift</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">child</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">_tree</span><span class="p">;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
    <span class="nx">child</span><span class="p">.</span><span class="nx">mod</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
    <span class="nx">shift</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">shift</span> <span class="o">+</span> <span class="p">(</span><span class="nx">change</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">change</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeMove</span><span class="p">(</span><span class="nx">ancestor</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">shift</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ancestor</span> <span class="o">=</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">_tree</span><span class="p">;</span>
  <span class="nx">node</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">_tree</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">change</span> <span class="o">=</span> <span class="nx">shift</span> <span class="o">/</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">number</span> <span class="o">-</span> <span class="nx">ancestor</span><span class="p">.</span><span class="nx">number</span><span class="p">);</span>
  <span class="nx">ancestor</span><span class="p">.</span><span class="nx">change</span> <span class="o">+=</span> <span class="nx">change</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">change</span> <span class="o">-=</span> <span class="nx">change</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">shift</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">prelim</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
  <span class="nx">node</span><span class="p">.</span><span class="nx">mod</span> <span class="o">+=</span> <span class="nx">shift</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treeAncestor</span><span class="p">(</span><span class="nx">vim</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">ancestor</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">vim</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">ancestor</span><span class="p">.</span><span class="nx">parent</span> <span class="o">==</span> <span class="nx">node</span><span class="p">.</span><span class="nx">parent</span>
      <span class="o">?</span> <span class="nx">vim</span><span class="p">.</span><span class="nx">_tree</span><span class="p">.</span><span class="nx">ancestor</span>
      <span class="o">:</span> <span class="nx">ancestor</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-193"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-193">&#182;</a></div><p>Squarified Treemaps by Mark Bruls, Kees Huizing, and Jarke J. van Wijk
Modified to support a target aspect ratio by Jeff Heer</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">treemap</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hierarchy</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">layout</span><span class="p">.</span><span class="nx">hierarchy</span><span class="p">(),</span>
      <span class="nx">round</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">,</span>
      <span class="nx">size</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="c1">// width, height</span>
      <span class="nx">padding</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">pad</span> <span class="o">=</span> <span class="nx">d3_layout_treemapPadNull</span><span class="p">,</span>
      <span class="nx">sticky</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">stickies</span><span class="p">,</span>
      <span class="nx">ratio</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span> <span class="c1">// golden ratio</span></pre></div></td></tr>


<tr id="section-194"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-194">&#182;</a></div><p>Compute the area for each child based on value &amp; scale.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">children</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">child</span><span class="p">,</span>
        <span class="nx">area</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">area</span> <span class="o">=</span> <span class="p">(</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">value</span> <span class="o">*</span> <span class="p">(</span><span class="nx">k</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">k</span><span class="p">);</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">area</span><span class="p">)</span> <span class="o">||</span> <span class="nx">area</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="nx">area</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-195"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-195">&#182;</a></div><p>Recursively arranges the specified node's children into squarified rows.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">squarify</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span>
          <span class="nx">row</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="c1">// copy-on-write</span>
          <span class="nx">child</span><span class="p">,</span>
          <span class="nx">best</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span> <span class="c1">// the best row score so far</span>
          <span class="nx">score</span><span class="p">,</span> <span class="c1">// the current row score</span>
          <span class="nx">u</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span><span class="p">),</span> <span class="c1">// initial orientation</span>
          <span class="nx">n</span><span class="p">;</span>
      <span class="nx">scale</span><span class="p">(</span><span class="nx">remaining</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span> <span class="o">/</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">((</span><span class="nx">n</span> <span class="o">=</span> <span class="nx">remaining</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">remaining</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">area</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">score</span> <span class="o">=</span> <span class="nx">worst</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">))</span> <span class="o">&lt;=</span> <span class="nx">best</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// continue with this orientation</span>
          <span class="nx">remaining</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
          <span class="nx">best</span> <span class="o">=</span> <span class="nx">score</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// abort, and try a different orientation</span>
          <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">-=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">pop</span><span class="p">().</span><span class="nx">area</span><span class="p">;</span>
          <span class="nx">position</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
          <span class="nx">u</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span><span class="p">);</span>
          <span class="nx">row</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">best</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">position</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">squarify</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-196"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-196">&#182;</a></div><p>Recursively resizes the specified node's children into existing rows.
Preserves the existing layout!</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">stickify</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span> <span class="o">&amp;&amp;</span> <span class="nx">children</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">pad</span><span class="p">(</span><span class="nx">node</span><span class="p">),</span>
          <span class="nx">remaining</span> <span class="o">=</span> <span class="nx">children</span><span class="p">.</span><span class="nx">slice</span><span class="p">(),</span> <span class="c1">// copy-on-write</span>
          <span class="nx">child</span><span class="p">,</span>
          <span class="nx">row</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="nx">scale</span><span class="p">(</span><span class="nx">remaining</span><span class="p">,</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span> <span class="o">/</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">child</span> <span class="o">=</span> <span class="nx">remaining</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span> <span class="p">{</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">child</span><span class="p">);</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">+=</span> <span class="nx">child</span><span class="p">.</span><span class="nx">area</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">child</span><span class="p">.</span><span class="nx">z</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">position</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">child</span><span class="p">.</span><span class="nx">z</span> <span class="o">?</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">:</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="o">!</span><span class="nx">remaining</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
          <span class="nx">row</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">children</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">stickify</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-197"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-197">&#182;</a></div><p>Computes the score for the specified row, as the worst aspect ratio.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">worst</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">area</span><span class="p">,</span>
        <span class="nx">r</span><span class="p">,</span>
        <span class="nx">rmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">rmin</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">area</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&lt;</span> <span class="nx">rmin</span><span class="p">)</span> <span class="nx">rmin</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">r</span> <span class="o">&gt;</span> <span class="nx">rmax</span><span class="p">)</span> <span class="nx">rmax</span> <span class="o">=</span> <span class="nx">r</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">s</span> <span class="o">*=</span> <span class="nx">s</span><span class="p">;</span>
    <span class="nx">u</span> <span class="o">*=</span> <span class="nx">u</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">s</span>
        <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">((</span><span class="nx">u</span> <span class="o">*</span> <span class="nx">rmax</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">)</span> <span class="o">/</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">s</span> <span class="o">/</span> <span class="p">(</span><span class="nx">u</span> <span class="o">*</span> <span class="nx">rmin</span> <span class="o">*</span> <span class="nx">ratio</span><span class="p">))</span>
        <span class="o">:</span> <span class="kc">Infinity</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-198"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-198">&#182;</a></div><p>Positions the specified row of nodes. Modifies <code>rect</code>.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">position</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">rect</span><span class="p">,</span> <span class="nx">flush</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">row</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
        <span class="nx">v</span> <span class="o">=</span> <span class="nx">u</span> <span class="o">?</span> <span class="nx">round</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">area</span> <span class="o">/</span> <span class="nx">u</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">o</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">u</span> <span class="o">==</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// horizontal subdivision</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">||</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span><span class="p">)</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span><span class="p">;</span> <span class="c1">// over+underflow</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">dy</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
        <span class="nx">x</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">dx</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">-</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">v</span> <span class="o">?</span> <span class="nx">round</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">area</span> <span class="o">/</span> <span class="nx">v</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">dx</span> <span class="o">+=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">-</span> <span class="nx">x</span><span class="p">;</span> <span class="c1">// rounding error</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">;</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span> <span class="o">-=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// vertical subdivision</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">flush</span> <span class="o">||</span> <span class="nx">v</span> <span class="o">&gt;</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span><span class="p">)</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span><span class="p">;</span> <span class="c1">// over+underflow</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">dx</span> <span class="o">=</span> <span class="nx">v</span><span class="p">;</span>
        <span class="nx">y</span> <span class="o">+=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">dy</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span> <span class="o">-</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">v</span> <span class="o">?</span> <span class="nx">round</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">area</span> <span class="o">/</span> <span class="nx">v</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">dy</span> <span class="o">+=</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">dy</span> <span class="o">-</span> <span class="nx">y</span><span class="p">;</span> <span class="c1">// rounding error</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="nx">v</span><span class="p">;</span>
      <span class="nx">rect</span><span class="p">.</span><span class="nx">dx</span> <span class="o">-=</span> <span class="nx">v</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">treemap</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">nodes</span> <span class="o">=</span> <span class="nx">stickies</span> <span class="o">||</span> <span class="nx">hierarchy</span><span class="p">(</span><span class="nx">d</span><span class="p">),</span>
        <span class="nx">root</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">dx</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">root</span><span class="p">.</span><span class="nx">dy</span> <span class="o">=</span> <span class="nx">size</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">stickies</span><span class="p">)</span> <span class="nx">hierarchy</span><span class="p">.</span><span class="nx">revalue</span><span class="p">(</span><span class="nx">root</span><span class="p">);</span>
    <span class="nx">scale</span><span class="p">([</span><span class="nx">root</span><span class="p">],</span> <span class="nx">root</span><span class="p">.</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">root</span><span class="p">.</span><span class="nx">dy</span> <span class="o">/</span> <span class="nx">root</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">(</span><span class="nx">stickies</span> <span class="o">?</span> <span class="nx">stickify</span> <span class="o">:</span> <span class="nx">squarify</span><span class="p">)(</span><span class="nx">root</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sticky</span><span class="p">)</span> <span class="nx">stickies</span> <span class="o">=</span> <span class="nx">nodes</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">treemap</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">size</span><span class="p">;</span>
    <span class="nx">size</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">treemap</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">treemap</span><span class="p">.</span><span class="nx">padding</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">padding</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">padFunction</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">treemap</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">depth</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">p</span> <span class="o">==</span> <span class="kc">null</span>
          <span class="o">?</span> <span class="nx">d3_layout_treemapPadNull</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">d3_layout_treemapPad</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="k">typeof</span> <span class="nx">p</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span> <span class="o">?</span> <span class="p">[</span><span class="nx">p</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">p</span><span class="p">]</span> <span class="o">:</span> <span class="nx">p</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">padConstant</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">d3_layout_treemapPad</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">type</span><span class="p">;</span>
    <span class="nx">pad</span> <span class="o">=</span> <span class="p">(</span><span class="nx">padding</span> <span class="o">=</span> <span class="nx">x</span><span class="p">)</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="nx">d3_layout_treemapPadNull</span>
        <span class="o">:</span> <span class="p">(</span><span class="nx">type</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">x</span><span class="p">)</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">padFunction</span>
        <span class="o">:</span> <span class="nx">type</span> <span class="o">===</span> <span class="s2">&quot;number&quot;</span> <span class="o">?</span> <span class="p">(</span><span class="nx">x</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">x</span><span class="p">],</span> <span class="nx">padConstant</span><span class="p">)</span>
        <span class="o">:</span> <span class="nx">padConstant</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">treemap</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">treemap</span><span class="p">.</span><span class="nx">round</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">round</span> <span class="o">!=</span> <span class="nb">Number</span><span class="p">;</span>
    <span class="nx">round</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span> <span class="o">:</span> <span class="nb">Number</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">treemap</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">treemap</span><span class="p">.</span><span class="nx">sticky</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">sticky</span><span class="p">;</span>
    <span class="nx">sticky</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">stickies</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">treemap</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">treemap</span><span class="p">.</span><span class="nx">ratio</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">ratio</span><span class="p">;</span>
    <span class="nx">ratio</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">treemap</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">d3_layout_hierarchyRebind</span><span class="p">(</span><span class="nx">treemap</span><span class="p">,</span> <span class="nx">hierarchy</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_layout_treemapPadNull</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">dx</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="o">:</span> <span class="nx">node</span><span class="p">.</span><span class="nx">dy</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_layout_treemapPad</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">padding</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">dx</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">dy</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">x</span> <span class="o">+=</span> <span class="nx">dx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">dy</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">y</span> <span class="o">+=</span> <span class="nx">dy</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">dx</span><span class="o">:</span> <span class="nx">dx</span><span class="p">,</span> <span class="nx">dy</span><span class="o">:</span> <span class="nx">dy</span><span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="s2">&quot;text/csv&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">text</span> <span class="o">&amp;&amp;</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">text</span><span class="p">));</span>
  <span class="p">});</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">header</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parseRows</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">{},</span> <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">header</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="nx">o</span><span class="p">[</span><span class="nx">header</span><span class="p">[</span><span class="nx">j</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">row</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
      <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">header</span> <span class="o">=</span> <span class="nx">row</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">parseRows</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">text</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">EOL</span> <span class="o">=</span> <span class="p">{},</span> <span class="c1">// sentinel value for end-of-line</span>
      <span class="nx">EOF</span> <span class="o">=</span> <span class="p">{},</span> <span class="c1">// sentinel value for end-of-file</span>
      <span class="nx">rows</span> <span class="o">=</span> <span class="p">[],</span> <span class="c1">// output rows</span>
      <span class="nx">re</span> <span class="o">=</span> <span class="sr">/\r\n|[,\r\n]/g</span><span class="p">,</span> <span class="c1">// field separator regex</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// the current line number</span>
      <span class="nx">t</span><span class="p">,</span> <span class="c1">// the current token</span>
      <span class="nx">eol</span><span class="p">;</span> <span class="c1">// is the current token followed by EOL?</span>

  <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// work-around bug in FF 3.6</span>

  <span class="cm">/** @private Returns the next token. */</span>
  <span class="kd">function</span> <span class="nx">token</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">&gt;=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">EOF</span><span class="p">;</span> <span class="c1">// special case: end of file</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">eol</span><span class="p">)</span> <span class="p">{</span> <span class="nx">eol</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="k">return</span> <span class="nx">EOL</span><span class="p">;</span> <span class="p">}</span> <span class="c1">// special case: end of line</span></pre></div></td></tr>


<tr id="section-199"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-199">&#182;</a></div><p>special case: quotes</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">j</span><span class="p">)</span> <span class="o">===</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">===</span> <span class="mi">34</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">34</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
          <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">eol</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">===</span> <span class="mi">10</span><span class="p">)</span> <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span><span class="o">++</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">===</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">eol</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&quot;&quot;/g</span><span class="p">,</span> <span class="s2">&quot;\&quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-200"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-200">&#182;</a></div><p>common case</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eol</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">44</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">m</span><span class="p">.</span><span class="nx">index</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">re</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">j</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">while</span> <span class="p">((</span><span class="nx">t</span> <span class="o">=</span> <span class="nx">token</span><span class="p">())</span> <span class="o">!==</span> <span class="nx">EOF</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">t</span> <span class="o">!==</span> <span class="nx">EOL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">t</span> <span class="o">!==</span> <span class="nx">EOF</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
      <span class="nx">t</span> <span class="o">=</span> <span class="nx">token</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">f</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">n</span><span class="o">++</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
    <span class="nx">rows</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">rows</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rows</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_csv_formatRow</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_csv_formatRow</span><span class="p">(</span><span class="nx">row</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">row</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_csv_formatValue</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_csv_formatValue</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="sr">/[&quot;,\n]/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span>
      <span class="o">?</span> <span class="s2">&quot;\&quot;&quot;</span> <span class="o">+</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&quot;/g</span><span class="p">,</span> <span class="s2">&quot;\&quot;\&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\&quot;&quot;</span>
      <span class="o">:</span> <span class="nx">text</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">d3_geo_radians</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">180</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-201"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-201">&#182;</a></div><p>TODO clip input coordinates on opposite hemisphere</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">azimuthal</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">mode</span> <span class="o">=</span> <span class="s2">&quot;orthographic&quot;</span><span class="p">,</span> <span class="c1">// or stereographic, gnomonic, equidistant or equalarea</span>
      <span class="nx">origin</span><span class="p">,</span>
      <span class="nx">scale</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
      <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
      <span class="nx">x0</span><span class="p">,</span>
      <span class="nx">y0</span><span class="p">,</span>
      <span class="nx">cy0</span><span class="p">,</span>
      <span class="nx">sy0</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">azimuthal</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">,</span>
        <span class="nx">y1</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
        <span class="nx">cx1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span>
        <span class="nx">sx1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span>
        <span class="nx">cy1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y1</span><span class="p">),</span>
        <span class="nx">sy1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">y1</span><span class="p">),</span>
        <span class="nx">cc</span> <span class="o">=</span> <span class="nx">mode</span> <span class="o">!==</span> <span class="s2">&quot;orthographic&quot;</span> <span class="o">?</span> <span class="nx">sy0</span> <span class="o">*</span> <span class="nx">sy1</span> <span class="o">+</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nx">cx1</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">c</span><span class="p">,</span>
        <span class="nx">k</span> <span class="o">=</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;stereographic&quot;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">cc</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;gnomonic&quot;</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">/</span> <span class="nx">cc</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;equidistant&quot;</span> <span class="o">?</span> <span class="p">(</span><span class="nx">c</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nx">cc</span><span class="p">),</span> <span class="nx">c</span> <span class="o">?</span> <span class="nx">c</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;equalarea&quot;</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">cc</span><span class="p">))</span>
          <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">k</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nx">sx1</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">k</span> <span class="o">*</span> <span class="p">(</span><span class="nx">sy0</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nx">cx1</span> <span class="o">-</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">sy1</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">),</span>
        <span class="nx">c</span> <span class="o">=</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;stereographic&quot;</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;gnomonic&quot;</span> <span class="o">?</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;equidistant&quot;</span> <span class="o">?</span> <span class="nx">p</span>
          <span class="o">:</span> <span class="nx">mode</span> <span class="o">===</span> <span class="s2">&quot;equalarea&quot;</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(.</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">p</span><span class="p">)</span>
          <span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">p</span><span class="p">),</span>
        <span class="nx">sc</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">c</span><span class="p">),</span>
        <span class="nx">cc</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">c</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="p">(</span><span class="nx">x0</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">cc</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">sy0</span> <span class="o">*</span> <span class="nx">sc</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">(</span><span class="nx">cc</span> <span class="o">*</span> <span class="nx">sy0</span> <span class="o">-</span> <span class="p">(</span><span class="nx">p</span> <span class="o">?</span> <span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">sc</span> <span class="o">*</span> <span class="nx">cy0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">p</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span>
    <span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">mode</span><span class="p">;</span>
    <span class="nx">mode</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">azimuthal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">origin</span><span class="p">;</span>
    <span class="nx">origin</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="nx">y0</span> <span class="o">=</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="nx">cy0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y0</span><span class="p">);</span>
    <span class="nx">sy0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">y0</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">azimuthal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">azimuthal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">azimuthal</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">azimuthal</span><span class="p">.</span><span class="nx">origin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]);</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-202"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-202">&#182;</a></div><p>Derived from Tom Carden's Albers implementation for Protovis.
http://gist.github.com/476238
http://mathworld.wolfram.com/AlbersEqual-AreaConicProjection.html</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">98</span><span class="p">,</span> <span class="mi">38</span><span class="p">],</span>
      <span class="nx">parallels</span> <span class="o">=</span> <span class="p">[</span><span class="mf">29.5</span><span class="p">,</span> <span class="mf">45.5</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
      <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
      <span class="nx">lng0</span><span class="p">,</span> <span class="c1">// d3_geo_radians * origin[0]</span>
      <span class="nx">n</span><span class="p">,</span>
      <span class="nx">C</span><span class="p">,</span>
      <span class="nx">p0</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">albers</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">*</span> <span class="p">(</span><span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">lng0</span><span class="p">),</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">C</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">/</span> <span class="nx">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">-</span> <span class="nx">p0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">albers</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">p0y</span> <span class="o">=</span> <span class="nx">p0</span> <span class="o">+</span> <span class="nx">y</span><span class="p">,</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">p0y</span><span class="p">),</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">p0y</span> <span class="o">*</span> <span class="nx">p0y</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="p">(</span><span class="nx">lng0</span> <span class="o">+</span> <span class="nx">t</span> <span class="o">/</span> <span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">asin</span><span class="p">((</span><span class="nx">C</span> <span class="o">-</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">p</span> <span class="o">*</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">n</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span>
    <span class="p">];</span>
  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">reload</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">phi1</span> <span class="o">=</span> <span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">parallels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">phi2</span> <span class="o">=</span> <span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">parallels</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">lat0</span> <span class="o">=</span> <span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">s</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi1</span><span class="p">),</span>
        <span class="nx">c</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi1</span><span class="p">);</span>
    <span class="nx">lng0</span> <span class="o">=</span> <span class="nx">d3_geo_radians</span> <span class="o">*</span> <span class="nx">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">n</span> <span class="o">=</span> <span class="p">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="nx">s</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi2</span><span class="p">));</span>
    <span class="nx">C</span> <span class="o">=</span> <span class="nx">c</span> <span class="o">*</span> <span class="nx">c</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span> <span class="o">*</span> <span class="nx">s</span><span class="p">;</span>
    <span class="nx">p0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">C</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">n</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">lat0</span><span class="p">))</span> <span class="o">/</span> <span class="nx">n</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">albers</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">albers</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">origin</span><span class="p">;</span>
    <span class="nx">origin</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">reload</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">albers</span><span class="p">.</span><span class="nx">parallels</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">parallels</span><span class="p">;</span>
    <span class="nx">parallels</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">reload</span><span class="p">();</span>
  <span class="p">};</span>

  <span class="nx">albers</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">albers</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">albers</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">albers</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">reload</span><span class="p">();</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-203"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-203">&#182;</a></div><p>A composite projection for the United States, 960x500. The set of standard
parallels for each region comes from USGS, which is published here:
http://egsc.usgs.gov/isb/pubs/MapProjections/projections.html#albers
TODO allow the composite projection to be rescaled?</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albersUsa</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">lower48</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">alaska</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">origin</span><span class="p">([</span><span class="o">-</span><span class="mi">160</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">parallels</span><span class="p">([</span><span class="mi">55</span><span class="p">,</span> <span class="mi">65</span><span class="p">]);</span>

  <span class="kd">var</span> <span class="nx">hawaii</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">origin</span><span class="p">([</span><span class="o">-</span><span class="mi">160</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">parallels</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">]);</span>

  <span class="kd">var</span> <span class="nx">puertoRico</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albers</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">origin</span><span class="p">([</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">parallels</span><span class="p">([</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">]);</span>

  <span class="kd">function</span> <span class="nx">albersUsa</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">lon</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">lat</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">lat</span> <span class="o">&gt;</span> <span class="mi">50</span> <span class="o">?</span> <span class="nx">alaska</span>
        <span class="o">:</span> <span class="nx">lon</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">140</span> <span class="o">?</span> <span class="nx">hawaii</span>
        <span class="o">:</span> <span class="nx">lat</span> <span class="o">&lt;</span> <span class="mi">21</span> <span class="o">?</span> <span class="nx">puertoRico</span>
        <span class="o">:</span> <span class="nx">lower48</span><span class="p">)(</span><span class="nx">coordinates</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">albersUsa</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">lower48</span><span class="p">.</span><span class="nx">scale</span><span class="p">();</span>
    <span class="nx">lower48</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">alaska</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="p">.</span><span class="mi">6</span><span class="p">);</span>
    <span class="nx">hawaii</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">puertoRico</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">albersUsa</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">lower48</span><span class="p">.</span><span class="nx">translate</span><span class="p">());</span>
  <span class="p">};</span>

  <span class="nx">albersUsa</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">lower48</span><span class="p">.</span><span class="nx">translate</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">dz</span> <span class="o">=</span> <span class="nx">lower48</span><span class="p">.</span><span class="nx">scale</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
        <span class="nx">dx</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">dy</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">lower48</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="nx">alaska</span><span class="p">.</span><span class="nx">translate</span><span class="p">([</span><span class="nx">dx</span> <span class="o">-</span> <span class="mi">400</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">+</span> <span class="mi">170</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">]);</span>
    <span class="nx">hawaii</span><span class="p">.</span><span class="nx">translate</span><span class="p">([</span><span class="nx">dx</span> <span class="o">-</span> <span class="mi">190</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">+</span> <span class="mi">200</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">]);</span>
    <span class="nx">puertoRico</span><span class="p">.</span><span class="nx">translate</span><span class="p">([</span><span class="nx">dx</span> <span class="o">+</span> <span class="mi">580</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">,</span> <span class="nx">dy</span> <span class="o">+</span> <span class="mi">430</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">albersUsa</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">albersUsa</span><span class="p">.</span><span class="nx">scale</span><span class="p">(</span><span class="nx">lower48</span><span class="p">.</span><span class="nx">scale</span><span class="p">());</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">bonne</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
      <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">250</span><span class="p">],</span>
      <span class="nx">x0</span><span class="p">,</span> <span class="c1">// origin longitude in radians</span>
      <span class="nx">y0</span><span class="p">,</span> <span class="c1">// origin latitude in radians</span>
      <span class="nx">y1</span><span class="p">,</span> <span class="c1">// parallel latitude in radians</span>
      <span class="nx">c1</span><span class="p">;</span> <span class="c1">// cot(y1)</span>

  <span class="kd">function</span> <span class="nx">bonne</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span> <span class="o">-</span> <span class="nx">y0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">c1</span> <span class="o">+</span> <span class="nx">y1</span> <span class="o">-</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">E</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="o">/</span> <span class="nx">p</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">E</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">p</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">E</span><span class="p">)</span> <span class="o">-</span> <span class="nx">c1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">*=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">bonne</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y1</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">c1</span> <span class="o">+</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">p</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">c</span> <span class="o">*</span> <span class="nx">c</span><span class="p">);</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">c1</span> <span class="o">+</span> <span class="nx">y1</span> <span class="o">-</span> <span class="nx">p</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">x0</span> <span class="o">+</span> <span class="nx">p</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">c</span><span class="p">)</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">y</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="nx">x</span> <span class="o">/=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">x</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
      <span class="nx">y</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span>
    <span class="p">];</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-204"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-204">&#182;</a></div><p>90Â° for Werner, 0Â° for Sinusoidal</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">bonne</span><span class="p">.</span><span class="nx">parallel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y1</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="nx">c1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span><span class="p">(</span><span class="nx">y1</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">bonne</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">bonne</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="p">[</span><span class="nx">x0</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">,</span> <span class="nx">y0</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">];</span>
    <span class="nx">x0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="nx">y0</span> <span class="o">=</span> <span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">bonne</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">bonne</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">bonne</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">bonne</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">bonne</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">bonne</span><span class="p">.</span><span class="nx">origin</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]).</span><span class="nx">parallel</span><span class="p">(</span><span class="mi">45</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">equirectangular</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
      <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">250</span><span class="p">];</span>

  <span class="kd">function</span> <span class="nx">equirectangular</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">360</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="o">-</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">360</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">equirectangular</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="mi">360</span> <span class="o">*</span> <span class="nx">x</span><span class="p">,</span>
      <span class="o">-</span><span class="mi">360</span> <span class="o">*</span> <span class="nx">y</span>
    <span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">equirectangular</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">equirectangular</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">equirectangular</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">equirectangular</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">equirectangular</span><span class="p">;</span>
<span class="p">};</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">mercator</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
      <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="mi">480</span><span class="p">,</span> <span class="mi">250</span><span class="p">];</span>

  <span class="kd">function</span> <span class="nx">mercator</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">360</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">tan</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">+</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">)</span> <span class="o">/</span> <span class="mi">360</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">scale</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="p">.</span><span class="mi">5</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(.</span><span class="mi">5</span><span class="p">,</span> <span class="nx">y</span><span class="p">))</span> <span class="o">+</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="nx">mercator</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">translate</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="mi">360</span> <span class="o">*</span> <span class="nx">x</span><span class="p">,</span>
      <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">360</span> <span class="o">*</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span> <span class="o">-</span> <span class="mi">90</span>
    <span class="p">];</span>
  <span class="p">};</span>

  <span class="nx">mercator</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
    <span class="nx">scale</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">mercator</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">mercator</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">translate</span><span class="p">;</span>
    <span class="nx">translate</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">+</span><span class="nx">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
    <span class="k">return</span> <span class="nx">mercator</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">mercator</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">function</span> <span class="nx">d3_geo_type</span><span class="p">(</span><span class="nx">types</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">object</span> <span class="o">&amp;&amp;</span> <span class="nx">types</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="o">?</span> <span class="nx">types</span><span class="p">[</span><span class="nx">object</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">object</span><span class="p">)</span> <span class="o">:</span> <span class="nx">defaultValue</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Returns a function that, given a GeoJSON object (e.g., a feature), returns</span>
<span class="cm"> * the corresponding SVG path. The function can be customized by overriding the</span>
<span class="cm"> * projection. Point features are mapped to circles with a default radius of</span>
<span class="cm"> * 4.5px; the radius can be specified either as a constant or a function that</span>
<span class="cm"> * is evaluated per object.</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">pointRadius</span> <span class="o">=</span> <span class="mf">4.5</span><span class="p">,</span>
      <span class="nx">pointCircle</span> <span class="o">=</span> <span class="nx">d3_path_circle</span><span class="p">(</span><span class="nx">pointRadius</span><span class="p">),</span>
      <span class="nx">projection</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">albersUsa</span><span class="p">();</span>

  <span class="kd">function</span> <span class="nx">path</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">pointRadius</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pointCircle</span> <span class="o">=</span> <span class="nx">d3_path_circle</span><span class="p">(</span><span class="nx">pointRadius</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">pathType</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">project</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">projection</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">pathType</span> <span class="o">=</span> <span class="nx">d3_geo_type</span><span class="p">({</span>

    <span class="nx">FeatureCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">features</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">features</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// features.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pathType</span><span class="p">(</span><span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geometry</span><span class="p">));</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Feature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">pathType</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Point</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s2">&quot;M&quot;</span> <span class="o">+</span> <span class="nx">project</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">)</span> <span class="o">+</span> <span class="nx">pointCircle</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">MultiPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="nx">project</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="nx">pointCircle</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">LineString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;M&quot;</span><span class="p">],</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">project</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]),</span> <span class="s2">&quot;L&quot;</span><span class="p">);</span>
      <span class="nx">path</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">MultiLineString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">subcoordinates</span><span class="p">,</span> <span class="c1">// coordinates[i]</span>
          <span class="nx">j</span><span class="p">,</span> <span class="c1">// subcoordinates.index</span>
          <span class="nx">m</span><span class="p">;</span> <span class="c1">// subcoordinates.length</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">subcoordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">subcoordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">);</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">project</span><span class="p">(</span><span class="nx">subcoordinates</span><span class="p">[</span><span class="nx">j</span><span class="p">]),</span> <span class="s2">&quot;L&quot;</span><span class="p">);</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Polygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">subcoordinates</span><span class="p">,</span> <span class="c1">// coordinates[i]</span>
          <span class="nx">j</span><span class="p">,</span> <span class="c1">// subcoordinates.index</span>
          <span class="nx">m</span><span class="p">;</span> <span class="c1">// subcoordinates.length</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">subcoordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">subcoordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">);</span>
          <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">project</span><span class="p">(</span><span class="nx">subcoordinates</span><span class="p">[</span><span class="nx">j</span><span class="p">]),</span> <span class="s2">&quot;L&quot;</span><span class="p">);</span>
          <span class="nx">path</span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">MultiPolygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
          <span class="nx">subcoordinates</span><span class="p">,</span> <span class="c1">// coordinates[i]</span>
          <span class="nx">j</span><span class="p">,</span> <span class="c1">// subcoordinates index</span>
          <span class="nx">m</span><span class="p">,</span> <span class="c1">// subcoordinates.length</span>
          <span class="nx">subsubcoordinates</span><span class="p">,</span> <span class="c1">// subcoordinates[j]</span>
          <span class="nx">k</span><span class="p">,</span> <span class="c1">// subsubcoordinates index</span>
          <span class="nx">p</span><span class="p">;</span> <span class="c1">// subsubcoordinates.length</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">subcoordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">m</span> <span class="o">=</span> <span class="nx">subcoordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">subsubcoordinates</span> <span class="o">=</span> <span class="nx">subcoordinates</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
          <span class="nx">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">((</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">subsubcoordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">&quot;M&quot;</span><span class="p">);</span>
            <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">k</span> <span class="o">&lt;</span> <span class="nx">p</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">project</span><span class="p">(</span><span class="nx">subsubcoordinates</span><span class="p">[</span><span class="nx">k</span><span class="p">]),</span> <span class="s2">&quot;L&quot;</span><span class="p">);</span>
            <span class="nx">path</span><span class="p">[</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">GeometryCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="p">[],</span>
          <span class="nx">geometries</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometries</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// geometries index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">geometries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">path</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pathType</span><span class="p">(</span><span class="nx">geometries</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
      <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">});</span>

  <span class="kd">var</span> <span class="nx">areaType</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="nx">d3_geo_type</span><span class="p">({</span>

    <span class="nx">FeatureCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">features</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">features</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// features.index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">area</span> <span class="o">+=</span> <span class="nx">areaType</span><span class="p">(</span><span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">return</span> <span class="nx">area</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">Feature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">areaType</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Polygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">polygonArea</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">MultiPolygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">polygonArea</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">GeometryCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">geometries</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometries</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// geometries index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">geometries</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">areaType</span><span class="p">(</span><span class="nx">geometries</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">},</span> <span class="mi">0</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">polygonArea</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sum</span> <span class="o">=</span> <span class="nx">area</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="c1">// exterior ring</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// coordinates.index</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="nx">sum</span> <span class="o">-=</span> <span class="nx">area</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span> <span class="c1">// holes</span>
    <span class="k">return</span> <span class="nx">sum</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">polygonCentroid</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">polygon</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">polygon</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">projection</span><span class="p">)),</span> <span class="c1">// exterior ring</span>
        <span class="nx">area</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">area</span><span class="p">(),</span>
        <span class="nx">centroid</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">centroid</span><span class="p">(</span><span class="nx">area</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="nx">area</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">z</span> <span class="o">=</span> <span class="nx">area</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// coordinates index</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">polygon</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">polygon</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">projection</span><span class="p">));</span> <span class="c1">// holes</span>
      <span class="nx">area</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">area</span><span class="p">();</span>
      <span class="nx">centroid</span> <span class="o">=</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">centroid</span><span class="p">(</span><span class="nx">area</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="nx">area</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
      <span class="nx">x</span> <span class="o">-=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">y</span> <span class="o">-=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">z</span> <span class="o">-=</span> <span class="nx">area</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="mi">6</span> <span class="o">*</span> <span class="nx">z</span><span class="p">];</span> <span class="c1">// weighted centroid</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">centroidType</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">centroid</span> <span class="o">=</span> <span class="nx">d3_geo_type</span><span class="p">({</span></pre></div></td></tr>


<tr id="section-205"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-205">&#182;</a></div><p>TODO FeatureCollection
TODO Point
TODO MultiPoint
TODO LineString
TODO MultiLineString
TODO GeometryCollection</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">Feature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">centroidType</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Polygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">centroid</span> <span class="o">=</span> <span class="nx">polygonCentroid</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">);</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
    <span class="p">},</span>

    <span class="nx">MultiPolygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">area</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span>
          <span class="nx">centroid</span><span class="p">,</span>
          <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// coordinates index</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">centroid</span> <span class="o">=</span> <span class="nx">polygonCentroid</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="nx">x</span> <span class="o">+=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">y</span> <span class="o">+=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">z</span> <span class="o">+=</span> <span class="nx">centroid</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">z</span><span class="p">,</span> <span class="nx">y</span> <span class="o">/</span> <span class="nx">z</span><span class="p">];</span>
    <span class="p">}</span>

  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">area</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">polygon</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">projection</span><span class="p">)).</span><span class="nx">area</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="nx">path</span><span class="p">.</span><span class="nx">projection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">projection</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">path</span><span class="p">.</span><span class="nx">pointRadius</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">x</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="nx">pointRadius</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">pointRadius</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
      <span class="nx">pointCircle</span> <span class="o">=</span> <span class="nx">d3_path_circle</span><span class="p">(</span><span class="nx">pointRadius</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">path</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_path_circle</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="s2">&quot;m0,&quot;</span> <span class="o">+</span> <span class="nx">radius</span>
      <span class="o">+</span> <span class="s2">&quot;a&quot;</span> <span class="o">+</span> <span class="nx">radius</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">radius</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">radius</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;a&quot;</span> <span class="o">+</span> <span class="nx">radius</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span> <span class="o">+</span> <span class="nx">radius</span> <span class="o">+</span> <span class="s2">&quot; 0 1,1 0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="o">+</span><span class="mi">2</span> <span class="o">*</span> <span class="nx">radius</span><span class="p">)</span>
      <span class="o">+</span> <span class="s2">&quot;z&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Given a GeoJSON object, returns the corresponding bounding box. The bounding</span>
<span class="cm"> * box is represented by a two-dimensional array: [[left, bottom], [right,</span>
<span class="cm"> * top]], where left is the minimum longitude, bottom is the minimum latitude,</span>
<span class="cm"> * right is maximum longitude, and top is the maximum latitude.</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">bounds</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feature</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">bottom</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">right</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span>
      <span class="nx">top</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span>
  <span class="nx">d3_geo_bounds</span><span class="p">(</span><span class="nx">feature</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">left</span><span class="p">)</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">right</span><span class="p">)</span> <span class="nx">right</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">bottom</span><span class="p">)</span> <span class="nx">bottom</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">top</span><span class="p">)</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">y</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="k">return</span> <span class="p">[[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">bottom</span><span class="p">],</span> <span class="p">[</span><span class="nx">right</span><span class="p">,</span> <span class="nx">top</span><span class="p">]];</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geo_bounds</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">d3_geo_boundsTypes</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">))</span> <span class="nx">d3_geo_boundsTypes</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">](</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_geo_boundsTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">Feature</span><span class="o">:</span> <span class="nx">d3_geo_boundsFeature</span><span class="p">,</span>
  <span class="nx">FeatureCollection</span><span class="o">:</span> <span class="nx">d3_geo_boundsFeatureCollection</span><span class="p">,</span>
  <span class="nx">GeometryCollection</span><span class="o">:</span> <span class="nx">d3_geo_boundsGeometryCollection</span><span class="p">,</span>
  <span class="nx">LineString</span><span class="o">:</span> <span class="nx">d3_geo_boundsLineString</span><span class="p">,</span>
  <span class="nx">MultiLineString</span><span class="o">:</span> <span class="nx">d3_geo_boundsMultiLineString</span><span class="p">,</span>
  <span class="nx">MultiPoint</span><span class="o">:</span> <span class="nx">d3_geo_boundsLineString</span><span class="p">,</span>
  <span class="nx">MultiPolygon</span><span class="o">:</span> <span class="nx">d3_geo_boundsMultiPolygon</span><span class="p">,</span>
  <span class="nx">Point</span><span class="o">:</span> <span class="nx">d3_geo_boundsPoint</span><span class="p">,</span>
  <span class="nx">Polygon</span><span class="o">:</span> <span class="nx">d3_geo_boundsPolygon</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsFeature</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_geo_bounds</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">f</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsFeatureCollection</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">features</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_geo_bounds</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geometry</span><span class="p">,</span> <span class="nx">f</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsGeometryCollection</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometries</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_geo_bounds</span><span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">f</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsLineString</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsMultiLineString</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsMultiPolygon</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">,</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">b</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsPoint</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_boundsPolygon</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">f</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">a</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-206"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-206">&#182;</a></div><p>TODO breakAtDateLine?</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">circle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
      <span class="nx">degrees</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span>
      <span class="nx">radians</span> <span class="o">=</span> <span class="nx">degrees</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
      <span class="nx">arc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">greatArc</span><span class="p">().</span><span class="nx">target</span><span class="p">(</span><span class="nx">d3_identity</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">circle</span><span class="p">()</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-207"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-207">&#182;</a></div><p>TODO render a circle as a Polygon</p></td><td class="code"><div class="highlight"><pre>  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">visible</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">point</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">radians</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">circle</span><span class="p">.</span><span class="nx">clip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">arc</span><span class="p">.</span><span class="nx">source</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">origin</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">origin</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span> <span class="nx">origin</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">clipType</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">clipType</span> <span class="o">=</span> <span class="nx">d3_geo_type</span><span class="p">({</span>

    <span class="nx">FeatureCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">features</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clipType</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">d3_identity</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">features</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">features</span> <span class="o">=</span> <span class="nx">features</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Feature</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="nx">clipType</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">geometry</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometry</span> <span class="o">=</span> <span class="nx">geometry</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Point</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">visible</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">MultiPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">visible</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="nx">o</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span>
        <span class="nx">coordinates</span><span class="o">:</span> <span class="nx">coordinates</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">LineString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">clip</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">MultiLineString</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clip</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">Polygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clip</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">MultiPolygon</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clip</span><span class="p">);</span> <span class="p">}).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span> <span class="p">});</span>
      <span class="k">return</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">coordinates</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">GeometryCollection</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">geometries</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometries</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">clipType</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">d3_identity</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">geometries</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">o</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">o</span><span class="p">),</span> <span class="nx">o</span><span class="p">.</span><span class="nx">geometries</span> <span class="o">=</span> <span class="nx">geometries</span><span class="p">,</span> <span class="nx">o</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">clip</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">clipped</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">p0</span><span class="p">,</span>
        <span class="nx">p1</span><span class="p">,</span>
        <span class="nx">p2</span><span class="p">,</span>
        <span class="nx">d0</span><span class="p">,</span>
        <span class="nx">d1</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d1</span> <span class="o">=</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p2</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">d1</span> <span class="o">&lt;</span> <span class="nx">radians</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p1</span><span class="p">)</span> <span class="nx">clipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)((</span><span class="nx">d0</span> <span class="o">-</span> <span class="nx">radians</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">d0</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">)));</span>
        <span class="nx">clipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">p2</span><span class="p">);</span>
        <span class="nx">p0</span> <span class="o">=</span> <span class="nx">p1</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">p1</span> <span class="o">=</span> <span class="nx">p2</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p0</span> <span class="o">&amp;&amp;</span> <span class="nx">clipped</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">clipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">clipped</span><span class="p">[</span><span class="nx">clipped</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span> <span class="nx">p1</span><span class="p">)((</span><span class="nx">radians</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">d1</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">)));</span>
          <span class="nx">p0</span> <span class="o">=</span> <span class="nx">p1</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">d0</span> <span class="o">=</span> <span class="nx">d1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">p1</span> <span class="o">&amp;&amp;</span> <span class="nx">clipped</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">d1</span> <span class="o">=</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p2</span> <span class="o">=</span> <span class="nx">clipped</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
      <span class="nx">clipped</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">p1</span><span class="p">,</span> <span class="nx">p2</span><span class="p">)((</span><span class="nx">d0</span> <span class="o">-</span> <span class="nx">radians</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">d0</span> <span class="o">-</span> <span class="nx">d1</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">resample</span><span class="p">(</span><span class="nx">clipped</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-208"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-208">&#182;</a></div><p>Resample coordinates, creating great arcs between each.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">resample</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">m</span><span class="p">,</span>
        <span class="nx">resampled</span> <span class="o">=</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">[</span><span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">:</span> <span class="nx">coordinates</span><span class="p">,</span>
        <span class="nx">resamples</span><span class="p">,</span>
        <span class="nx">origin</span> <span class="o">=</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">source</span><span class="p">();</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">resamples</span> <span class="o">=</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">source</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])(</span><span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">coordinates</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">resamples</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;)</span> <span class="nx">resampled</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">resamples</span><span class="p">[</span><span class="nx">j</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="nx">arc</span><span class="p">.</span><span class="nx">source</span><span class="p">(</span><span class="nx">origin</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">resampled</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">circle</span><span class="p">.</span><span class="nx">origin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">origin</span><span class="p">;</span>
    <span class="nx">origin</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">circle</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">circle</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">degrees</span><span class="p">;</span>
    <span class="nx">radians</span> <span class="o">=</span> <span class="p">(</span><span class="nx">degrees</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">)</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">circle</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-209"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-209">&#182;</a></div><p>Precision is specified in degrees.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">circle</span><span class="p">.</span><span class="nx">precision</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">arc</span><span class="p">.</span><span class="nx">precision</span><span class="p">();</span>
    <span class="nx">arc</span><span class="p">.</span><span class="nx">precision</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">circle</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">circle</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">greatArc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">source</span> <span class="o">=</span> <span class="nx">d3_geo_greatArcSource</span><span class="p">,</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">d3_geo_greatArcTarget</span><span class="p">,</span>
      <span class="nx">precision</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">greatArc</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">source</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span> <span class="nx">source</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">target</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span> <span class="nx">target</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">),</span>
        <span class="nx">dt</span> <span class="o">=</span> <span class="nx">precision</span> <span class="o">/</span> <span class="nx">i</span><span class="p">.</span><span class="nx">d</span><span class="p">,</span>
        <span class="nx">t</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">coordinates</span> <span class="o">=</span> <span class="p">[</span><span class="nx">a</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">((</span><span class="nx">t</span> <span class="o">+=</span> <span class="nx">dt</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">(</span><span class="nx">t</span><span class="p">));</span>
    <span class="nx">coordinates</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;LineString&quot;</span><span class="p">,</span>
      <span class="nx">coordinates</span><span class="o">:</span> <span class="nx">coordinates</span>
    <span class="p">};</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-210"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-210">&#182;</a></div><p>Length returned in radians; multiply by radius for distance.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">greatArc</span><span class="p">.</span><span class="nx">distance</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">source</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">source</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span> <span class="nx">source</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s2">&quot;function&quot;</span> <span class="o">?</span> <span class="nx">target</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span> <span class="o">:</span> <span class="nx">target</span><span class="p">;</span>
     <span class="k">return</span> <span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">).</span><span class="nx">d</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">greatArc</span><span class="p">.</span><span class="nx">source</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">source</span><span class="p">;</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">greatArc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">greatArc</span><span class="p">.</span><span class="nx">target</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">greatArc</span><span class="p">;</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-211"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-211">&#182;</a></div><p>Precision is specified in degrees.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">greatArc</span><span class="p">.</span><span class="nx">precision</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">precision</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="nx">precision</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">greatArc</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">greatArc</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geo_greatArcSource</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_greatArcTarget</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geo_greatArcInterpolate</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span> <span class="nx">cx0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">x0</span><span class="p">),</span> <span class="nx">sx0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">x0</span><span class="p">),</span>
      <span class="nx">y0</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span> <span class="nx">cy0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y0</span><span class="p">),</span> <span class="nx">sy0</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">y0</span><span class="p">),</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span> <span class="nx">cx1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span> <span class="nx">sx1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">x1</span><span class="p">),</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">d3_geo_radians</span><span class="p">,</span> <span class="nx">cy1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">y1</span><span class="p">),</span> <span class="nx">sy1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">y1</span><span class="p">),</span>
      <span class="nx">d</span> <span class="o">=</span> <span class="nx">interpolate</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">acos</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">sy0</span> <span class="o">*</span> <span class="nx">sy1</span> <span class="o">+</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">x1</span> <span class="o">-</span> <span class="nx">x0</span><span class="p">)))),</span>
      <span class="nx">sd</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-212"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-212">&#182;</a></div><p>From http://williams.best.vwh.net/avform.htm#Intermediate</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">interpolate</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">A</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="p">(</span><span class="nx">t</span> <span class="o">*=</span> <span class="nx">d</span><span class="p">))</span> <span class="o">/</span> <span class="nx">sd</span><span class="p">,</span>
        <span class="nx">B</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="o">/</span> <span class="nx">sd</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">A</span> <span class="o">*</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">cx0</span> <span class="o">+</span> <span class="nx">B</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nx">cx1</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">A</span> <span class="o">*</span> <span class="nx">cy0</span> <span class="o">*</span> <span class="nx">sx0</span> <span class="o">+</span> <span class="nx">B</span> <span class="o">*</span> <span class="nx">cy1</span> <span class="o">*</span> <span class="nx">sx1</span><span class="p">,</span>
        <span class="nx">z</span> <span class="o">=</span> <span class="nx">A</span> <span class="o">*</span> <span class="nx">sy0</span>       <span class="o">+</span> <span class="nx">B</span> <span class="o">*</span> <span class="nx">sy1</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">[</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span><span class="p">,</span>
      <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">z</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">y</span><span class="p">))</span> <span class="o">/</span> <span class="nx">d3_geo_radians</span>
    <span class="p">];</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">interpolate</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">greatCircle</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">geo</span><span class="p">.</span><span class="nx">circle</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span> <span class="o">=</span> <span class="p">{};</span>
<span class="cm">/**</span>
<span class="cm"> * Computes a contour for a given input grid function using the &lt;a</span>
<span class="cm"> * href=&quot;http://en.wikipedia.org/wiki/Marching_squares&quot;&gt;marching</span>
<span class="cm"> * squares&lt;/a&gt; algorithm. Returns the contour polygon as an array of points.</span>
<span class="cm"> *</span>
<span class="cm"> * @param grid a two-input function(x, y) that returns true for values</span>
<span class="cm"> * inside the contour and false for values outside the contour.</span>
<span class="cm"> * @param start an optional starting point [x, y] on the grid.</span>
<span class="cm"> * @returns polygon [[x1, y1], [x2, y2], â¦]</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">contour</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">grid</span><span class="p">,</span> <span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">start</span> <span class="o">||</span> <span class="nx">d3_geom_contourStart</span><span class="p">(</span><span class="nx">grid</span><span class="p">),</span> <span class="c1">// starting point</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="p">[],</span>    <span class="c1">// contour polygon</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1">// current x position</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1">// current y position</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1">// next x direction</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>    <span class="c1">// next y direction</span>
      <span class="nx">pdx</span> <span class="o">=</span> <span class="kc">NaN</span><span class="p">,</span> <span class="c1">// previous x direction</span>
      <span class="nx">pdy</span> <span class="o">=</span> <span class="kc">NaN</span><span class="p">,</span> <span class="c1">// previous y direction</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="k">do</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-213"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-213">&#182;</a></div><p>determine marching squares index</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">grid</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">y</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">grid</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span>   <span class="nx">y</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">grid</span><span class="p">(</span><span class="nx">x</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">y</span>  <span class="p">))</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">grid</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span>   <span class="nx">y</span>  <span class="p">))</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-214"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-214">&#182;</a></div><p>determine next direction</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">pdy</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">pdx</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">dx</span> <span class="o">=</span> <span class="nx">d3_geom_contourDx</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">dy</span> <span class="o">=</span> <span class="nx">d3_geom_contourDy</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-215"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-215">&#182;</a></div><p>update contour polygon</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">!=</span> <span class="nx">pdx</span> <span class="o">&amp;&amp;</span> <span class="nx">dy</span> <span class="o">!=</span> <span class="nx">pdy</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">c</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]);</span>
      <span class="nx">pdx</span> <span class="o">=</span> <span class="nx">dx</span><span class="p">;</span>
      <span class="nx">pdy</span> <span class="o">=</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">x</span> <span class="o">+=</span> <span class="nx">dx</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">+=</span> <span class="nx">dy</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">x</span> <span class="o">||</span> <span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">y</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">c</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-216"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-216">&#182;</a></div><p>lookup tables for marching directions</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_geom_contourDx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="kc">NaN</span><span class="p">],</span>
    <span class="nx">d3_geom_contourDy</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="kc">NaN</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">d3_geom_contourStart</span><span class="p">(</span><span class="nx">grid</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-217"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-217">&#182;</a></div><p>search for a starting point; begin at origin
and proceed along outward-expanding diagonals</p></td><td class="code"><div class="highlight"><pre>  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">grid</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">x</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm"> * Computes the 2D convex hull of a set of points using Graham&#39;s scanning</span>
<span class="cm"> * algorithm. The algorithm has been implemented as described in Cormen,</span>
<span class="cm"> * Leiserson, and Rivest&#39;s Introduction to Algorithms. The running time of</span>
<span class="cm"> * this algorithm is O(n log n), where n is the number of input points.</span>
<span class="cm"> *</span>
<span class="cm"> * @param vertices [[x1, y1], [x2, y2], â¦]</span>
<span class="cm"> * @returns polygon [[x1, y1], [x2, y2], â¦]</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">hull</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertices</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="p">[];</span>

  <span class="kd">var</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">plen</span> <span class="o">=</span> <span class="nx">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
      <span class="nx">points</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">stack</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">,</span> <span class="nx">u</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">sp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-218"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-218">&#182;</a></div><p>find the starting ref point: leftmost point with the minimum y coord</p></td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">h</span> <span class="o">=</span> <span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">:</span> <span class="nx">h</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-219"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-219">&#182;</a></div><p>calculate polar angles from ref point and sort</p></td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">===</span> <span class="nx">h</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
    <span class="nx">y1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">x1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">points</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">angle</span><span class="o">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">y1</span><span class="p">,</span> <span class="nx">x1</span><span class="p">),</span> <span class="nx">index</span><span class="o">:</span> <span class="nx">i</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">points</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">angle</span><span class="p">;</span> <span class="p">});</span></pre></div></td></tr>


<tr id="section-220"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-220">&#182;</a></div><p>toss out duplicate angles</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">a</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">angle</span><span class="p">;</span>
  <span class="nx">v</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">index</span><span class="p">;</span>
  <span class="nx">u</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">plen</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">j</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">index</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">==</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">angle</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-221"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-221">&#182;</a></div><p>keep angle for point most distant from the reference</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">v</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">v</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">x2</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">y2</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">h</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">x1</span><span class="o">*</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">y1</span><span class="o">*</span><span class="nx">y1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="nx">x2</span><span class="o">*</span><span class="nx">x2</span> <span class="o">+</span> <span class="nx">y2</span><span class="o">*</span><span class="nx">y2</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">points</span><span class="p">[</span><span class="nx">u</span><span class="p">].</span><span class="nx">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">angle</span><span class="p">;</span>
        <span class="nx">u</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="nx">v</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">angle</span><span class="p">;</span>
      <span class="nx">u</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">j</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-222"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-222">&#182;</a></div><p>initialize the stack</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">index</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">index</span><span class="p">);</span>
      <span class="nx">i</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">sp</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-223"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-223">&#182;</a></div><p>do graham's scan</p></td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="p">(;</span> <span class="nx">j</span><span class="o">&lt;</span><span class="nx">plen</span><span class="p">;</span> <span class="o">++</span><span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">index</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span> <span class="c1">// skip tossed out points</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_geom_hullCCW</span><span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">sp</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">sp</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">points</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">index</span><span class="p">,</span> <span class="nx">vertices</span><span class="p">))</span> <span class="p">{</span>
      <span class="o">--</span><span class="nx">sp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">stack</span><span class="p">[</span><span class="nx">sp</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">index</span><span class="p">;</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-224"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-224">&#182;</a></div><p>construct the hull</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">poly</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">sp</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">poly</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">stack</span><span class="p">[</span><span class="nx">i</span><span class="p">]]);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">poly</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-225"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-225">&#182;</a></div><p>are three points in counter-clockwise order?</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_geom_hullCCW</span><span class="p">(</span><span class="nx">i1</span><span class="p">,</span> <span class="nx">i2</span><span class="p">,</span> <span class="nx">i3</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">f</span><span class="p">;</span>
  <span class="nx">t</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">i1</span><span class="p">];</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="nx">t</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">i2</span><span class="p">];</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="nx">t</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="nx">i3</span><span class="p">];</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">t</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="k">return</span> <span class="p">((</span><span class="nx">f</span><span class="o">-</span><span class="nx">b</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">c</span><span class="o">-</span><span class="nx">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">d</span><span class="o">-</span><span class="nx">b</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">e</span><span class="o">-</span><span class="nx">a</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-226"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-226">&#182;</a></div><p>Note: requires coordinates to be counterclockwise and convex!</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">polygon</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coordinates</span><span class="p">)</span> <span class="p">{</span>

  <span class="nx">coordinates</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">+=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">b</span> <span class="o">+=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">a</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">coordinates</span><span class="p">.</span><span class="nx">centroid</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">a</span><span class="p">,</span>
        <span class="nx">b</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="nx">c</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="nx">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">area</span><span class="p">());</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">x</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="nx">c</span><span class="p">;</span>
      <span class="nx">y</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="nx">c</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">y</span> <span class="o">*</span> <span class="nx">k</span><span class="p">];</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-227"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-227">&#182;</a></div><p>The Sutherland-Hodgman clipping algorithm.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">coordinates</span><span class="p">.</span><span class="nx">clip</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">subject</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">input</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">n</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
        <span class="nx">j</span><span class="p">,</span>
        <span class="nx">m</span><span class="p">,</span>
        <span class="nx">a</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">],</span>
        <span class="nx">b</span><span class="p">,</span>
        <span class="nx">c</span><span class="p">,</span>
        <span class="nx">d</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">input</span> <span class="o">=</span> <span class="nx">subject</span><span class="p">.</span><span class="nx">slice</span><span class="p">();</span>
      <span class="nx">subject</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">b</span> <span class="o">=</span> <span class="nx">coordinates</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">c</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="nx">input</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">d3_geom_polygonInside</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">d3_geom_polygonInside</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">subject</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_geom_polygonIntersect</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">));</span>
          <span class="p">}</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d3_geom_polygonInside</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">subject</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">d3_geom_polygonIntersect</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="nx">c</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">subject</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">coordinates</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geom_polygonInside</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-228"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-228">&#182;</a></div><p>Intersect two infinite lines cd and ab.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_geom_polygonIntersect</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x3</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x4</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y3</span> <span class="o">=</span> <span class="nx">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">y4</span> <span class="o">=</span> <span class="nx">b</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
      <span class="nx">x13</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">-</span> <span class="nx">x3</span><span class="p">,</span>
      <span class="nx">x21</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">-</span> <span class="nx">x1</span><span class="p">,</span>
      <span class="nx">x43</span> <span class="o">=</span> <span class="nx">x4</span> <span class="o">-</span> <span class="nx">x3</span><span class="p">,</span>
      <span class="nx">y13</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">-</span> <span class="nx">y3</span><span class="p">,</span>
      <span class="nx">y21</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">-</span> <span class="nx">y1</span><span class="p">,</span>
      <span class="nx">y43</span> <span class="o">=</span> <span class="nx">y4</span> <span class="o">-</span> <span class="nx">y3</span><span class="p">,</span>
      <span class="nx">ua</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x43</span> <span class="o">*</span> <span class="nx">y13</span> <span class="o">-</span> <span class="nx">y43</span> <span class="o">*</span> <span class="nx">x13</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">y43</span> <span class="o">*</span> <span class="nx">x21</span> <span class="o">-</span> <span class="nx">x43</span> <span class="o">*</span> <span class="nx">y21</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">ua</span> <span class="o">*</span> <span class="nx">x21</span><span class="p">,</span> <span class="nx">y1</span> <span class="o">+</span> <span class="nx">ua</span> <span class="o">*</span> <span class="nx">y21</span><span class="p">];</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-229"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-229">&#182;</a></div><p>Adapted from Nicolas Garcia Belmonte's JIT implementation:
http://blog.thejit.org/2010/02/12/voronoi-tessellation/
http://blog.thejit.org/assets/voronoijs/voronoi.js
See lib/jit/LICENSE for details.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-230"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-230">&#182;</a></div><p>Notes:</p>

<p>This implementation does not clip the returned polygons, so if you want to
clip them to a particular shape you will need to do that either in SVG or by
post-processing with d3.geom.polygon's clip method.</p>

<p>If any vertices are coincident or have NaN positions, the behavior of this
method is undefined. Most likely invalid polygons will be returned. You
should filter invalid points, and consolidate coincident points, before
computing the tessellation.</p></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * @param vertices [[x1, y1], [x2, y2], â¦]</span>
<span class="cm"> * @returns polygons [[[x1, y1], [x2, y2], â¦], â¦]</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">voronoi</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertices</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">polygons</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">});</span>

  <span class="nx">d3_voronoi_tessellate</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">s1</span><span class="p">,</span>
        <span class="nx">s2</span><span class="p">,</span>
        <span class="nx">x1</span><span class="p">,</span>
        <span class="nx">x2</span><span class="p">,</span>
        <span class="nx">y1</span><span class="p">,</span>
        <span class="nx">y2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">s1</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
      <span class="nx">s2</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">s1</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span>
      <span class="nx">s2</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ep</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">s1</span> <span class="o">?</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">y</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">e6</span><span class="p">;</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="nx">y2</span> <span class="o">=</span> <span class="nx">s2</span> <span class="o">?</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">y</span> <span class="o">:</span> <span class="mi">1</span><span class="nx">e6</span><span class="p">;</span>
      <span class="nx">x2</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">y2</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">s1</span> <span class="o">?</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">x</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="nx">e6</span><span class="p">;</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">x1</span><span class="p">;</span>
      <span class="nx">x2</span> <span class="o">=</span> <span class="nx">s2</span> <span class="o">?</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">x</span> <span class="o">:</span> <span class="mi">1</span><span class="nx">e6</span><span class="p">;</span>
      <span class="nx">y2</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">x2</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">v1</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">],</span>
        <span class="nx">v2</span> <span class="o">=</span> <span class="p">[</span><span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">];</span>
    <span class="nx">polygons</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">);</span>
    <span class="nx">polygons</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">);</span>
  <span class="p">});</span></pre></div></td></tr>


<tr id="section-231"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-231">&#182;</a></div><p>Reconnect the polygon segments into counterclockwise loops.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">polygons</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">polygon</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cx</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">cy</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">polygon</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">cx</span><span class="p">,</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">cy</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">polygon</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">angle</span><span class="p">;</span>
    <span class="p">}).</span><span class="nx">filter</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">!</span><span class="nx">i</span> <span class="o">||</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-</span> <span class="nx">polygon</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="nx">angle</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">10</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_voronoi_opposite</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="s2">&quot;l&quot;</span><span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_voronoi_tessellate</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">Sites</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">list</span><span class="o">:</span> <span class="nx">vertices</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
          <span class="nx">index</span><span class="o">:</span> <span class="nx">i</span><span class="p">,</span>
          <span class="nx">x</span><span class="o">:</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">y</span><span class="o">:</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="p">};</span>
      <span class="p">})</span>
      <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span>
          <span class="o">:</span> <span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span> <span class="o">?</span> <span class="mi">1</span>
          <span class="o">:</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span>
          <span class="o">:</span> <span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span> <span class="o">?</span> <span class="mi">1</span>
          <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}),</span>
    <span class="nx">bottomSite</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">EdgeList</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">list</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">leftEnd</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">rightEnd</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>

    <span class="nx">init</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">createHalfEdge</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">createHalfEdge</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span><span class="p">;</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span><span class="p">;</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span><span class="p">,</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">createHalfEdge</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">side</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">edge</span><span class="o">:</span> <span class="nx">edge</span><span class="p">,</span>
        <span class="nx">side</span><span class="o">:</span> <span class="nx">side</span><span class="p">,</span>
        <span class="nx">vertex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="kc">null</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lb</span><span class="p">,</span> <span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">lb</span><span class="p">;</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
      <span class="nx">lb</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">he</span><span class="p">;</span>
      <span class="nx">lb</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">he</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">leftBound</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">he</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="nx">he</span> <span class="o">=</span> <span class="nx">he</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="nx">he</span> <span class="o">!=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span> <span class="o">&amp;&amp;</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">rightOf</span><span class="p">(</span><span class="nx">he</span><span class="p">,</span> <span class="nx">p</span><span class="p">));</span>
      <span class="nx">he</span> <span class="o">=</span> <span class="nx">he</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nx">r</span> <span class="o">=</span> <span class="nx">he</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">l</span> <span class="o">=</span> <span class="nx">he</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">right</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">.</span><span class="nx">r</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">left</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">.</span><span class="nx">l</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">leftRegion</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span> <span class="o">==</span> <span class="kc">null</span>
          <span class="o">?</span> <span class="nx">Sites</span><span class="p">.</span><span class="nx">bottomSite</span>
          <span class="o">:</span> <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span><span class="p">.</span><span class="nx">region</span><span class="p">[</span><span class="nx">he</span><span class="p">.</span><span class="nx">side</span><span class="p">];</span>
    <span class="p">},</span>

    <span class="nx">rightRegion</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span> <span class="o">==</span> <span class="kc">null</span>
          <span class="o">?</span> <span class="nx">Sites</span><span class="p">.</span><span class="nx">bottomSite</span>
          <span class="o">:</span> <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span><span class="p">.</span><span class="nx">region</span><span class="p">[</span><span class="nx">d3_voronoi_opposite</span><span class="p">[</span><span class="nx">he</span><span class="p">.</span><span class="nx">side</span><span class="p">]];</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">Geom</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">bisect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s1</span><span class="p">,</span> <span class="nx">s2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">newEdge</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">region</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="nx">s1</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="nx">s2</span><span class="p">},</span>
        <span class="nx">ep</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;l&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="o">:</span> <span class="kc">null</span><span class="p">}</span>
      <span class="p">};</span>

      <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
          <span class="nx">dy</span> <span class="o">=</span> <span class="nx">s2</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
          <span class="nx">adx</span> <span class="o">=</span> <span class="nx">dx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">dx</span> <span class="o">:</span> <span class="o">-</span><span class="nx">dx</span><span class="p">,</span>
          <span class="nx">ady</span> <span class="o">=</span> <span class="nx">dy</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nx">dy</span> <span class="o">:</span> <span class="o">-</span><span class="nx">dy</span><span class="p">;</span>

      <span class="nx">newEdge</span><span class="p">.</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">s1</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">dy</span>
          <span class="o">+</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">adx</span> <span class="o">&gt;</span> <span class="nx">ady</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="nx">dy</span> <span class="o">/</span> <span class="nx">dx</span><span class="p">;</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">c</span> <span class="o">/=</span> <span class="nx">dx</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">a</span> <span class="o">=</span> <span class="nx">dx</span> <span class="o">/</span> <span class="nx">dy</span><span class="p">;</span>
        <span class="nx">newEdge</span><span class="p">.</span><span class="nx">c</span> <span class="o">/=</span> <span class="nx">dy</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">newEdge</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">intersect</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">el1</span><span class="p">,</span> <span class="nx">el2</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">e1</span> <span class="o">=</span> <span class="nx">el1</span><span class="p">.</span><span class="nx">edge</span><span class="p">,</span>
          <span class="nx">e2</span> <span class="o">=</span> <span class="nx">el2</span><span class="p">.</span><span class="nx">edge</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">e1</span> <span class="o">||</span> <span class="o">!</span><span class="nx">e2</span> <span class="o">||</span> <span class="p">(</span><span class="nx">e1</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span> <span class="o">==</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e1</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">e1</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">a</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="nx">e</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">xint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e1</span><span class="p">.</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">b</span> <span class="o">-</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">e1</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">,</span>
          <span class="nx">yint</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e2</span><span class="p">.</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">e1</span><span class="p">.</span><span class="nx">a</span> <span class="o">-</span> <span class="nx">e1</span><span class="p">.</span><span class="nx">c</span> <span class="o">*</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">a</span><span class="p">)</span> <span class="o">/</span> <span class="nx">d</span><span class="p">,</span>
          <span class="nx">e1r</span> <span class="o">=</span> <span class="nx">e1</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
          <span class="nx">e2r</span> <span class="o">=</span> <span class="nx">e2</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
          <span class="nx">el</span><span class="p">,</span>
          <span class="nx">e</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">e1r</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">e2r</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">||</span>
         <span class="p">(</span><span class="nx">e1r</span><span class="p">.</span><span class="nx">y</span> <span class="o">==</span> <span class="nx">e2r</span><span class="p">.</span><span class="nx">y</span> <span class="o">&amp;&amp;</span> <span class="nx">e1r</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">e2r</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="nx">el1</span><span class="p">;</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e1</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="nx">el2</span><span class="p">;</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e2</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kd">var</span> <span class="nx">rightOfSite</span> <span class="o">=</span> <span class="p">(</span><span class="nx">xint</span> <span class="o">&gt;=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">((</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">side</span> <span class="o">===</span> <span class="s2">&quot;l&quot;</span><span class="p">))</span> <span class="o">||</span>
        <span class="p">(</span><span class="o">!</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">side</span> <span class="o">===</span> <span class="s2">&quot;r&quot;</span><span class="p">)))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">xint</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">yint</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">rightOf</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">he</span><span class="p">.</span><span class="nx">edge</span><span class="p">,</span>
          <span class="nx">topsite</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">,</span>
          <span class="nx">rightOfSite</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">x</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">he</span><span class="p">.</span><span class="nx">side</span> <span class="o">===</span> <span class="s2">&quot;l&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">he</span><span class="p">.</span><span class="nx">side</span> <span class="o">===</span> <span class="s2">&quot;r&quot;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dyp</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span>
            <span class="nx">dxp</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
            <span class="nx">fast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nx">above</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">rightOfSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
          <span class="nx">above</span> <span class="o">=</span> <span class="nx">fast</span> <span class="o">=</span> <span class="p">(</span><span class="nx">dyp</span> <span class="o">&gt;=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">dxp</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">above</span> <span class="o">=</span> <span class="p">((</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span><span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">above</span> <span class="o">=</span> <span class="o">!</span><span class="nx">above</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">above</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">fast</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fast</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">dxs</span> <span class="o">=</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
          <span class="nx">above</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="p">(</span><span class="nx">dxp</span> <span class="o">*</span> <span class="nx">dxp</span> <span class="o">-</span> <span class="nx">dyp</span> <span class="o">*</span> <span class="nx">dyp</span><span class="p">))</span> <span class="o">&lt;</span>
            <span class="p">(</span><span class="nx">dxs</span> <span class="o">*</span> <span class="nx">dyp</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">dxp</span> <span class="o">/</span> <span class="nx">dxs</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">*</span> <span class="nx">e</span><span class="p">.</span><span class="nx">b</span><span class="p">));</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">b</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">above</span> <span class="o">=</span> <span class="o">!</span><span class="nx">above</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="cm">/* e.b == 1 */</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">yl</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">c</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">a</span> <span class="o">*</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
            <span class="nx">t1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">yl</span><span class="p">,</span>
            <span class="nx">t2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
            <span class="nx">t3</span> <span class="o">=</span> <span class="nx">yl</span> <span class="o">-</span> <span class="nx">topsite</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>

        <span class="nx">above</span> <span class="o">=</span> <span class="p">(</span><span class="nx">t1</span> <span class="o">*</span> <span class="nx">t1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="nx">t2</span> <span class="o">*</span> <span class="nx">t2</span> <span class="o">+</span> <span class="nx">t3</span> <span class="o">*</span> <span class="nx">t3</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">he</span><span class="p">.</span><span class="nx">side</span> <span class="o">===</span> <span class="s2">&quot;l&quot;</span> <span class="o">?</span> <span class="nx">above</span> <span class="o">:</span> <span class="o">!</span><span class="nx">above</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">endPoint</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">side</span><span class="p">,</span> <span class="nx">site</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">edge</span><span class="p">.</span><span class="nx">ep</span><span class="p">[</span><span class="nx">side</span><span class="p">]</span> <span class="o">=</span> <span class="nx">site</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">edge</span><span class="p">.</span><span class="nx">ep</span><span class="p">[</span><span class="nx">d3_voronoi_opposite</span><span class="p">[</span><span class="nx">side</span><span class="p">]])</span> <span class="k">return</span><span class="p">;</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">edge</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">distance</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">t</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
          <span class="nx">dy</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">t</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">EventQueue</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">list</span><span class="o">:</span> <span class="p">[],</span>

    <span class="nx">insert</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">,</span> <span class="nx">site</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">vertex</span> <span class="o">=</span> <span class="nx">site</span><span class="p">;</span>
      <span class="nx">he</span><span class="p">.</span><span class="nx">ystar</span> <span class="o">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">list</span><span class="o">=</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">,</span> <span class="nx">l</span><span class="o">=</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">he</span><span class="p">.</span><span class="nx">ystar</span> <span class="o">&gt;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">ystar</span> <span class="o">||</span>
          <span class="p">(</span><span class="nx">he</span><span class="p">.</span><span class="nx">ystar</span> <span class="o">==</span> <span class="nx">next</span><span class="p">.</span><span class="nx">ystar</span> <span class="o">&amp;&amp;</span>
          <span class="nx">site</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">next</span><span class="p">.</span><span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">he</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">del</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ls</span><span class="o">=</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">,</span> <span class="nx">l</span><span class="o">=</span><span class="nx">ls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">ls</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">he</span><span class="p">);</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{}</span>
      <span class="nx">ls</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>

    <span class="nx">empty</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span> <span class="p">},</span>

    <span class="nx">nextEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">he</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ls</span><span class="o">=</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">,</span> <span class="nx">l</span><span class="o">=</span><span class="nx">ls</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">ls</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="nx">he</span><span class="p">)</span> <span class="k">return</span> <span class="nx">ls</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">min</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">elem</span> <span class="o">=</span> <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">x</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">vertex</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span>
        <span class="nx">y</span><span class="o">:</span> <span class="nx">elem</span><span class="p">.</span><span class="nx">ystar</span>
      <span class="p">};</span>
    <span class="p">},</span>

    <span class="nx">extractMin</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>
  <span class="nx">Sites</span><span class="p">.</span><span class="nx">bottomSite</span> <span class="o">=</span> <span class="nx">Sites</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">newSite</span> <span class="o">=</span> <span class="nx">Sites</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">(),</span> <span class="nx">newIntStar</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">lbnd</span><span class="p">,</span> <span class="nx">rbnd</span><span class="p">,</span> <span class="nx">llbnd</span><span class="p">,</span> <span class="nx">rrbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">bot</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">temp</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">v</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">pm</span><span class="p">;</span>

  <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">newIntStar</span> <span class="o">=</span> <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">min</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">newSite</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>
      <span class="o">||</span> <span class="nx">newSite</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">newIntStar</span><span class="p">.</span><span class="nx">y</span>
      <span class="o">||</span> <span class="p">(</span><span class="nx">newSite</span><span class="p">.</span><span class="nx">y</span> <span class="o">==</span> <span class="nx">newIntStar</span><span class="p">.</span><span class="nx">y</span>
      <span class="o">&amp;&amp;</span> <span class="nx">newSite</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">newIntStar</span><span class="p">.</span><span class="nx">x</span><span class="p">)))</span> <span class="p">{</span> <span class="c1">//new site is smallest</span>
      <span class="nx">lbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftBound</span><span class="p">(</span><span class="nx">newSite</span><span class="p">);</span>
      <span class="nx">rbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">bot</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightRegion</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">newSite</span><span class="p">);</span>
      <span class="nx">bisector</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">createHalfEdge</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;l&quot;</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">);</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">newSite</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">lbnd</span> <span class="o">=</span> <span class="nx">bisector</span><span class="p">;</span>
      <span class="nx">bisector</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">createHalfEdge</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">);</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">bisector</span><span class="p">,</span> <span class="nx">rbnd</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">bisector</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">newSite</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">newSite</span> <span class="o">=</span> <span class="nx">Sites</span><span class="p">.</span><span class="nx">list</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">EventQueue</span><span class="p">.</span><span class="nx">empty</span><span class="p">())</span> <span class="p">{</span> <span class="c1">//intersection is smallest</span>
      <span class="nx">lbnd</span> <span class="o">=</span> <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">extractMin</span><span class="p">();</span>
      <span class="nx">llbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">left</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">rbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">rrbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">rbnd</span><span class="p">);</span>
      <span class="nx">bot</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftRegion</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">top</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightRegion</span><span class="p">(</span><span class="nx">rbnd</span><span class="p">);</span>
      <span class="nx">v</span> <span class="o">=</span> <span class="nx">lbnd</span><span class="p">.</span><span class="nx">vertex</span><span class="p">;</span>
      <span class="nx">Geom</span><span class="p">.</span><span class="nx">endPoint</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">.</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">lbnd</span><span class="p">.</span><span class="nx">side</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
      <span class="nx">Geom</span><span class="p">.</span><span class="nx">endPoint</span><span class="p">(</span><span class="nx">rbnd</span><span class="p">.</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">rbnd</span><span class="p">.</span><span class="nx">side</span><span class="p">,</span> <span class="nx">v</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">);</span>
      <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">rbnd</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">rbnd</span><span class="p">);</span>
      <span class="nx">pm</span> <span class="o">=</span> <span class="s2">&quot;l&quot;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bot</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">top</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">temp</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">;</span>
        <span class="nx">bot</span> <span class="o">=</span> <span class="nx">top</span><span class="p">;</span>
        <span class="nx">top</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">;</span>
        <span class="nx">pm</span> <span class="o">=</span> <span class="s2">&quot;r&quot;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">top</span><span class="p">);</span>
      <span class="nx">bisector</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">createHalfEdge</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">pm</span><span class="p">);</span>
      <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">llbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">);</span>
      <span class="nx">Geom</span><span class="p">.</span><span class="nx">endPoint</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">d3_voronoi_opposite</span><span class="p">[</span><span class="nx">pm</span><span class="p">],</span> <span class="nx">v</span><span class="p">);</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">llbnd</span><span class="p">,</span> <span class="nx">bisector</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">del</span><span class="p">(</span><span class="nx">llbnd</span><span class="p">);</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">llbnd</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">bot</span><span class="p">));</span>
      <span class="p">}</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">intersect</span><span class="p">(</span><span class="nx">bisector</span><span class="p">,</span> <span class="nx">rrbnd</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">EventQueue</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">bisector</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Geom</span><span class="p">.</span><span class="nx">distance</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">bot</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span><span class="c1">//end while</span>

  <span class="k">for</span> <span class="p">(</span><span class="nx">lbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">EdgeList</span><span class="p">.</span><span class="nx">leftEnd</span><span class="p">);</span>
      <span class="nx">lbnd</span> <span class="o">!=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">rightEnd</span><span class="p">;</span>
      <span class="nx">lbnd</span> <span class="o">=</span> <span class="nx">EdgeList</span><span class="p">.</span><span class="nx">right</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">callback</span><span class="p">(</span><span class="nx">lbnd</span><span class="p">.</span><span class="nx">edge</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/**</span>
<span class="cm">* @param vertices [[x1, y1], [x2, y2], â¦]</span>
<span class="cm">* @returns triangles [[[x1, y1], [x2, y2], [x3, y3]], â¦]</span>
<span class="cm"> */</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">delaunay</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">vertices</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">edges</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="p">[];</span> <span class="p">}),</span>
      <span class="nx">triangles</span> <span class="o">=</span> <span class="p">[];</span></pre></div></td></tr>


<tr id="section-232"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-232">&#182;</a></div><p>Use the Voronoi tessellation to determine Delaunay edges.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">d3_voronoi_tessellate</span><span class="p">(</span><span class="nx">vertices</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">edges</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">l</span><span class="p">.</span><span class="nx">index</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">vertices</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">region</span><span class="p">.</span><span class="nx">r</span><span class="p">.</span><span class="nx">index</span><span class="p">]);</span>
  <span class="p">});</span></pre></div></td></tr>


<tr id="section-233"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-233">&#182;</a></div><p>Reconnect the edges into counterclockwise triangles.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">edges</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">edge</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">vertices</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">cx</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">cy</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">edge</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="nx">cx</span><span class="p">,</span> <span class="nx">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">cy</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">edge</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">angle</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">edge</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">m</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">triangles</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">v</span><span class="p">,</span> <span class="nx">edge</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span> <span class="nx">edge</span><span class="p">[</span><span class="nx">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="nx">triangles</span><span class="p">;</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-234"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-234">&#182;</a></div><p>Constructs a new quadtree for the specified array of points. A quadtree is a
two-dimensional recursive spatial subdivision. This implementation uses
square partitions, dividing each square into four equally-sized squares. Each
point exists in a unique node; if multiple points are in the same position,
some points may be stored on internal nodes rather than leaf nodes. Quadtrees
can be used to accelerate various spatial operations, such as the Barnes-Hut
approximation for computing n-body forces, or collision detection.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">quadtree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">p</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-235"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-235">&#182;</a></div><p>Type conversion for deprecated API.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">))</span> <span class="nx">points</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_geom_quadtreePoint</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-236"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-236">&#182;</a></div><p>Allow bounds to be specified explicitly.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">y2</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="nx">x2</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-237"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-237">&#182;</a></div><p>Compute bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">x1</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">y1</span><span class="p">)</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">x2</span><span class="p">)</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">y2</span><span class="p">)</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-238"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-238">&#182;</a></div><p>Squarify the bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">-</span> <span class="nx">x1</span><span class="p">,</span>
          <span class="nx">dy</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">-</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">&gt;</span> <span class="nx">dy</span><span class="p">)</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">+</span> <span class="nx">dx</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">+</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-239"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-239">&#182;</a></div><p>Recursively inserts the specified point p at the node n or one of its
descendants. The bounds are defined by [x1, x2] and [y1, y2].</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// ignore invalid points</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">leaf</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">point</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-240"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-240">&#182;</a></div><p>If the point at this leaf node is at the same position as the new
point we are adding, we leave the point associated with the
internal node while adding the new point to a child node. This
avoids infinite recursion.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">01</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">n</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-241"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-241">&#182;</a></div><p>Recursively inserts the specified point p into a descendant of node n. The
bounds are defined by [x1, x2] and [y1, y2].</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-242"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-242">&#182;</a></div><p>Compute the split point, and the quadrant in which to insert p.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">sx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">sy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">+</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">sx</span><span class="p">,</span>
        <span class="nx">bottom</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">sy</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bottom</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">right</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-243"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-243">&#182;</a></div><p>Recursively insert into the child node.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">n</span><span class="p">.</span><span class="nx">leaf</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">());</span></pre></div></td></tr>


<tr id="section-244"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-244">&#182;</a></div><p>Update the bounds as we recurse.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">sx</span><span class="p">;</span> <span class="k">else</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">sx</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bottom</span><span class="p">)</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">sy</span><span class="p">;</span> <span class="k">else</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">sy</span><span class="p">;</span>
    <span class="nx">insert</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-245"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-245">&#182;</a></div><p>Create the root node.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">();</span>

  <span class="nx">root</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">insert</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">root</span><span class="p">.</span><span class="nx">visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-246"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-246">&#182;</a></div><p>Insert all points.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">points</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">add</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">root</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">leaf</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">nodes</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">point</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">f</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">sy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">+</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodes</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">sy</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreePoint</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">x</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">y</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">d3_time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_time_utc</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="o">?</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="o">:</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="nx">d3_time_utc</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">getDate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getDay</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getFullYear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getHours</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getMilliseconds</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getMinutes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getMonth</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getSeconds</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getTime</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">getTime</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">getTimezoneOffset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">valueOf</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">.</span><span class="nx">valueOf</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">setDate</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCDate</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setDay</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCDay</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setFullYear</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCFullYear</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setHours</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCHours</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setMilliseconds</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCMilliseconds</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setMinutes</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCMinutes</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setMonth</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCMonth</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setSeconds</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setUTCSeconds</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">setTime</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">d3_time_prototype</span><span class="p">.</span><span class="nx">setTime</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_time_prototype</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">format</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">c</span><span class="p">,</span>
        <span class="nx">f</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">37</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">string</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span>
            <span class="nx">template</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
            <span class="p">(</span><span class="nx">f</span> <span class="o">=</span> <span class="nx">d3_time_formats</span><span class="p">[</span><span class="nx">c</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)])</span>
            <span class="o">?</span> <span class="nx">f</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">:</span> <span class="nx">c</span><span class="p">);</span>
        <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">string</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">j</span><span class="p">,</span> <span class="nx">i</span><span class="p">));</span>
    <span class="k">return</span> <span class="nx">string</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">format</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="p">{</span><span class="nx">y</span><span class="o">:</span> <span class="mi">1900</span><span class="p">,</span> <span class="nx">m</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">d</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">H</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">M</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">S</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">L</span><span class="o">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3_time_parse</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">!=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="kc">null</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-247"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-247">&#182;</a></div><p>The am-pm flag is 0 for AM, and 1 for PM.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;p&quot;</span> <span class="k">in</span> <span class="nx">d</span><span class="p">)</span> <span class="nx">d</span><span class="p">.</span><span class="nx">H</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">H</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">p</span> <span class="o">*</span> <span class="mi">12</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">();</span>
    <span class="nx">date</span><span class="p">.</span><span class="nx">setFullYear</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">m</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">d</span><span class="p">);</span>
    <span class="nx">date</span><span class="p">.</span><span class="nx">setHours</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">H</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">M</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">S</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">L</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">format</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">template</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_time_parse</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">template</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">j</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">c</span><span class="p">,</span>
      <span class="nx">p</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span> <span class="o">&gt;=</span> <span class="nx">m</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="nx">c</span> <span class="o">=</span> <span class="nx">template</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">==</span> <span class="mi">37</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">p</span> <span class="o">=</span> <span class="nx">d3_time_parsers</span><span class="p">[</span><span class="nx">template</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">++</span><span class="p">)];</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">p</span> <span class="o">||</span> <span class="p">((</span><span class="nx">j</span> <span class="o">=</span> <span class="nx">p</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">j</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">c</span> <span class="o">!=</span> <span class="nx">string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">j</span><span class="o">++</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">j</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_zfill2</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;02d&quot;</span><span class="p">),</span>
    <span class="nx">d3_time_zfill3</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;03d&quot;</span><span class="p">),</span>
    <span class="nx">d3_time_zfill4</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;04d&quot;</span><span class="p">),</span>
    <span class="nx">d3_time_sfill2</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">d3_time_formats</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">a</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_weekdays</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">A</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_weekdays</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()];</span> <span class="p">},</span>
  <span class="nx">b</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_months</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">B</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_months</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()];</span> <span class="p">},</span>
  <span class="nx">c</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%a %b %e %H:%M:%S %Y&quot;</span><span class="p">),</span>
  <span class="nx">d</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getDate</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">e</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_sfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getDate</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">H</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">I</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">%</span> <span class="mi">12</span> <span class="o">||</span> <span class="mi">12</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">j</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill3</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">dayOfYear</span><span class="p">(</span><span class="nx">d</span><span class="p">));</span> <span class="p">},</span>
  <span class="nx">L</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill3</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMilliseconds</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">m</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">M</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">p</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">?</span> <span class="s2">&quot;PM&quot;</span> <span class="o">:</span> <span class="s2">&quot;AM&quot;</span><span class="p">;</span> <span class="p">},</span>
  <span class="nx">S</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">());</span> <span class="p">},</span>
  <span class="nx">U</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">sundayOfYear</span><span class="p">(</span><span class="nx">d</span><span class="p">));</span> <span class="p">},</span>
  <span class="nx">w</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getDay</span><span class="p">();</span> <span class="p">},</span>
  <span class="nx">W</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">mondayOfYear</span><span class="p">(</span><span class="nx">d</span><span class="p">));</span> <span class="p">},</span>
  <span class="nx">x</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%m/%d/%y&quot;</span><span class="p">),</span>
  <span class="nx">X</span><span class="o">:</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%H:%M:%S&quot;</span><span class="p">),</span>
  <span class="nx">y</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">%</span> <span class="mi">100</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">Y</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d3_time_zfill4</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">%</span> <span class="mi">10000</span><span class="p">);</span> <span class="p">},</span>
  <span class="nx">Z</span><span class="o">:</span> <span class="nx">d3_time_zone</span><span class="p">,</span>
  <span class="s2">&quot;%&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;%&quot;</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">d3_time_parsers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">a</span><span class="o">:</span> <span class="nx">d3_time_parseWeekdayAbbrev</span><span class="p">,</span>
  <span class="nx">A</span><span class="o">:</span> <span class="nx">d3_time_parseWeekday</span><span class="p">,</span>
  <span class="nx">b</span><span class="o">:</span> <span class="nx">d3_time_parseMonthAbbrev</span><span class="p">,</span>
  <span class="nx">B</span><span class="o">:</span> <span class="nx">d3_time_parseMonth</span><span class="p">,</span>
  <span class="nx">c</span><span class="o">:</span> <span class="nx">d3_time_parseLocaleFull</span><span class="p">,</span>
  <span class="nx">d</span><span class="o">:</span> <span class="nx">d3_time_parseDay</span><span class="p">,</span>
  <span class="nx">e</span><span class="o">:</span> <span class="nx">d3_time_parseDay</span><span class="p">,</span>
  <span class="nx">H</span><span class="o">:</span> <span class="nx">d3_time_parseHour24</span><span class="p">,</span>
  <span class="nx">I</span><span class="o">:</span> <span class="nx">d3_time_parseHour24</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-248"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-248">&#182;</a></div><p>j: function(d, s, i) { /*TODO day of year [001,366] */ return i; },</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">L</span><span class="o">:</span> <span class="nx">d3_time_parseMilliseconds</span><span class="p">,</span>
  <span class="nx">m</span><span class="o">:</span> <span class="nx">d3_time_parseMonthNumber</span><span class="p">,</span>
  <span class="nx">M</span><span class="o">:</span> <span class="nx">d3_time_parseMinutes</span><span class="p">,</span>
  <span class="nx">p</span><span class="o">:</span> <span class="nx">d3_time_parseAmPm</span><span class="p">,</span>
  <span class="nx">S</span><span class="o">:</span> <span class="nx">d3_time_parseSeconds</span><span class="p">,</span></pre></div></td></tr>


<tr id="section-249"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-249">&#182;</a></div><p>U: function(d, s, i) { /<em>TODO week number (sunday) [00,53] */ return i; },
w: function(d, s, i) { /</em>TODO weekday [0,6] <em>/ return i; },
W: function(d, s, i) { /</em>TODO week number (monday) [00,53] */ return i; },</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">x</span><span class="o">:</span> <span class="nx">d3_time_parseLocaleDate</span><span class="p">,</span>
  <span class="nx">X</span><span class="o">:</span> <span class="nx">d3_time_parseLocaleTime</span><span class="p">,</span>
  <span class="nx">y</span><span class="o">:</span> <span class="nx">d3_time_parseYear</span><span class="p">,</span>
  <span class="nx">Y</span><span class="o">:</span> <span class="nx">d3_time_parseFullYear</span></pre></div></td></tr>


<tr id="section-250"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-250">&#182;</a></div><p>,
Z: function(d, s, i) { /<em>TODO time zone */ return i; },
"%": function(d, s, i) { /</em>TODO literal % */ return i; }</p></td><td class="code"><div class="highlight"><pre><span class="p">};</span></pre></div></td></tr>


<tr id="section-251"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-251">&#182;</a></div><p>Note: weekday is validated, but does not set the date.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_time_parseWeekdayAbbrev</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_weekdayAbbrevRe</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">))</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-252"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-252">&#182;</a></div><p>Note: weekday is validated, but does not set the date.</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_time_parseWeekday</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_weekdayRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_weekdayRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_weekdayAbbrevRe</span> <span class="o">=</span> <span class="sr">/^(?:sun|mon|tue|wed|thu|fri|sat)/i</span><span class="p">,</span>
    <span class="nx">d3_time_weekdayRe</span> <span class="o">=</span> <span class="sr">/^(?:Sunday|Monday|Tuesday|Wednesday|Thursday|Friday|Saturday)/i</span><span class="p">,</span>
    <span class="nx">d3_time_weekdays</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Sunday&quot;</span><span class="p">,</span> <span class="s2">&quot;Monday&quot;</span><span class="p">,</span> <span class="s2">&quot;Tuesday&quot;</span><span class="p">,</span> <span class="s2">&quot;Wednesday&quot;</span><span class="p">,</span> <span class="s2">&quot;Thursday&quot;</span><span class="p">,</span> <span class="s2">&quot;Friday&quot;</span><span class="p">,</span> <span class="s2">&quot;Saturday&quot;</span><span class="p">];</span>

<span class="kd">function</span> <span class="nx">d3_time_parseMonthAbbrev</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_monthAbbrevLookup</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">());</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_monthAbbrevLookup</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">jan</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">feb</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">mar</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">apr</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nx">may</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="nx">jun</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nx">jul</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
  <span class="nx">aug</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">sep</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
  <span class="nx">oct</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
  <span class="nx">nov</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nx">dec</span><span class="o">:</span> <span class="mi">11</span>
<span class="p">});</span>

<span class="kd">function</span> <span class="nx">d3_time_parseMonth</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_monthRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_monthRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">d3_time_monthLookup</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">()),</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_monthRe</span> <span class="o">=</span> <span class="sr">/^(?:January|February|March|April|May|June|July|August|September|October|November|December)/ig</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">d3_time_monthLookup</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">january</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">february</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">march</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nx">april</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nx">may</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
  <span class="nx">june</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="nx">july</span><span class="o">:</span> <span class="mi">6</span><span class="p">,</span>
  <span class="nx">august</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
  <span class="nx">september</span><span class="o">:</span> <span class="mi">8</span><span class="p">,</span>
  <span class="nx">october</span><span class="o">:</span> <span class="mi">9</span><span class="p">,</span>
  <span class="nx">november</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
  <span class="nx">december</span><span class="o">:</span> <span class="mi">11</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">d3_time_months</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s2">&quot;January&quot;</span><span class="p">,</span>
  <span class="s2">&quot;February&quot;</span><span class="p">,</span>
  <span class="s2">&quot;March&quot;</span><span class="p">,</span>
  <span class="s2">&quot;April&quot;</span><span class="p">,</span>
  <span class="s2">&quot;May&quot;</span><span class="p">,</span>
  <span class="s2">&quot;June&quot;</span><span class="p">,</span>
  <span class="s2">&quot;July&quot;</span><span class="p">,</span>
  <span class="s2">&quot;August&quot;</span><span class="p">,</span>
  <span class="s2">&quot;September&quot;</span><span class="p">,</span>
  <span class="s2">&quot;October&quot;</span><span class="p">,</span>
  <span class="s2">&quot;November&quot;</span><span class="p">,</span>
  <span class="s2">&quot;December&quot;</span>
<span class="p">];</span>

<span class="kd">function</span> <span class="nx">d3_time_parseLocaleFull</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_parse</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">d3_time_formats</span><span class="p">.</span><span class="nx">c</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseLocaleDate</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_parse</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">d3_time_formats</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseLocaleTime</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_parse</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">d3_time_formats</span><span class="p">.</span><span class="nx">X</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseFullYear</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseYear</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">d3_time_century</span><span class="p">()</span> <span class="o">+</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_century</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">~~</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseMonthNumber</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseDay</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">d</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-253"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-253">&#182;</a></div><p>Note: we don't validate that the hour is in the range [0,23] or [1,12].</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_time_parseHour24</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">H</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseMinutes</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">M</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseSeconds</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">S</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_parseMilliseconds</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_numberRe</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">?</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">L</span> <span class="o">=</span> <span class="o">+</span><span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">i</span> <span class="o">+=</span> <span class="nx">n</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-254"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-254">&#182;</a></div><p>Note: we don't look at the next directive.</p></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">d3_time_numberRe</span> <span class="o">=</span> <span class="sr">/\s*\d+/</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_time_parseAmPm</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">d3_time_amPmLookup</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">string</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">());</span>
  <span class="k">return</span> <span class="nx">n</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">p</span> <span class="o">=</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_amPmLookup</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">map</span><span class="p">({</span>
  <span class="nx">am</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">pm</span><span class="o">:</span> <span class="mi">1</span>
<span class="p">});</span></pre></div></td></tr>


<tr id="section-255"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-255">&#182;</a></div><p>TODO table of time zone offset names?</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_time_zone</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">z</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">(),</span>
      <span class="nx">zs</span> <span class="o">=</span> <span class="nx">z</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;-&quot;</span> <span class="o">:</span> <span class="s2">&quot;+&quot;</span><span class="p">,</span>
      <span class="nx">zh</span> <span class="o">=</span> <span class="o">~~</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="p">),</span>
      <span class="nx">zm</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="p">;</span>
  <span class="k">return</span> <span class="nx">zs</span> <span class="o">+</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">zh</span><span class="p">)</span> <span class="o">+</span> <span class="nx">d3_time_zfill2</span><span class="p">(</span><span class="nx">zm</span><span class="p">);</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">local</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>

  <span class="kd">function</span> <span class="nx">format</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nx">d3_time_utc</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">utc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">();</span>
      <span class="nx">utc</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">date</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">local</span><span class="p">(</span><span class="nx">utc</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">format</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nx">d3_time_utc</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">date</span> <span class="o">=</span> <span class="nx">local</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
      <span class="k">return</span> <span class="nx">date</span> <span class="o">&amp;&amp;</span> <span class="nx">date</span><span class="p">.</span><span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="nx">format</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="nx">local</span><span class="p">.</span><span class="nx">toString</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">d3_time_formatIso</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%dT%H:%M:%S.%LZ&quot;</span><span class="p">);</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">iso</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toISOString</span> <span class="o">?</span> <span class="nx">d3_time_formatIsoNative</span> <span class="o">:</span> <span class="nx">d3_time_formatIso</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">d3_time_formatIsoNative</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">();</span>
<span class="p">}</span>

<span class="nx">d3_time_formatIsoNative</span><span class="p">.</span><span class="nx">parse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3_time_formatIsoNative</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="nx">d3_time_formatIso</span><span class="p">.</span><span class="nx">toString</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="nx">local</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">number</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">round</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d0</span> <span class="o">=</span> <span class="nx">local</span><span class="p">(</span><span class="nx">date</span><span class="p">),</span> <span class="nx">d1</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">(</span><span class="nx">d0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">date</span> <span class="o">-</span> <span class="nx">d0</span> <span class="o">&lt;</span> <span class="nx">d1</span> <span class="o">-</span> <span class="nx">date</span> <span class="o">?</span> <span class="nx">d0</span> <span class="o">:</span> <span class="nx">d1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">ceil</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">local</span><span class="p">(</span><span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nx">date</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">offset</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step</span><span class="p">(</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="o">+</span><span class="nx">date</span><span class="p">),</span> <span class="nx">k</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">range</span><span class="p">(</span><span class="nx">t0</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">dt</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">ceil</span><span class="p">(</span><span class="nx">t0</span><span class="p">),</span> <span class="nx">times</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">dt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">time</span> <span class="o">&lt;</span> <span class="nx">t1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">number</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="o">%</span> <span class="nx">dt</span><span class="p">))</span> <span class="nx">times</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">+</span><span class="nx">time</span><span class="p">));</span>
        <span class="nx">step</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span><span class="nx">time</span> <span class="o">&lt;</span> <span class="nx">t1</span><span class="p">)</span> <span class="nx">times</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">+</span><span class="nx">time</span><span class="p">)),</span> <span class="nx">step</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">times</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">range_utc</span><span class="p">(</span><span class="nx">t0</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">dt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nx">d3_time_utc</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">utc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_time_utc</span><span class="p">();</span>
      <span class="nx">utc</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">t0</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">range</span><span class="p">(</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="nx">dt</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">local</span><span class="p">.</span><span class="nx">floor</span> <span class="o">=</span> <span class="nx">local</span><span class="p">;</span>
  <span class="nx">local</span><span class="p">.</span><span class="nx">round</span> <span class="o">=</span> <span class="nx">round</span><span class="p">;</span>
  <span class="nx">local</span><span class="p">.</span><span class="nx">ceil</span> <span class="o">=</span> <span class="nx">ceil</span><span class="p">;</span>
  <span class="nx">local</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">;</span>
  <span class="nx">local</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="nx">range</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">utc</span> <span class="o">=</span> <span class="nx">local</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3_time_interval_utc</span><span class="p">(</span><span class="nx">local</span><span class="p">);</span>
  <span class="nx">utc</span><span class="p">.</span><span class="nx">floor</span> <span class="o">=</span> <span class="nx">utc</span><span class="p">;</span>
  <span class="nx">utc</span><span class="p">.</span><span class="nx">round</span> <span class="o">=</span> <span class="nx">d3_time_interval_utc</span><span class="p">(</span><span class="nx">round</span><span class="p">);</span>
  <span class="nx">utc</span><span class="p">.</span><span class="nx">ceil</span> <span class="o">=</span> <span class="nx">d3_time_interval_utc</span><span class="p">(</span><span class="nx">ceil</span><span class="p">);</span>
  <span class="nx">utc</span><span class="p">.</span><span class="nx">offset</span> <span class="o">=</span> <span class="nx">d3_time_interval_utc</span><span class="p">(</span><span class="nx">offset</span><span class="p">);</span>
  <span class="nx">utc</span><span class="p">.</span><span class="nx">range</span> <span class="o">=</span> <span class="nx">range_utc</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">local</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_interval_utc</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nx">d3_time_utc</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">utc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">d3_time_utc</span><span class="p">();</span>
      <span class="nx">utc</span><span class="p">.</span><span class="nx">_</span> <span class="o">=</span> <span class="nx">date</span><span class="p">;</span>
      <span class="k">return</span> <span class="nx">method</span><span class="p">(</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">k</span><span class="p">).</span><span class="nx">_</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
      <span class="nx">d3_time</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">};</span>
<span class="p">}</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span> <span class="o">/</span> <span class="mi">1</span><span class="nx">e3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="nx">e3</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="nx">e3</span><span class="p">);</span> <span class="c1">// DST breaks setSeconds</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">seconds</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">seconds</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span> <span class="o">/</span> <span class="mi">6</span><span class="nx">e4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="nx">e4</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="nx">e4</span><span class="p">);</span> <span class="c1">// DST breaks setMinutes</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minutes</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minutes</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">timezone</span> <span class="o">=</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">/</span> <span class="mi">60</span><span class="p">;</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span> <span class="o">/</span> <span class="mi">36</span><span class="nx">e5</span> <span class="o">-</span> <span class="nx">timezone</span><span class="p">)</span> <span class="o">+</span> <span class="nx">timezone</span><span class="p">)</span> <span class="o">*</span> <span class="mi">36</span><span class="nx">e5</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setTime</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">36</span><span class="nx">e5</span><span class="p">);</span> <span class="c1">// DST breaks setHours</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getHours</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hours</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hours</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">());</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">days</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">days</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">dayOfYear</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">year</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">(</span><span class="nx">date</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">date</span> <span class="o">-</span> <span class="nx">year</span><span class="p">)</span> <span class="o">/</span> <span class="mi">864</span><span class="nx">e5</span> <span class="o">-</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">()</span> <span class="o">-</span> <span class="nx">year</span><span class="p">.</span><span class="nx">getTimezoneOffset</span><span class="p">())</span> <span class="o">/</span> <span class="mi">1440</span><span class="p">);</span>
<span class="p">};</span>
<span class="nx">d3_time_weekdays</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">day</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">day</span> <span class="o">=</span> <span class="nx">day</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
  <span class="nx">i</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="nx">i</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">[</span><span class="nx">day</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="nx">date</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">(</span><span class="nx">date</span><span class="p">)).</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">date</span><span class="p">;</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">date</span><span class="p">.</span><span class="nx">setDate</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">offset</span><span class="p">)</span> <span class="o">*</span> <span class="mi">7</span><span class="p">);</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">day</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">getDay</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">dayOfYear</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">day</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">day</span> <span class="o">!==</span> <span class="nx">i</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">[</span><span class="nx">day</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">interval</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
  <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">[</span><span class="nx">day</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">].</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">interval</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>

  <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">[</span><span class="nx">day</span> <span class="o">+</span> <span class="s2">&quot;OfYear&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">day</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">(</span><span class="nx">date</span><span class="p">).</span><span class="nx">getDay</span><span class="p">();</span>
    <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">dayOfYear</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">day</span> <span class="o">+</span> <span class="nx">i</span><span class="p">)</span> <span class="o">%</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">week</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">sunday</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">weeks</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">sunday</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">weeks</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">sunday</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">weekOfYear</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">sundayOfYear</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">(),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setMonth</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">()</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">months</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">months</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span> <span class="o">=</span> <span class="nx">d3_time_interval</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nx">d3_time</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">,</span> <span class="nx">offset</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">date</span><span class="p">.</span><span class="nx">setFullYear</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">()</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">date</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">years</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">years</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">.</span><span class="nx">utc</span><span class="p">.</span><span class="nx">range</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">d3_time_scale</span><span class="p">(</span><span class="nx">linear</span><span class="p">,</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">format</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">scale</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">linear</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">invert</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_time_scaleDate</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">invert</span><span class="p">(</span><span class="nx">x</span><span class="p">));</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleDate</span><span class="p">);</span>
    <span class="nx">linear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">nice</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="nx">d3_time_scaleExtent</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">());</span>
    <span class="k">return</span> <span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">m</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nx">m</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])]);</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">ticks</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">extent</span> <span class="o">=</span> <span class="nx">d3_time_scaleExtent</span><span class="p">(</span><span class="nx">scale</span><span class="p">.</span><span class="nx">domain</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">m</span> <span class="o">!==</span> <span class="s2">&quot;function&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">span</span> <span class="o">=</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
          <span class="nx">target</span> <span class="o">=</span> <span class="nx">span</span> <span class="o">/</span> <span class="nx">m</span><span class="p">,</span>
          <span class="nx">i</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">bisect</span><span class="p">(</span><span class="nx">d3_time_scaleSteps</span><span class="p">,</span> <span class="nx">target</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="nx">d3_time_scaleSteps</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">methods</span><span class="p">.</span><span class="nx">year</span><span class="p">(</span><span class="nx">extent</span><span class="p">,</span> <span class="nx">m</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">i</span><span class="p">)</span> <span class="k">return</span> <span class="nx">linear</span><span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="nx">m</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleDate</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">target</span> <span class="o">/</span> <span class="nx">d3_time_scaleSteps</span><span class="p">[</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">d3_time_scaleSteps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">/</span> <span class="nx">target</span><span class="p">))</span> <span class="o">--</span><span class="nx">i</span><span class="p">;</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">methods</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">k</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">m</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">range</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">m</span><span class="p">(</span><span class="nx">extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">+</span><span class="nx">extent</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">k</span><span class="p">);</span> <span class="c1">// inclusive upper bound</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">tickFormat</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">format</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">scale</span><span class="p">.</span><span class="nx">copy</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">d3_time_scale</span><span class="p">(</span><span class="nx">linear</span><span class="p">.</span><span class="nx">copy</span><span class="p">(),</span> <span class="nx">methods</span><span class="p">,</span> <span class="nx">format</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-256"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-256">&#182;</a></div><p>TOOD expose d3<em>scale</em>linear_rebind?</p></td><td class="code"><div class="highlight"><pre>  <span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">rebind</span><span class="p">(</span><span class="nx">scale</span><span class="p">,</span> <span class="nx">linear</span><span class="p">,</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="s2">&quot;rangeRound&quot;</span><span class="p">,</span> <span class="s2">&quot;interpolate&quot;</span><span class="p">,</span> <span class="s2">&quot;clamp&quot;</span><span class="p">);</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-257"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-257">&#182;</a></div><p>TODO expose d3_scaleExtent?</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">d3_time_scaleExtent</span><span class="p">(</span><span class="nx">domain</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">stop</span> <span class="o">=</span> <span class="nx">domain</span><span class="p">[</span><span class="nx">domain</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="k">return</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">stop</span> <span class="o">?</span> <span class="p">[</span><span class="nx">start</span><span class="p">,</span> <span class="nx">stop</span><span class="p">]</span> <span class="o">:</span> <span class="p">[</span><span class="nx">stop</span><span class="p">,</span> <span class="nx">start</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleDate</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleFormat</span><span class="p">(</span><span class="nx">formats</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">date</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">formats</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">formats</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">](</span><span class="nx">date</span><span class="p">))</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">formats</span><span class="p">[</span><span class="o">--</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="nx">date</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleSetYear</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">setFullYear</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span> <span class="c1">// Y2K fail</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleGetYear</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getFullYear</span><span class="p">(),</span>
      <span class="nx">d0</span> <span class="o">=</span> <span class="nx">d3_time_scaleSetYear</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span>
      <span class="nx">d1</span> <span class="o">=</span> <span class="nx">d3_time_scaleSetYear</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">d1</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleSteps</span> <span class="o">=</span> <span class="p">[</span>
  <span class="mi">1</span><span class="nx">e3</span><span class="p">,</span>    <span class="c1">// 1-second</span>
  <span class="mi">5</span><span class="nx">e3</span><span class="p">,</span>    <span class="c1">// 5-second</span>
  <span class="mi">15</span><span class="nx">e3</span><span class="p">,</span>   <span class="c1">// 15-second</span>
  <span class="mi">3</span><span class="nx">e4</span><span class="p">,</span>    <span class="c1">// 30-second</span>
  <span class="mi">6</span><span class="nx">e4</span><span class="p">,</span>    <span class="c1">// 1-minute</span>
  <span class="mi">3</span><span class="nx">e5</span><span class="p">,</span>    <span class="c1">// 5-minute</span>
  <span class="mi">9</span><span class="nx">e5</span><span class="p">,</span>    <span class="c1">// 15-minute</span>
  <span class="mi">18</span><span class="nx">e5</span><span class="p">,</span>   <span class="c1">// 30-minute</span>
  <span class="mi">36</span><span class="nx">e5</span><span class="p">,</span>   <span class="c1">// 1-hour</span>
  <span class="mi">108</span><span class="nx">e5</span><span class="p">,</span>  <span class="c1">// 3-hour</span>
  <span class="mi">216</span><span class="nx">e5</span><span class="p">,</span>  <span class="c1">// 6-hour</span>
  <span class="mi">432</span><span class="nx">e5</span><span class="p">,</span>  <span class="c1">// 12-hour</span>
  <span class="mi">864</span><span class="nx">e5</span><span class="p">,</span>  <span class="c1">// 1-day</span>
  <span class="mi">1728</span><span class="nx">e5</span><span class="p">,</span> <span class="c1">// 2-day</span>
  <span class="mi">6048</span><span class="nx">e5</span><span class="p">,</span> <span class="c1">// 1-week</span>
  <span class="mi">2592</span><span class="nx">e6</span><span class="p">,</span> <span class="c1">// 1-month</span>
  <span class="mi">7776</span><span class="nx">e6</span><span class="p">,</span> <span class="c1">// 3-month</span>
  <span class="mi">31536</span><span class="nx">e6</span> <span class="c1">// 1-year</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleLocalMethods</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">,</span> <span class="mi">15</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">minute</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">hour</span><span class="p">,</span> <span class="mi">12</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">day</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">week</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">month</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleLocalFormats</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%B&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getMonth</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%b %d&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%a %d&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getDay</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getDate</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%I %p&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getHours</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;%I:%M&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getMinutes</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;:%S&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="s2">&quot;.%L&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getMilliseconds</span><span class="p">();</span> <span class="p">}]</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleLinear</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span>
    <span class="nx">d3_time_scaleLocalFormat</span> <span class="o">=</span> <span class="nx">d3_time_scaleFormat</span><span class="p">(</span><span class="nx">d3_time_scaleLocalFormats</span><span class="p">);</span>

<span class="nx">d3_time_scaleLocalMethods</span><span class="p">.</span><span class="nx">year</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">extent</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_scaleLinear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">extent</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleGetYear</span><span class="p">)).</span><span class="nx">ticks</span><span class="p">(</span><span class="nx">m</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleSetYear</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_scale</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span> <span class="nx">d3_time_scaleLocalMethods</span><span class="p">,</span> <span class="nx">d3_time_scaleLocalFormat</span><span class="p">);</span>
<span class="p">};</span>
<span class="kd">var</span> <span class="nx">d3_time_scaleUTCMethods</span> <span class="o">=</span> <span class="nx">d3_time_scaleLocalMethods</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">[</span><span class="nx">m</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">utc</span><span class="p">,</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleUTCFormats</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%B&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%b %d&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%a %d&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCDay</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%I %p&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;%I:%M&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;:%S&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">();</span> <span class="p">}],</span>
  <span class="p">[</span><span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">format</span><span class="p">.</span><span class="nx">utc</span><span class="p">(</span><span class="s2">&quot;.%L&quot;</span><span class="p">),</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">();</span> <span class="p">}]</span>
<span class="p">];</span>

<span class="kd">var</span> <span class="nx">d3_time_scaleUTCFormat</span> <span class="o">=</span> <span class="nx">d3_time_scaleFormat</span><span class="p">(</span><span class="nx">d3_time_scaleUTCFormats</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleUTCSetYear</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
  <span class="nx">d</span><span class="p">.</span><span class="nx">setUTCFullYear</span><span class="p">(</span><span class="nx">y</span><span class="p">);</span> <span class="c1">// Y2K fail</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_time_scaleUTCGetYear</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">(),</span>
      <span class="nx">d0</span> <span class="o">=</span> <span class="nx">d3_time_scaleUTCSetYear</span><span class="p">(</span><span class="nx">y</span><span class="p">),</span>
      <span class="nx">d1</span> <span class="o">=</span> <span class="nx">d3_time_scaleUTCSetYear</span><span class="p">(</span><span class="nx">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">y</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">d1</span> <span class="o">-</span> <span class="nx">d0</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">d3_time_scaleUTCMethods</span><span class="p">.</span><span class="nx">year</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">extent</span><span class="p">,</span> <span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_scaleLinear</span><span class="p">.</span><span class="nx">domain</span><span class="p">(</span><span class="nx">extent</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleUTCGetYear</span><span class="p">)).</span><span class="nx">ticks</span><span class="p">(</span><span class="nx">m</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_time_scaleUTCSetYear</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">time</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">utc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d3_time_scale</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">(),</span> <span class="nx">d3_time_scaleUTCMethods</span><span class="p">,</span> <span class="nx">d3_time_scaleUTCFormat</span><span class="p">);</span>
<span class="p">};</span>
<span class="p">})();</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"zmaril/d3",depth:0}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="javascript/docco.min.js"></script>
</html>
