<!DOCTYPE html>
<html><head><title>zmaril/d3 » src › geom › quadtree.js

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>quadtree.js</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>Constructs a new quadtree for the specified array of points. A quadtree is a
two-dimensional recursive spatial subdivision. This implementation uses
square partitions, dividing each square into four equally-sized squares. Each
point exists in a unique node; if multiple points are in the same position,
some points may be stored on internal nodes rather than leaf nodes. Quadtrees
can be used to accelerate various spatial operations, such as the Barnes-Hut
approximation for computing n-body forces, or collision detection.</p></td><td class="code"><div class="highlight"><pre><span class="nx">d3</span><span class="p">.</span><span class="nx">geom</span><span class="p">.</span><span class="nx">quadtree</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">points</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">p</span><span class="p">,</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
      <span class="nx">n</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Type conversion for deprecated API.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">n</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">points</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">x</span><span class="p">))</span> <span class="nx">points</span> <span class="o">=</span> <span class="nx">points</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">d3_geom_quadtreePoint</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Allow bounds to be specified explicitly.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">y2</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="nx">y1</span> <span class="o">=</span> <span class="nx">x1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">x1</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>
      <span class="nx">x2</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Compute bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">points</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">x1</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span> <span class="nx">y1</span><span class="p">)</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;</span> <span class="nx">x2</span><span class="p">)</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="nx">y2</span><span class="p">)</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Squarify the bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">x2</span> <span class="o">-</span> <span class="nx">x1</span><span class="p">,</span>
          <span class="nx">dy</span> <span class="o">=</span> <span class="nx">y2</span> <span class="o">-</span> <span class="nx">y1</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">dx</span> <span class="o">&gt;</span> <span class="nx">dy</span><span class="p">)</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">y1</span> <span class="o">+</span> <span class="nx">dx</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">x1</span> <span class="o">+</span> <span class="nx">dy</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Recursively inserts the specified point p at the node n or one of its
descendants. The bounds are defined by [x1, x2] and [y1, y2].</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">insert</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">||</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span> <span class="c1">// ignore invalid points</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">leaf</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">v</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">point</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>If the point at this leaf node is at the same position as the new
point we are adding, we leave the point associated with the
internal node while adding the new point to a child node. This
avoids infinite recursion.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">v</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="p">.</span><span class="mi">01</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">n</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
          <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">n</span><span class="p">.</span><span class="nx">point</span> <span class="o">=</span> <span class="nx">p</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Recursively inserts the specified point p into a descendant of node n. The
bounds are defined by [x1, x2] and [y1, y2].</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">insertChild</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Compute the split point, and the quadrant in which to insert p.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">sx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">sy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">+</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">right</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">x</span> <span class="o">&gt;=</span> <span class="nx">sx</span><span class="p">,</span>
        <span class="nx">bottom</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;=</span> <span class="nx">sy</span><span class="p">,</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bottom</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nx">right</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Recursively insert into the child node.</p></td><td class="code"><div class="highlight"><pre>    <span class="nx">n</span><span class="p">.</span><span class="nx">leaf</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">n</span> <span class="o">=</span> <span class="nx">n</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">||</span> <span class="p">(</span><span class="nx">n</span><span class="p">.</span><span class="nx">nodes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">());</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Update the bounds as we recurse.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">right</span><span class="p">)</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">sx</span><span class="p">;</span> <span class="k">else</span> <span class="nx">x2</span> <span class="o">=</span> <span class="nx">sx</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">bottom</span><span class="p">)</span> <span class="nx">y1</span> <span class="o">=</span> <span class="nx">sy</span><span class="p">;</span> <span class="k">else</span> <span class="nx">y2</span> <span class="o">=</span> <span class="nx">sy</span><span class="p">;</span>
    <span class="nx">insert</span><span class="p">(</span><span class="nx">n</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Create the root node.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">root</span> <span class="o">=</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">();</span>

  <span class="nx">root</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">insert</span><span class="p">(</span><span class="nx">root</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">root</span><span class="p">.</span><span class="nx">visit</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">};</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Insert all points.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">points</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">root</span><span class="p">.</span><span class="nx">add</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">root</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreeNode</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">leaf</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">nodes</span><span class="o">:</span> <span class="p">[],</span>
    <span class="nx">point</span><span class="o">:</span> <span class="kc">null</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">f</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">))</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">sx</span> <span class="o">=</span> <span class="p">(</span><span class="nx">x1</span> <span class="o">+</span> <span class="nx">x2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">sy</span> <span class="o">=</span> <span class="p">(</span><span class="nx">y1</span> <span class="o">+</span> <span class="nx">y2</span><span class="p">)</span> <span class="o">*</span> <span class="p">.</span><span class="mi">5</span><span class="p">,</span>
        <span class="nx">children</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">nodes</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">sy</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">children</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="nx">d3_geom_quadtreeVisit</span><span class="p">(</span><span class="nx">f</span><span class="p">,</span> <span class="nx">children</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">sx</span><span class="p">,</span> <span class="nx">sy</span><span class="p">,</span> <span class="nx">x2</span><span class="p">,</span> <span class="nx">y2</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">d3_geom_quadtreePoint</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="nx">x</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">y</span><span class="o">:</span> <span class="nx">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
  <span class="p">};</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"zmaril/d3",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
