<!DOCTYPE html>
<html><head><title>zmaril/d3 » examples › horizon › horizon.js

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>horizon.js</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">width</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span>
    <span class="nx">height</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">chart</span> <span class="o">=</span> <span class="nx">horizonChart</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">width</span><span class="p">(</span><span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">height</span><span class="p">(</span><span class="nx">height</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">bands</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">mode</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="s2">&quot;basis&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">svg</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;#chart&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

<span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="s2">&quot;unemployment.json&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Offset so that positive is above-average and negative is below-average.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">mean</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">rate</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">v</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">p</span> <span class="o">+</span> <span class="nx">v</span><span class="p">;</span> <span class="p">},</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">rate</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Transpose column values to rows.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">rate</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">rate</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">Date</span><span class="p">.</span><span class="nx">UTC</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">year</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">data</span><span class="p">.</span><span class="nx">month</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nx">rate</span> <span class="o">-</span> <span class="nx">mean</span><span class="p">];</span>
  <span class="p">});</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Render the chart.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">svg</span><span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="nx">data</span><span class="p">]).</span><span class="nx">call</span><span class="p">(</span><span class="nx">chart</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Enable mode buttons.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;#mode button&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="s2">&quot;mirror&quot;</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">svg</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">chart</span><span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">mode</span><span class="p">(</span><span class="nx">m</span><span class="p">));</span>
        <span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;#mode button&quot;</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">classed</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span> <span class="o">==</span> <span class="nx">m</span><span class="p">;</span> <span class="p">});</span>
      <span class="p">});</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Enable bands buttons.</p></td><td class="code"><div class="highlight"><pre>  <span class="nx">d3</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;#bands button&quot;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">bands</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">svg</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">chart</span><span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="mi">1000</span><span class="p">).</span><span class="nx">bands</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">chart</span><span class="p">.</span><span class="nx">bands</span><span class="p">()</span> <span class="o">+</span> <span class="nx">db</span><span class="p">)));</span>
      <span class="p">});</span>
<span class="p">});</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Implements a horizon layout, which is a variation of a single-series
area chart where the area is folded into multiple bands. Color is used to
encode band, allowing the size of the chart to be reduced significantly
without impeding readability. This layout algorithm is based on the work of
J. Heer, N. Kong and M. Agrawala in "Sizing the Horizon: The Effects of Chart
Size and Layering on the Graphical Perception of Time Series Visualizations",
CHI 2009. http://hci.stanford.edu/publications/2009/heer-horizon-chi09.pdf</p></td><td class="code"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">horizonChart</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">bands</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// between 1 and 5, typically</span>
      <span class="nx">mode</span> <span class="o">=</span> <span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="c1">// or mirror</span>
      <span class="nx">interpolate</span> <span class="o">=</span> <span class="s2">&quot;linear&quot;</span><span class="p">,</span> <span class="c1">// or basis, monotone, step-before, etc.</span>
      <span class="nx">x</span> <span class="o">=</span> <span class="nx">horizonX</span><span class="p">,</span>
      <span class="nx">y</span> <span class="o">=</span> <span class="nx">horizonY</span><span class="p">,</span>
      <span class="nx">width</span> <span class="o">=</span> <span class="mi">960</span><span class="p">,</span>
      <span class="nx">height</span> <span class="o">=</span> <span class="mi">40</span><span class="p">,</span>
      <span class="nx">nextId</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">area</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">svg</span><span class="p">.</span><span class="nx">area</span><span class="p">(),</span>
      <span class="nx">duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">color</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="s2">&quot;#d62728&quot;</span><span class="p">,</span> <span class="s2">&quot;#fff&quot;</span><span class="p">,</span> <span class="s2">&quot;#1f77b4&quot;</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>For each small multiple…</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">function</span> <span class="nx">horizon</span><span class="p">(</span><span class="nx">g</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">g</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="k">this</span><span class="p">),</span>
          <span class="nx">n</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="nx">bands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">xMin</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">,</span>
          <span class="nx">xMax</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span>
          <span class="nx">yMax</span> <span class="o">=</span> <span class="o">-</span><span class="kc">Infinity</span><span class="p">,</span>
          <span class="nx">x0</span><span class="p">,</span> <span class="c1">// old x-scale</span>
          <span class="nx">y0</span><span class="p">,</span> <span class="c1">// old y-scale</span>
          <span class="nx">id</span><span class="p">;</span> <span class="c1">// unique id for paths</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Compute x- and y-values along with extents.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">xv</span> <span class="o">=</span> <span class="nx">x</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">),</span>
            <span class="nx">yv</span> <span class="o">=</span> <span class="nx">y</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xv</span> <span class="o">&lt;</span> <span class="nx">xMin</span><span class="p">)</span> <span class="nx">xMin</span> <span class="o">=</span> <span class="nx">xv</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">xv</span> <span class="o">&gt;</span> <span class="nx">xMax</span><span class="p">)</span> <span class="nx">xMax</span> <span class="o">=</span> <span class="nx">xv</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="nx">yv</span> <span class="o">&gt;</span> <span class="nx">yMax</span><span class="p">)</span> <span class="nx">yMax</span> <span class="o">=</span> <span class="o">-</span><span class="nx">yv</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">yv</span> <span class="o">&gt;</span> <span class="nx">yMax</span><span class="p">)</span> <span class="nx">yMax</span> <span class="o">=</span> <span class="nx">yv</span><span class="p">;</span>
        <span class="k">return</span> <span class="p">[</span><span class="nx">xv</span><span class="p">,</span> <span class="nx">yv</span><span class="p">];</span>
      <span class="p">});</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Compute the new x- and y-scales.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">x1</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="nx">xMin</span><span class="p">,</span> <span class="nx">xMax</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">width</span><span class="p">]),</span>
          <span class="nx">y1</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">yMax</span><span class="p">]).</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">bands</span><span class="p">]);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Retrieve the old scales, if this is an update.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">x0</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">x0</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">]).</span><span class="nx">range</span><span class="p">(</span><span class="nx">x1</span><span class="p">.</span><span class="nx">range</span><span class="p">());</span>
        <span class="nx">y0</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">().</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="kc">Infinity</span><span class="p">]).</span><span class="nx">range</span><span class="p">(</span><span class="nx">y1</span><span class="p">.</span><span class="nx">range</span><span class="p">());</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="o">++</span><span class="nx">nextId</span><span class="p">;</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>We'll use a defs to store the area path and the clip path.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">defs</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;defs&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="nx">data</span><span class="p">]);</span>

      <span class="kd">var</span> <span class="nx">defsEnter</span> <span class="o">=</span> <span class="nx">defs</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:defs&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>The clip path is a simple rect.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">defsEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:clipPath&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;horizon_clip&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:rect&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>

      <span class="nx">defs</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;rect&quot;</span><span class="p">).</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">width</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>The area path is rendered with our resuable d3.svg.area.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">defsEnter</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:path&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;horizon_path&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nx">area</span>
          <span class="p">.</span><span class="nx">interpolate</span><span class="p">(</span><span class="nx">interpolate</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x0</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">y0</span><span class="p">(</span><span class="nx">height</span> <span class="o">*</span> <span class="nx">bands</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">y1</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">bands</span> <span class="o">-</span> <span class="nx">y0</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}))</span>
        <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nx">area</span>
          <span class="p">.</span><span class="nx">x</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x1</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">y1</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">height</span> <span class="o">*</span> <span class="nx">bands</span> <span class="o">-</span> <span class="nx">y1</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="p">}));</span>

      <span class="nx">defs</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">).</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="nx">area</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>We'll use a container to clip all horizon layers at once.</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">g</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">data</span><span class="p">([</span><span class="kc">null</span><span class="p">])</span>
        <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:g&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;clip-path&quot;</span><span class="p">,</span> <span class="s2">&quot;url(#horizon_clip&quot;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Define the transform function based on the mode.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">transform</span> <span class="o">=</span> <span class="nx">mode</span> <span class="o">==</span> <span class="s2">&quot;offset&quot;</span>
          <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="nx">bands</span><span class="p">)</span> <span class="o">*</span> <span class="nx">height</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span> <span class="p">}</span>
          <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;scale(1,-1)&quot;</span> <span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;translate(0,&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">-</span> <span class="nx">bands</span><span class="p">)</span> <span class="o">*</span> <span class="nx">height</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span> <span class="p">};</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Instantiate each copy of the path with different transforms.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">).</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;use&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="nx">bands</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">concat</span><span class="p">(</span><span class="nx">d3</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nx">bands</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="nb">Number</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>TODO don't fudge the enter transition</p></td><td class="code"><div class="highlight"><pre>      <span class="nx">u</span><span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:use&quot;</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;xlink:href&quot;</span><span class="p">,</span> <span class="s2">&quot;#horizon_path&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">transform</span><span class="p">(</span><span class="nx">d</span> <span class="o">+</span> <span class="p">(</span><span class="nx">d</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">));</span> <span class="p">})</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="nx">color</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="nx">transform</span><span class="p">);</span>

      <span class="nx">u</span><span class="p">.</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="nx">transform</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="nx">color</span><span class="p">);</span>

      <span class="nx">u</span><span class="p">.</span><span class="nx">exit</span><span class="p">().</span><span class="nx">transition</span><span class="p">()</span>
          <span class="p">.</span><span class="nx">duration</span><span class="p">(</span><span class="nx">duration</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="nx">transform</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">remove</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Stash the new scales.</p></td><td class="code"><div class="highlight"><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">__chart__</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">x1</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">y1</span><span class="p">,</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">id</span><span class="p">};</span>
    <span class="p">});</span>
    <span class="nx">d3</span><span class="p">.</span><span class="nx">timer</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">duration</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">duration</span><span class="p">;</span>
    <span class="nx">duration</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">bands</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">bands</span><span class="p">;</span>
    <span class="nx">bands</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="nx">color</span><span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="o">-</span><span class="nx">bands</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">bands</span><span class="p">]);</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">mode</span><span class="p">;</span>
    <span class="nx">mode</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">colors</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">color</span><span class="p">.</span><span class="nx">range</span><span class="p">();</span>
    <span class="nx">color</span><span class="p">.</span><span class="nx">range</span><span class="p">(</span><span class="nx">x</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">interpolate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">interpolate</span><span class="p">;</span>
    <span class="nx">interpolate</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
    <span class="nx">x</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">z</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
    <span class="nx">y</span> <span class="o">=</span> <span class="nx">z</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">width</span><span class="p">;</span>
    <span class="nx">width</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nx">horizon</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">return</span> <span class="nx">height</span><span class="p">;</span>
    <span class="nx">height</span> <span class="o">=</span> <span class="o">+</span><span class="nx">x</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">horizon</span><span class="p">;</span>
<span class="p">};</span>

<span class="kd">function</span> <span class="nx">horizonX</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">horizonY</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">d</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"zmaril/d3",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
